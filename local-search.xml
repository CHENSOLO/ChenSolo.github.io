<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Linux知识要点记录</title>
    <link href="/2022/08/31/Linux/studyLinux/"/>
    <url>/2022/08/31/Linux/studyLinux/</url>
    
    <content type="html"><![CDATA[<h2 id="Linux知识记录"><a href="#Linux知识记录" class="headerlink" title="Linux知识记录 "></a>Linux知识记录 </h2><p><code>用于参考</code></p><h2 id="一、iptables"><a href="#一、iptables" class="headerlink" title="一、iptables"></a>一、iptables</h2><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Filter表：过滤数据包<br>NAT表：用于网络地址转换(IP、端口)<br>Mangle表：修改数据包的服务类型、TTL、并且可以配置路由实现QOS<br>Raw表：决定数据包是否被状态跟踪机制处理<br><br><span class="hljs-literal">INPUT</span>链——进来的数据包应用此规则链中的规则<br><span class="hljs-literal">OUTPUT</span>链——外出的数据包应用此规则链中的规则<br>FORWARD链——转发数据包时应用此规则链中的规则<br>PREROUTING链——对数据包作路由选择前应用此链中的规则<br>POSTROUTING链——对数据包作路由选择后应用此链中的规则<br><br></code></pre></td></tr></table></figure><p><img src="/img/Linux/sibiaowulian.png"><br><strong>查看类</strong></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-L：list, 列出指定鏈上的所有规则，本选项须置后</span><br><span class="hljs-deletion">-n：numberic，以数字格式显示地址和端口号</span><br><span class="hljs-deletion">-v：verbose，详细信息</span><br><span class="hljs-deletion">-vv 更详细</span><br><span class="hljs-deletion">-x：exactly，显示计数器结果的精确值,而非单位转换后的易读值</span><br><span class="hljs-deletion">--line-numbers：显示规则的序号</span><br><span class="hljs-deletion">-S selected,以iptables-save 命令格式显示链上规则</span><br><br></code></pre></td></tr></table></figure><p><strong>规则类</strong></p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-A：append，追加</span><br><span class="hljs-deletion">-I：insert, 插入，要指明插入至的规则编号，默认为第一条</span><br><span class="hljs-deletion">-D：delete，删除</span><br>(1) 指明规则序号<br>(2) 指明规则本身<br><span class="hljs-deletion">-R：replace，替换指定链上的指定规则编号</span><br><span class="hljs-deletion">-F：flush，清空指定的规则链</span><br><span class="hljs-deletion">-Z：zero，置零</span><br>iptables的每条规则都有两个计数器<br>(1) 匹配到的报文的个数<br>(2) 匹配到的所有报文的大小之和<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs Bash">//查看状态服务<br>systemctl status iptables.service<br>//查看已有的规则<br>[root@localhost ~]<span class="hljs-comment"># iptables -nvL --line-numbers</span><br>//拒绝某个ip请求<br>[root@localhost ~]<span class="hljs-comment"># iptables -A INPUT -s 192.168.3.100,192.168.10.5 -j REJECT</span><br>//允许某个请求<br>[root@localhost ~]<span class="hljs-comment"># iptables -A INPUT -s 10.0.0.200 -j ACCEPT</span><br>//插入规则 并更改顺序通过-I<br>[root@localhost ~]<span class="hljs-comment"># iptables -I INPUT 1 -s 192.168.3.100 -j ACCEPT</span><br>//删除某条规则<br>[root@localhost ~]<span class="hljs-comment"># iptables -D INPUT 2</span><br>//替换某条顺序规则   -R是替换  DROP是丢弃<br>[root@localhost ~]<span class="hljs-comment"># iptables -R INPUT 2 -s 192.168.0.0/24 -j DROP</span><br>//删除全部规则<br>[root@localhost ~]<span class="hljs-comment"># iptables -F</span><br>//-s表示源地址 -d表示目标地址   -d通常用于两个网卡，使某个服务访问不了另外个网卡<br>[root@localhost ~]<span class="hljs-comment"># iptables -A INPUT -s 192.168.142.156 -d 192.168.142.154 -j REJECT</span><br>From 192.168.142.154 icmp_seq=1 Destination Port Unreachable<br>//禁止某个源ip ping  -p是指定某个协议<br>[root@localhost ~]<span class="hljs-comment"># iptables -A INPUT -s 192.168.142.156 -p icmp -j REJECT</span><br>//拒绝某个ip访问本机的某个服务  --dport指的是端口<br>[root@localhost html]<span class="hljs-comment"># iptables -A INPUT -s 192.168.142.156 -p tcp --dport 80 -j REJECT</span><br>//-m 扩展模块可以使拒绝多个端口只在一条规则里头<br>[root@localhost html]<span class="hljs-comment"># iptables -A INPUT -s 192.168.142.156 -p tcp -m multiport --dports 80,443 -j REJECT</span><br>//iprange可以设置ip范围<br>[root@localhost html]<span class="hljs-comment"># iptables -A INPUT -d 192.168.142.154 -p tcp --dport 80 -m iprange --src-range 192.168.142.160-192.168.142.170 -j DROP</span><br>//拒绝某个网卡的mac地址<br>[root@localhost html]<span class="hljs-comment"># iptables -A INPUT -m mac --mac-source 00:0c:29:1e:b6:8e -j REJECT</span><br>//拒绝某个ip对有关youtube的网址访问 string扩展是对报文中的应用层数据做字符串模式匹配检测<br>[root@localhost ~]<span class="hljs-comment"># iptables -A OUTPUT -d 192.168.142.156 -p tcp --sport 80 -m string --algo bm --from 62 --string &quot;youtube&quot; -j REJECT</span><br>//超过规定的次数访问拒绝该请求 connlimit(根据每客户端ip做并发连接数量匹配 可防止dos攻击)<br>[root@localhost ~]<span class="hljs-comment"># iptables -A INPUT -m connlimit --connlimit-above 20 -j REJECT</span><br>//查询已追踪的链路记录<br>[root@localhost ~]<span class="hljs-comment"># cat /proc/net/nf_conntrack</span><br>//nf_conntrack_max值越小,链接记录数超过规定的阈值就导致用户无法访问<br>[root@localhost ~]<span class="hljs-comment"># cat /proc/sys/net/netfilter/nf_conntrack_max</span><br>100000<br><br>1.自定义链<br>[root@localhost ~]<span class="hljs-comment"># iptables -N web_chain</span><br>2.修改链<br>[root@localhost ~]<span class="hljs-comment"># iptables -E web_chain WEB_CHAIN</span><br>3.创建两条规则归属到自己创建的链<br>[root@localhost ~]<span class="hljs-comment"># iptables -A WEB_CHAIN -s 192.168.142.156 -p tcp --dport 80 -j REJECT</span><br>[root@localhost ~]<span class="hljs-comment"># iptables -A WEB_CHAIN -s 192.168.142.156 -p tcp --dport 8080 -j REJECT</span><br>4.将INPUT调用自定义链<br>[root@localhost ~]<span class="hljs-comment"># iptables -A INPUT -j WEB_CHAIN</span><br>5.创建一条规则禁止访问数据库<br>[root@localhost ~]<span class="hljs-comment"># iptables -A DB_CHAIN -s 192.168.142.156 -p tcp --dport 3306 -j REJECT</span><br>6.显示有那些防火墙规则<br>[root@localhost ~]<span class="hljs-comment"># iptablels-save</span><br>7.将防火墙规则保存下来<br>[root@localhost ~]<span class="hljs-comment"># iptables-save &gt; /data/iptables.rules</span><br>8.将防火墙备份的规则恢复<br>[root@localhost ~]<span class="hljs-comment"># iptables-restore &lt; /data/iptables.rules</span><br>9.清除自定义链的规则，如果规则被其他链使用也需要清除，否则无法删除自定义链名称<br>[root@localhost ~]<span class="hljs-comment"># iptables -F WEB_CHAIN</span><br>[root@localhost ~]<span class="hljs-comment"># iptables -D INPUT 1</span><br>10.清除自定义链名称<br>[root@localhost ~]<span class="hljs-comment"># iptables -X WEB_CHAIN</span><br>11.设置开启自动恢复规则<br>[root@localhost ~]<span class="hljs-comment"># cat /etc/rc.local</span><br>iptables-restore &lt; /data/iptables.rules<br>[root@localhost ~]<span class="hljs-comment"># chmod +x /etc/rc.local</span><br>12.可以将设置的规则覆盖到iptables.service的服务里头/etc/sysconfig/iptables前提需要安装iptables.service服务并设置开机自启动<br>[root@localhost ~]<span class="hljs-comment"># cp /data/iptables.rules  /etc/sysconfig/iptables</span><br>[root@localhost ~]<span class="hljs-comment"># systemctl restart iptables.service</span><br>13.开启ip_forward<br>[root@localhost ~]<span class="hljs-comment"># vim /etc/sysctl.conf</span><br>net.ipv4.ip_forward = 1<br>14.修改完以后需要执行sysctl -p 才能生效<br>[root@localhost ~]<span class="hljs-comment"># sysctl -p</span><br><br><br>15.通过标准模块实现内网访问外网，反之禁止(FORWARD链实现内外网络流量控制)<br>iptables -A FORWARD -m state --state ESTABLISHED -j ACCEPT  <span class="hljs-comment"># 已建立连接的可以正常访问</span><br>iptables -A FORWARD -s 192.168.142.0/24 ! -d 192.168.142.0/24 -m state --state NEW -j ACCEPT <span class="hljs-comment">#允许源地址访问目标地址，反之禁止</span><br>iptables -A FORWARD -j RECECT <span class="hljs-comment">#拒绝其他全部ip</span><br><br></code></pre></td></tr></table></figure><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">NAT</span>表： network address translation, 支持PREROUTING, INPUT, OUTPUT, POSTROUTING四个链<br>请求报文： 修改源/目标<span class="hljs-built_in">IP</span> 由定义如何修改<br>响应报文： 修改源/目标<span class="hljs-built_in">IP</span> 根据跟踪机制自动实现 <br><span class="hljs-symbol">NAT</span>的实现分为下面类型:<br><span class="hljs-symbol">SNAT:</span> source NAT, 支持POSTROUTING,INPUT,让本地网络中的主机通过某一特定地址访问外部网络,实现地址伪装,请求报文：修改源<span class="hljs-built_in">IP</span><br><span class="hljs-symbol">DNAT:</span> destination NAT支持PREROUTING,OUTPUT,把本地网络中的主机上的某个服务开放给外部网络访问(发布服务和端口映射),但隐藏真实<span class="hljs-built_in">IP</span>，请求报文是修改目标<span class="hljs-built_in">IP</span><br><span class="hljs-symbol">PNAT:</span> port nat，端口和<span class="hljs-built_in">IP</span>都进行修改<br></code></pre></td></tr></table></figure><ul><li><p><strong>测试网络段</strong></p><ul><li><strong>外部IP: 10.0.0.9(eth0仅主机)</strong></li><li><strong>防火墙: 10.0.0.8(ehh0仅主机) 192.168.142.154&#x2F;24(eth1 NAT)</strong></li><li><strong>内部IP: 192.168.142.156&#x2F;24(eth1 NAT) 192.168.142.154(GW)</strong></li></ul></li><li><p><strong>SNAT示例</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta">#此时内部IP是ping不通外部IP的,</span><br>[root<span class="hljs-symbol">@inside</span> ~]<span class="hljs-meta"># ping 10.0.0.9</span><br><span class="hljs-built_in">PING</span> <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.9</span> (<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.9</span>) <span class="hljs-number">56</span>(<span class="hljs-number">84</span>) bytes of data.<br><span class="hljs-meta"># 1.在防火墙上启用路由转发</span><br>[root<span class="hljs-symbol">@firewalld</span> ~]<span class="hljs-meta"># grep ip_forward /etc/sysctl.conf</span><br>net.ipv4.ip_forward = <span class="hljs-number">1</span><br><span class="hljs-meta"># 2.在防火墙添加一条命令,使用POSTROUTING做转发 -s表示内网地址网络段 --to-source表示用防火墙的ip去访问外部地址</span><br>[root<span class="hljs-symbol">@firewalld</span> ~]<span class="hljs-meta"># iptables -t nat -A POSTROUTING -s 192.168.142.0/24  -j SNAT --to-source 10.0.0.8 #适用于静态ip</span><br>[root<span class="hljs-symbol">@firewalld</span> ~]<span class="hljs-meta"># iptables -t nat -A POSTROUTING -s 192.168.142.0/24 -j MASQUERADE #适用于动态ip地址</span><br><span class="hljs-meta"># 3.查看POSTROUTING的规则</span><br>[root<span class="hljs-symbol">@firewalld</span> ~]<span class="hljs-meta"># iptables -nvL -t nat</span><br><span class="hljs-meta"># 4.删除NAT规则</span><br>[root<span class="hljs-symbol">@firewalld</span> ~]<span class="hljs-meta"># iptables -F -t nat</span><br><span class="hljs-meta"># 5.可以在客户端抓包查看</span><br>tcpdump -i ens33 -nn icmp<br></code></pre></td></tr></table></figure><p><img src="/img/Linux/ROUTING.png"></p></li><li><p><strong>DNAT示例</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta">#将内部主机端口转发到防火墙端口上进行放开</span><br>[root<span class="hljs-symbol">@firewalld</span> ~]<span class="hljs-meta"># iptables -t nat -A PREROUTING -d 10.0.0.8 -p tcp --dport 80 -j DNAT --to-destination 192.168.142.156:80</span><br>[root<span class="hljs-symbol">@firewalld</span> ~]<span class="hljs-meta"># iptables  -t nat -nvL PREROUTING</span><br>Chain PREROUTING (policy ACCEPT <span class="hljs-number">2</span> packets, <span class="hljs-number">152</span> bytes)<br> pkts bytes target     prot opt <span class="hljs-keyword">in</span>     out     source               destination<br>    <span class="hljs-number">7</span>   <span class="hljs-number">420</span> DNAT       tcp  --  *      *       <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>/<span class="hljs-number">0</span>            <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span>             tcp dpt:<span class="hljs-number">80</span> <span class="hljs-keyword">to</span>:<span class="hljs-number">192.168</span><span class="hljs-number">.142</span><span class="hljs-number">.156</span>:<span class="hljs-number">80</span><br><span class="hljs-meta">#查看日志</span><br>tail /var/<span class="hljs-built_in">log</span>/httpd/access_log<br></code></pre></td></tr></table></figure><p><img src="/img/Linux/DNAT.png"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux基础知识</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Zabbix概念系统（一）</title>
    <link href="/2022/08/31/zabbix/Zabbix%E6%A6%82%E5%BF%B5%E7%B3%BB%E7%BB%9F(%E4%B8%80)/"/>
    <url>/2022/08/31/zabbix/Zabbix%E6%A6%82%E5%BF%B5%E7%B3%BB%E7%BB%9F(%E4%B8%80)/</url>
    
    <content type="html"><![CDATA[<h2 id="一、zabbix研究的内容"><a href="#一、zabbix研究的内容" class="headerlink" title="一、zabbix研究的内容"></a>一、zabbix研究的内容</h2><p>1.zabbix是一个基于web界面的提供分布式系统监控以及网络监控功能的企业级开源解决方案。zabbix能监<br>控各种网络参数，保证服务器系统的安全运行，并且能够提供灵活的通知报警机制让系统管理员能快速的发现<br>问题，定位问题，解决问题</p><p>2.zabbix除了支持主动模式之外还支持被动模式。所谓的主动还是被动针对的是agent，agent向zabbix的<br>server发送数据，就表示是主动模式，agent被动的等待server来提取数据，就是被动模式</p><p>3.zabbix支持分布式的架构，可以采用zabbix proxy的方式来实现监控平台的轻松扩容，可以简单的实现<br>多数据中心多云平台监控。你想要扩容，搭建zabbix proxy即可</p><p>4.zabbix支持多种报警，短信（SMS），邮件，语音，微软的team，企业微信，钉钉</p><p>5.zabbix是免费的。是开源的，是对公众可以任意使用的。虽然zabbix是开源的免费的，但是如果运维人员<br>的水平不够可能也没办法发挥zabbix的全部功能，一般对于开源监控平台来说，如果想玩到高级的程度，必<br>须要具备开发的知识。这个知识针对中小型的公司，需要运维人员对监控平台进行维护和问题发现以及问题处<br>理，对开发人员要求动态实时的定制需要监控的内容。所以说商机就来了，有很多公司提供zabbix的技术支<br>持，zabbix社区就是这些众多提供商业支持的最大的一家公司</p><h2 id="二、zabbix的架构"><a href="#二、zabbix的架构" class="headerlink" title="二、zabbix的架构"></a>二、zabbix的架构</h2><p><img src="/img/zabbix/zabbix_1.jpg"></p><h2 id="三、zabbix的组件"><a href="#三、zabbix的组件" class="headerlink" title="三、zabbix的组件"></a>三、zabbix的组件</h2><ul><li><p>zabbix agent：部署在被监控主机上，负责收集本地数据并发往server端或proxy端</p></li><li><p>zabbix server:通过收集agent发送的数据，写入数据库（MySQL，ORACLE），在通过php+apache&#x2F;nginx在web前端展</p></li><li><p>zabbix database：专用于存储所有配置信息，以及由zabbix收集的数据</p></li><li><p>zabbix web：zabbix的GUI接口，通常与server运行在同一台主机上</p></li><li><p>zabbix proxy：选组件，常用于分布式监控环境中，代理server收集部分被监控端的监控数据并同意发往server端</p></li></ul><p>Zabbix的监控流程可以简单描述为:<br><strong>数据采集–&gt;数据存储–&gt;数据分析–&gt;数据展示–&gt;监控报警</strong><br>其中：<br>数据采集：Zabbix通过SNMP、Agent、ICMP、SSH、IPMI等进行数据采集<br>数据存储：Zabbix存储在MySQL上，也可以存储在其他数据库<br>数据展示：web界面展示、(移动APP、java_php开发一个web界面也可以)<br>数据报警：邮件报警、微信报警、短信报警、报警升级机制</p><p><strong>Zabbix的监控配置流程可以简单描述为：</strong><br>告警是由一系列的流程组成，首先是触发器达到阀值，产生一个事件，接下来由Action对事件信息进行处理，其中包括两部分：<br>第一部分是发送消息，即将告警信息发送给用户。<br>第二部分是执行命令，即将事件用命令进行处理，达到对事件故障自动尝试恢复的效果。</p><p>Host groups（主机组）–&gt;Hosts（主机）–&gt;template(模板)–&gt;Applications（监控项组）–&gt;Items（监控项）–&gt;graph(图形) –&gt;screen (图形分组)–&gt;Triggers（触发器）–&gt;Event（事件）–&gt;Actions（处理动作）–&gt;Media types(告警升级|1.执行远程命令2.发送告警邮件)–&gt;User groups（用户组）–&gt;Users（用户）–&gt;Medias(告警邮件)</p><p><strong>zabbix监控环境中基本概念</strong></p><ul><li><p>主机（host）：主要监控的网络设备，可由IP或DNS名称指定；</p></li><li><p>主机组（host group）：主机的逻辑容器，可以包含主机和模板，但同一个组织内的主机和模板不能互相链接；主机组通常在给用户或用户组指派监控权限时使用</p></li><li><p>监控项（item）：一个特定监控指标的相关的数据；这些数据来自于被监控对象；item是zabbix进程数据收集的核心，相对某个监控对象，每个item都由“key”标识</p></li><li><p>触发器（trigger）：一个表达式，用于评估某监控对象的特定item内接收的数据是否在合理范围内，也就是阈值；接收的数据量大于阈值时，触发器状态将从“OK”转变为“Problem”，当数据再次恢复到合理范围，又转变为“OK”</p></li><li><p>事件（event）：触发一个值得关注的事情，比如触发器状态转变，新的agent或重新上线的agent的自动注册等</p></li><li><p>动作（action）：指对于特定事件事先定义的处理方法，如发送通知，何时执行操作</p></li><li><p>报警升级（escalation）：发送报警或者执行远程命令的自定义方案，如每隔5分钟发送一次报警，共发送5次等。</p></li><li><p>媒介（media）：发送通知的手段或者通道，如Email，Jabber或者SMS等</p></li><li><p>通知（notification）：通过选定的媒介向用户发送有关某事件的信息</p></li><li><p>远程命令（remote command）：预定义的命令，可在被监控主机处于某特定条件下时自动执行</p></li><li><p>模板（template）：用于快速定义被监控主机的预设条目集合，通常包含了item、trigger、graph、screen、application以及low-level discovery rule；模板可以直接链接到某个主机</p></li><li><p>应用（application）：一组item的集合</p></li><li><p>Web场景（web scennario）：用于检测web站点可用性的一个或多个HTTP请求</p></li><li><p>前端（frontend）：zabbix的web接口</p></li></ul><p>在实际生产使用的时候，Items、Trigger、Graph采用模板来进行监控，模板特点就是可以重复的事情一次完成，修改了模板等于修改了所有调用此模板的主机,这样可解放运维的双手.<br>Graph不是必需的，因为没有配置图形，数据获取并不影响，获取数据是Items的功能。但是对于使用ZabbixWeb界面用户来说，没有图形等于没有数据，因此重要的Items必须添加必要的图形以做可视化展示。如果想集中查看图形，可以通过screen功能。</p><h2 id="四、zabbix的主动模式和被动模式"><a href="#四、zabbix的主动模式和被动模式" class="headerlink" title="四、zabbix的主动模式和被动模式"></a>四、zabbix的主动模式和被动模式</h2><p><strong>一个监控系统运行的大概流程是这样的:</strong><br>Zabbix agent需要安装到被监控的主机上，它负责定期收集各项数据，并发送到zabbix server端，zabbix server将数据存储到数据库中，zabbix web根据数据在前端进行展现和绘图。<br><strong>这里agent收集数据分为主动和被动两种模式：</strong><br>主动：agent请求server获取主动的监控项列表，并主动将监控项内需要检测的数据提交给server&#x2F;proxy<br>被动：server向agent请求获取监控项的数据，agent返回数据</p><p><strong>监控功能</strong><br>主机的性能监控、网络设备性能监控、数据库性能监控、多种警告方式、详细的报表图表绘制</p><p>监控主机zabbix有专用的agent，可以监控Linux、Windows、FreeBSD等</p><p>监控网络设备zabbix通过SNMP、ssh</p><p>可监控对象：</p><pre><code>   设备：服务器、路由器、交换机   软件：OS、网络、应用程序   主机性能指标监控   故障监控：down机、服务不可达、主机不可达</code></pre><p>在实际监控架构中，zabbix根据网络环境、监控规模等分了三种架构：server-client、server-proxy-client、master-node-client、三种。</p><ul><li><p>server-client：监控机和被监控机直接不经过任何代理，直接由zabbix server和zabbix agentd之间进行数据交互。适用于网络比较简单，设备比较少的监控环境。</p></li><li><p>server-proxy-client： 其中proxy是server、client之间沟通的一个桥梁，proxy本身没有前端，而且其本身并不存放数据，只是将agentd发来的数据暂时存放，而后再提交给server。该架构经常是和master-node-client架构做比较的架构，一般适用于跨机房、跨网络的中型网络架构的监控。</p></li><li><p>该架构是zabbix最复杂的监控架构，适用于跨网络、跨机房、设备较多的大型环境。每个node同时也是一个server端，node下面可以接proxy，也可以直接接client。Node有自己的配置文件和数据库，其要做的是将配置信息和监控数据向master同步</p></li></ul><p><strong>最后我也是用了zabbix最简单的架构server-client</strong></p>]]></content>
    
    
    <categories>
      
      <category>Zabbix</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Zabbix</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Zabbix4.0配置自动发现规则（六）</title>
    <link href="/2022/08/31/zabbix/Zabbix4.0%E9%85%8D%E7%BD%AE%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E8%A7%84%E5%88%99(%E5%85%AD)/"/>
    <url>/2022/08/31/zabbix/Zabbix4.0%E9%85%8D%E7%BD%AE%E8%87%AA%E5%8A%A8%E5%8F%91%E7%8E%B0%E8%A7%84%E5%88%99(%E5%85%AD)/</url>
    
    <content type="html"><![CDATA[<p>主机名        ip地址               功能<br>server      10.1.14.133        zabbix-server<br>agent2      10.1.14.30         zabbix-agent2 </p><h2 id="一、网络发现"><a href="#一、网络发现" class="headerlink" title="一、网络发现"></a>一、网络发现</h2><p>Zabbix定期扫描网络发现规则中定义的IP范围，并为每条规则单独配置了检测的频率，不用手动添加主机。<br>网络发现由两个阶段组成，发现和动作。</p><h2 id="二、创建自动发现规则"><a href="#二、创建自动发现规则" class="headerlink" title="二、创建自动发现规则"></a>二、创建自动发现规则</h2><ul><li><p>创建一个自动发现的规则<br><img src="/img/zabbix/zabbix_76.png"></p></li><li><p>我这里只选择了两个ip范围内<br><img src="/img/zabbix/zabbix_77.png"></p></li><li><p>agent下设置Server需要指向zabbix-server(安装agent这里就不说了)<br><img src="/img/zabbix/zabbix_78.png"></p></li><li><p>检查zabbix通过system.uname进行发现,检测成功。<br><img src="/img/zabbix/zabbix_79.png"></p></li></ul><h2 id="三、创建动作"><a href="#三、创建动作" class="headerlink" title="三、创建动作"></a>三、创建动作</h2><ul><li>选择自动发现然后创建动作<br><img src="/img/zabbix/zabbix_80.png"></li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css">对新的触发条件进行配置，点击小添加，会生成响应条件<br><span class="hljs-selector-tag">A</span>：设置自动发现规则为已经设置好的刚刚设置的网络段<br><span class="hljs-selector-tag">B</span>：设置从发现主机之后的在线时间，默认单位秒<br>C：发现状态是up状态<br>D：服务类型是zabbix-agen<br><br></code></pre></td></tr></table></figure><ul><li>根据条件进行操作，这里选择我们刚刚前面创建好的条件。</li></ul><p><img src="/img/zabbix/zabbix_81.png"></p><ul><li>创建成功</li></ul><p><img src="/img/zabbix/zabbix_82.png"></p><h2 id="四、设置自动注册规则"><a href="#四、设置自动注册规则" class="headerlink" title="四、设置自动注册规则"></a>四、设置自动注册规则</h2><p>zabbix agent可以实现自动注册，进而服务器对其进行监控，通过这种方式，就不用在服务器上进行手动配置了，可以直接对新host进行监控。</p><ul><li><p>在zabbix agent客户端进行配置<br><img src="/img/zabbix/zabbix_83.png"></p></li><li><p>web端上创建自动注册规则<br><img src="/img/zabbix/zabbix_84.png"><br><img src="/img/zabbix/zabbix_85.png"><br><img src="/img/zabbix/zabbix_86.png"></p></li><li><p>这里可以重启下agent，检测自动注册上了<br><img src="/img/zabbix/zabbix_87.png"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>Zabbix</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Zabbix</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Zabbix4.0添加主机监控（三）</title>
    <link href="/2022/08/31/zabbix/Zabbix4.0%E6%B7%BB%E5%8A%A0%E4%B8%BB%E6%9C%BA%E7%9B%91%E6%8E%A7(%E4%B8%89)/"/>
    <url>/2022/08/31/zabbix/Zabbix4.0%E6%B7%BB%E5%8A%A0%E4%B8%BB%E6%9C%BA%E7%9B%91%E6%8E%A7(%E4%B8%89)/</url>
    
    <content type="html"><![CDATA[<h2 id="一、安装zabbix-agent"><a href="#一、安装zabbix-agent" class="headerlink" title="一、安装zabbix-agent"></a>一、安装zabbix-agent</h2><p><strong>1、设置软件仓库</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#下载源</span><br><span class="hljs-section">[root@agent1 ~]</span><span class="hljs-comment"># wget http://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm</span><br><span class="hljs-section">[root@agent1 ~]</span><span class="hljs-comment"># rpm -ivh zabbix-release-4.0-1.el7.noarch.rpm </span><br><br><span class="hljs-comment">#更换源</span><br><span class="hljs-section">[root@agent1 ~]</span><span class="hljs-comment"># cat /etc/yum.repos.d/zabbix.repo </span><br><span class="hljs-section">[zabbix]</span><br><span class="hljs-attr">name</span>=Zabbix <span class="hljs-literal">Off</span>icial Repository - <span class="hljs-variable">$basearch</span><br><span class="hljs-attr">baseurl</span>=https://mirror.tuna.tsinghua.edu.cn/zabbix/zabbix/<span class="hljs-number">4.0</span>/rhel/<span class="hljs-number">7</span>/<span class="hljs-variable">$basearch</span>/<br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591<br><br><span class="hljs-section">[zabbix-non-supported]</span><br><span class="hljs-attr">name</span>=Zabbix <span class="hljs-literal">Off</span>icial Repository non-supported - <span class="hljs-variable">$basearch</span> <br><span class="hljs-attr">baseurl</span>=https://mirror.tuna.tsinghua.edu.cn/zabbix/non-supported/rhel/<span class="hljs-number">7</span>/<span class="hljs-variable">$basearch</span>/<br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX<br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">0</span><br><span class="hljs-section">[root@agent1 ~]</span><span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><p><strong>2、安装zabbix-agent</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@agent1</span> ~]<span class="hljs-meta"># yum -y install zabbix-agent</span><br><br></code></pre></td></tr></table></figure><p><strong>3、修改zabbix-agent的配置文件</strong></p><p>我们要在zabbix-agent上修改配置文件，让我们的zabbix-agent允许zabbix-server获取数据。<br>zabbix server通过agent获取数据有两种模式，一种是agent端主动发送数据到server端，我们称之为<br>主动模式，agent端等待server提取数据，叫做被动模式，两种模式可以一起配置并不冲突。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br>[root@agent1 ~]<span class="hljs-comment"># sed -i &#x27;s/Server=127.0.0.1/Server=10.1.14.133/&#x27; /etc/zabbix/zabbix_agentd.conf </span><br>[root@agent1 ~]<span class="hljs-comment"># sed -i &#x27;s/ServerActive=127.0.0.1/ServerActive=10.1.14.133/&#x27; /etc/zabbix/zabbix_agentd.conf </span><br><span class="hljs-comment">#放行了端口</span><br>[root@agent1 ~]<span class="hljs-comment"># firewall-cmd --list-ports</span><br><span class="hljs-number">10050</span>/tcp<br>[root@agent1 ~]<span class="hljs-comment">#</span><br><br>[root@agent1 ~]<span class="hljs-comment"># egrep -v &#x27;^#|^$&#x27; /etc/zabbix/zabbix_agentd.conf </span><br>PidFile=<span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/zabbix/</span>zabbix_agentd.pid<br>LogFile=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/zabbix/</span>zabbix_agentd.log<br>LogFileSize=<span class="hljs-number">0</span><br><span class="hljs-comment">#Server表示允许那个主机获取我这里的数据</span><br>Server=<span class="hljs-number">10.1</span>.<span class="hljs-number">14.133</span><br>ListenPort=<span class="hljs-number">10050</span><br><span class="hljs-comment">#监听自己的客户端</span><br>ListenIP=<span class="hljs-number">10.1</span>.<span class="hljs-number">14.29</span><br><span class="hljs-comment">#ServerActive表示主动向那个主机发送数据</span><br>ServerActive=<span class="hljs-number">10.1</span>.<span class="hljs-number">14.133</span><br>Hostname=<span class="hljs-number">10.1</span>.<span class="hljs-number">14.29</span><br>Include=<span class="hljs-regexp">/etc/</span>zabbix<span class="hljs-regexp">/zabbix_agentd.d/</span>*.conf<br>[root@agent1 ~]<span class="hljs-comment"># </span><br><br><br><span class="hljs-comment">#重启zabbix-agent服务</span><br>[root@agent1 ~]<span class="hljs-comment"># netstat -lntup | grep agent</span><br>[root@agent1 ~]<span class="hljs-comment"># systemctl enable zabbix-agent --now</span><br>Created symlink from <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/mu</span>lti-user.target.wants<span class="hljs-regexp">/zabbix-agent.service to /u</span>sr<span class="hljs-regexp">/lib/</span>systemd<span class="hljs-regexp">/system/</span>zabbix-agent.service.<br>[root@agent1 ~]<span class="hljs-comment"># netstat -lntup | grep agent</span><br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">10050</span>           <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:*               LISTEN      <span class="hljs-number">19622</span>/zabbix_agentd <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">10050</span>                :::*                    LISTEN      <span class="hljs-number">19622</span>/zabbix_agentd<br><br><br><br></code></pre></td></tr></table></figure><h2 id="二、测试连接"><a href="#二、测试连接" class="headerlink" title="二、测试连接"></a>二、测试连接</h2><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta">#用zabbix-server测试是否能get到zabbix-agent的数据</span><br>[root<span class="hljs-symbol">@server</span> ~]<span class="hljs-meta"># zabbix_get -s 10.1.14.29 -p 10050 -k <span class="hljs-string">&quot;system.cpu.load[all,avg1]&quot;</span></span><br><span class="hljs-number">0.000000</span><br>[root<span class="hljs-symbol">@server</span> ~]<span class="hljs-meta"># </span><br>[root<span class="hljs-symbol">@server</span> ~]<span class="hljs-meta"># zabbix_get -s 10.1.14.29 -p 10050 -k <span class="hljs-string">&quot;system.hostname&quot;</span></span><br>agent1<br></code></pre></td></tr></table></figure><h2 id="三、创建主机、关联模板、监控项、触发器、图形和模板"><a href="#三、创建主机、关联模板、监控项、触发器、图形和模板" class="headerlink" title="三、创建主机、关联模板、监控项、触发器、图形和模板"></a>三、创建主机、关联模板、监控项、触发器、图形和模板</h2><p><img src="/img/zabbix/zabbix_12.png"></p><p><strong>4、创建主机群组并创建主机</strong><br><img src="/img/zabbix/zabbix_13.png"><br><img src="/img/zabbix/zabbix_14.png"><br><img src="/img/zabbix/zabbix_15.png"><br><img src="/img/zabbix/zabbix_16.png"><br><img src="/img/zabbix/zabbix_17.png"></p><p><strong>5、关联模板并关联监控项，创建图形查看图形</strong></p><p><img src="/img/zabbix/zabbix_18.png"><br><img src="/img/zabbix/zabbix_19.png"><br><img src="/img/zabbix/zabbix_20.png"><br><img src="/img/zabbix/zabbix_21.png"><br><img src="/img/zabbix/zabbix_22.png"><br><img src="/img/zabbix/zabbix_23.png"></p><p><strong>6、示例,创建监控项节点过去1分钟cpu的负载</strong><br>把原来的zabbix-server添加进来，这样才可以做监控<br><img src="/img/zabbix/zabbix_24.png"><br><img src="/img/zabbix/zabbix_25.png"><br><img src="/img/zabbix/zabbix_26.png"><br><img src="/img/zabbix/zabbix_27.png"><br><img src="/img/zabbix/zabbix_28.png"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#在zabbix-server上安装zabbix-agent</span><br>[root@server ~]<span class="hljs-comment"># yum -y install zabbix-agent</span><br><span class="hljs-comment">#修改zabbix-agent的配置文件</span><br>[root@server ~]<span class="hljs-comment"># sed -i &#x27;s/Server=127.0.0.1/Server=10.1.14.133/&#x27; /etc/zabbix/zabbix_agentd.conf</span><br>[root@server ~]<span class="hljs-comment"># sed -i &#x27;s/ServerActive=127.0.0.1/ServerActive=10.1.14.133/&#x27; /etc/zabbix/zabbix_agentd.conf </span><br>[root@server ~]<span class="hljs-comment"># egrep -v &#x27;^#|^$&#x27; /etc/zabbix/zabbix_agentd.conf</span><br>PidFile=<span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/zabbix/</span>zabbix_agentd.pid<br>LogFile=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/zabbix/</span>zabbix_agentd.log<br>LogFileSize=<span class="hljs-number">0</span><br>Server=<span class="hljs-number">10.1</span>.<span class="hljs-number">14.133</span><br>ServerActive=<span class="hljs-number">10.1</span>.<span class="hljs-number">14.133</span><br>Hostname=Zabbix server<br>Include=<span class="hljs-regexp">/etc/</span>zabbix<span class="hljs-regexp">/zabbix_agentd.d/</span>*.conf<br>[root@server ~]<span class="hljs-comment"># </span><br><br><span class="hljs-comment">#zabbix-agent服务重启</span><br>[root@server ~]<span class="hljs-comment"># systemctl enable zabbix-agent --now</span><br>Created symlink from <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/mu</span>lti-user.target.wants<span class="hljs-regexp">/zabbix-agent.service to /u</span>sr<span class="hljs-regexp">/lib/</span>systemd<span class="hljs-regexp">/system/</span>zabbix-agent.service.<br>[root@server ~]<span class="hljs-comment"># netstat -tunlp | grep agent</span><br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:<span class="hljs-number">10050</span>           <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>:*               LISTEN      <span class="hljs-number">12378</span>/zabbix_agentd <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">10050</span>                :::*                    LISTEN      <span class="hljs-number">12378</span>/zabbix_agentd <br>[root@server ~]<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><p>此时在web上看主机的监控可用性，已经变成绿色的了。<br><img src="/img/zabbix/zabbix_29.png"></p><p><strong>7、示例,设置监控图形</strong></p><p>由于监控图形的数据来自于监控项，如果没有监控项，那么就没有数据来源，没有数据来源则无法检测！<br><img src="/img/zabbix/zabbix_31.png"><br><img src="/img/zabbix/zabbix_32.png"><br><img src="/img/zabbix/zabbix_33.png"><br>此时看到字体是乱码的，这时候我们需要重新设置字体<br><img src="/img/zabbix/zabbix_34.png"></p><p><strong>8、修复图形字体的乱码问题</strong><br><img src="/img/zabbix/zabbix_35.png"><br><img src="/img/zabbix/zabbix_36.png"></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@server</span> ~]<span class="hljs-meta"># ls /usr/share/zabbix/assets/fonts/</span><br>graphfont.ttf  STXINWEI.TTF<br>[root<span class="hljs-symbol">@server</span> fonts]<span class="hljs-meta"># mv graphfont.ttf  graphfont.ttf.bak</span><br>[root<span class="hljs-symbol">@server</span> fonts]<span class="hljs-meta"># mv STXINWEI.TTF graphfont.ttf</span><br>[root<span class="hljs-symbol">@server</span> ~]<span class="hljs-meta"># </span><br><br></code></pre></td></tr></table></figure><p><strong>此时在查看图形</strong><br><img src="/img/zabbix/zabbix_37.png"></p><p><strong>7、示例,创建触发器</strong><br><img src="/img/zabbix/zabbix_38.png"><br><img src="/img/zabbix/zabbix_39.png"><br><img src="/img/zabbix/zabbix_40.png"><br><img src="/img/zabbix/zabbix_41.png"><br><img src="/img/zabbix/zabbix_42.png"></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">&#123;<span class="hljs-number">10.1</span>.<span class="hljs-number">14.133</span>:system<span class="hljs-selector-class">.cpu</span><span class="hljs-selector-class">.load</span><span class="hljs-selector-attr">[all,avg1]</span><span class="hljs-selector-class">.last</span>(#<span class="hljs-number">1</span>,<span class="hljs-number">20</span>)&#125;&gt;<span class="hljs-number">0.7</span><br><span class="hljs-number">10.1</span>.<span class="hljs-number">14.133</span>表示主机<br>system<span class="hljs-selector-class">.cpu</span><span class="hljs-selector-class">.load</span><span class="hljs-selector-attr">[all,avg1]</span>表示键值<br><span class="hljs-function"><span class="hljs-title">last</span><span class="hljs-params">(#<span class="hljs-number">1</span>,<span class="hljs-number">20</span>)</span></span>表示last函数，最后的<span class="hljs-number">1</span>个值，持续<span class="hljs-number">20s</span><br>&gt;<span class="hljs-number">0.7</span>表示last函数的取值如果大于<span class="hljs-number">0.7</span>，那么触发器就生效<br><br></code></pre></td></tr></table></figure><p><img src="/img/zabbix/zabbix_43.png"><br><img src="/img/zabbix/zabbix_44.png"><br><img src="/img/zabbix/zabbix_45.png"></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gradle">#手动提高主机的cpu负载，然后可以观察触发器的报警<br>[root@server ~]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br>[<span class="hljs-number">1</span>] <span class="hljs-number">14834</span><br>[root@server ~]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br>[<span class="hljs-number">2</span>] <span class="hljs-number">14836</span><br>[root@server ~]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br>[<span class="hljs-number">3</span>] <span class="hljs-number">14837</span><br>root@server ~]# watch -n3 uptime<br><br></code></pre></td></tr></table></figure><p><img src="/img/zabbix/zabbix_46.png"></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">#当触发器检测到监控项的值变低了，就会自动解决问题<br>[root@server ~]# pkill cat<br>[<span class="hljs-number">1</span>]   Terminated              cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br>[<span class="hljs-number">3</span>]-  Terminated              cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br>[<span class="hljs-number">2</span>]-  Terminated              cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br><br></code></pre></td></tr></table></figure><p><img src="/img/zabbix/zabbix_47.png"></p><p><strong>8、示例,将触发器应用到别的主机上</strong></p><p><img src="/img/zabbix/zabbix_48.png"><br><img src="/img/zabbix/zabbix_49.png"><br><img src="/img/zabbix/zabbix_50.png"></p>]]></content>
    
    
    <categories>
      
      <category>Zabbix</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Zabbix</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Zabbix4.0环境搭建（二）</title>
    <link href="/2022/08/31/zabbix/Zabbix4.0%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA(%E4%BA%8C)/"/>
    <url>/2022/08/31/zabbix/Zabbix4.0%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA(%E4%BA%8C)/</url>
    
    <content type="html"><![CDATA[<h2 id="一、实验准备"><a href="#一、实验准备" class="headerlink" title="一、实验准备"></a>一、实验准备</h2><p><strong>这里只做实验演练准备,Centos7三台台，一台为监控服务器，两台座位被监控节点。</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">zabbix</span>-server <span class="hljs-number">192.168.100.101</span><br><span class="hljs-attribute">zabbix</span>-agent <span class="hljs-number">192.168.100.102</span><br><span class="hljs-attribute">zabbix</span>-agent <span class="hljs-number">192.168.100.103</span><br></code></pre></td></tr></table></figure><h2 id="二、环境搭建"><a href="#二、环境搭建" class="headerlink" title="二、环境搭建"></a>二、环境搭建</h2><p>1、<strong>zabbix-server搭建</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#关闭SELINUX</span><br><br>[root@server ~]<span class="hljs-comment"># sed -i &#x27;s/SELINUX=enforcing/SELINUX=permissive/&#x27; /etc/selinux/config </span><br>[root@server ~]<span class="hljs-comment"># setenforce 0</span><br>[root@server ~]<span class="hljs-comment"># getenforce</span><br>Permissive<br>[root@server ~]<span class="hljs-comment"># </span><br><br><span class="hljs-comment">#配置zabbix yum仓库</span><br><br>[root@server ~]<span class="hljs-comment"># wget http://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm</span><br>[root@server ~]<span class="hljs-comment"># rpm -ivh zabbix-release-4.0-1.el7.noarch.rpm</span><br><br><span class="hljs-comment">#更换源</span><br>[root@server ~]<span class="hljs-comment"># cat /etc/yum.repos.d/zabbix.repo </span><br>[zabbix]<br>name=Zabbix Official Repository - <span class="hljs-variable">$basearch</span><br>baseurl=https:<span class="hljs-regexp">//mi</span>rror.tuna.tsinghua.edu.cn<span class="hljs-regexp">/zabbix/</span>zabbix<span class="hljs-regexp">/4.0/</span>rhel<span class="hljs-regexp">/7/</span><span class="hljs-variable">$basearch</span>/<br>enabled=<span class="hljs-number">1</span><br>gpgcheck=<span class="hljs-number">0</span><br>gpgkey=file:<span class="hljs-regexp">//</span><span class="hljs-regexp">/etc/</span>pki<span class="hljs-regexp">/rpm-gpg/</span>RPM-GPG-KEY-ZABBIX-A14FE591<br><br>[zabbix-non-supported]<br>name=Zabbix Official Repository non-supported - <span class="hljs-variable">$basearch</span> <br>baseurl=https:<span class="hljs-regexp">//mi</span>rror.tuna.tsinghua.edu.cn<span class="hljs-regexp">/zabbix/</span>non-supported<span class="hljs-regexp">/rhel/</span><span class="hljs-number">7</span><span class="hljs-regexp">/$basearch/</span><br>enabled=<span class="hljs-number">1</span><br>gpgkey=file:<span class="hljs-regexp">//</span><span class="hljs-regexp">/etc/</span>pki<span class="hljs-regexp">/rpm-gpg/</span>RPM-GPG-KEY-ZABBIX<br>gpgcheck=<span class="hljs-number">0</span><br>[root@server ~]<span class="hljs-comment"># </span><br><br><span class="hljs-comment">#安装zabbix-server服务端及zabbix-web前端和mariadb数据库</span><br>[root@server ~]<span class="hljs-comment"># yum -y install zabbix-server-mysql zabbix-web-mysql mariadb-server</span><br><br><span class="hljs-comment">#启动数据库并设置下次启动，如果不做这个操作，你的数据库就是没有密码的，默认数据库会创建一个root的用户，而且这个root用户是</span><br>管理员且没有密码<br>[root@server ~]<span class="hljs-comment"># systemctl enable mariadb --now</span><br><br><span class="hljs-comment">#初始化数据库</span><br>[root@server ~]<span class="hljs-comment"># mysql_secure_installation</span><br><br><span class="hljs-comment">#测试连接</span><br>[root@server ~]<span class="hljs-comment"># mysql -uroot -p123456 -hlocalhost</span><br>Welcome to the MariaDB monitor.  Commands end with ; or \g.<br>Your MariaDB connection id is <span class="hljs-number">10</span><br>Server version: <span class="hljs-number">5.5</span>.<span class="hljs-number">68</span>-MariaDB MariaDB Server<br><br><br><span class="hljs-comment">#创建一个zabbix的数据库并且设置一个专门的用户访问zabbix数据库的用户</span><br>MariaDB [(none)]&gt; create database zabbix character set utf8 collate utf8_bin;<br>MariaDB [(none)]&gt; grant all privileges on zabbix.* to zabbix@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&#x27;zabbix&#x27;</span>;<br>MariaDB [(none)]&gt; flush privileges;<br>MariaDB [zabbix]&gt; use zabbix;<br>MariaDB [zabbix]&gt; show tables;<br><br><span class="hljs-comment">#前面我们已经安装过zabbix-server-mysql软件了，现在将软件提供的zabbix数据库模板导入新建的zabbix数据库，因为该软件提供了zabbix数据库模板，里面包含了表</span><br>root@server ~]<span class="hljs-comment"># ls /usr/share/doc/zabbix-server-mysql-4.0.29/create.sql.gz </span><br><span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/doc/</span>zabbix-server-mysql-<span class="hljs-number">4.0</span>.<span class="hljs-number">29</span>/create.sql.gz<br><span class="hljs-comment">#将模板导入数据库</span><br>[root@server ~]<span class="hljs-comment"># zcat /usr/share/doc/zabbix-server-mysql-4.0.29/create.sql.gz  | mysql -uzabbix -pzabbix zabbix</span><br><span class="hljs-comment">#检查</span><br>[root@server ~]<span class="hljs-comment"># mysql -uzabbix -pzabbix -e &quot;use zabbix;&quot; -e &quot;show tables;&quot;</span><br><br><span class="hljs-comment">#配置zabbix-server</span><br>[root@server ~]<span class="hljs-comment"># egrep -v &#x27;^#|^$&#x27; /etc/zabbix/zabbix_server.conf </span><br>LogFile=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/zabbix/</span>zabbix_server.log<br>LogFileSize=<span class="hljs-number">0</span><br>PidFile=<span class="hljs-regexp">/var/</span>run<span class="hljs-regexp">/zabbix/</span>zabbix_server.pid<br>SocketDir=<span class="hljs-regexp">/var/</span>run/zabbix<br>DBHost=localhost<br>DBName=zabbix<br>DBUser=zabbix<br>DBPassword=zabbix<br>SNMPTrapperFile=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/snmptrap/</span>snmptrap.log<br>Timeout=<span class="hljs-number">4</span><br>AlertScriptsPath=<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/zabbix/</span>alertscripts<br>ExternalScripts=<span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/zabbix/</span>externalscripts<br>LogSlowQueries=<span class="hljs-number">3000</span><br><br><span class="hljs-comment">#修改zabbix前端的语言php配置</span><br>[root@server ~]<span class="hljs-comment"># vim /etc/httpd/conf.d/zabbix.conf </span><br>php_value date.timezone Asia/Shanghai<br><br><span class="hljs-comment">#启动zabbix-server及httpd</span><br>[root@server ~]<span class="hljs-comment"># systemctl enable zabbix-server --now</span><br>[root@server ~]<span class="hljs-comment"># systemctl enable httpd --now</span><br><span class="hljs-comment">#防火墙放行</span><br>[root@server ~]<span class="hljs-comment"># firewall-cmd --zone=public --add-port=80/tcp --per</span><br>[root@server ~]<span class="hljs-comment"># firewall-cmd --zone=public --add-port=10051/tcp --per</span><br>[root@server ~]<span class="hljs-comment"># firewall-cmd --reload</span><br>[root@server ~]<span class="hljs-comment">#</span><br><br></code></pre></td></tr></table></figure><p>可以正常访问<a href="http://xxx.xx.xx.xx./zabbix/">http://xxx.xx.xx.xx./zabbix/</a> , 现在我们可以正式进入到zabbix-web界面进行配置了</p><p><img src="/img/zabbix/zabbix_2.png"><br><img src="/img/zabbix/zabbix_3.png"><br><img src="/img/zabbix/zabbix_4.png"><br><img src="/img/zabbix/zabbix_5.png"><br><img src="/img/zabbix/zabbix_6.png"></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">上面的安装操作将会在该路径生成配置文件<br>[root@server ~]# ls <span class="hljs-regexp">/etc/</span>zabbix<span class="hljs-regexp">/web/</span>zabbix.conf.php <br><span class="hljs-regexp">/etc/</span>zabbix<span class="hljs-regexp">/web/</span>zabbix.conf.php<br></code></pre></td></tr></table></figure><p><img src="/img/zabbix/zabbix_7.png"></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autoit">然后配置中文，如果没有中文选项的话，需要安装一下中文包<br>[root<span class="hljs-symbol">@server</span> ~]<span class="hljs-meta"># yum -y install langpacks-zh_CN</span><br>[root<span class="hljs-symbol">@server</span> ~]<span class="hljs-meta"># yum -y install glibc-common</span><br></code></pre></td></tr></table></figure><p><img src="/img/zabbix/zabbix_8.png"><br><img src="/img/zabbix/zabbix_9.png"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">添加报警媒介<br></code></pre></td></tr></table></figure><p><img src="/img/zabbix/zabbix_10.png"></p>]]></content>
    
    
    <categories>
      
      <category>Zabbix</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Zabbix</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Zabbix4.0前端报警媒介-企业微信报警（五）</title>
    <link href="/2022/08/31/zabbix/Zabbix4.0%E5%89%8D%E7%AB%AF%E6%8A%A5%E8%AD%A6%E5%AA%92%E4%BB%8B-%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8A%A5%E8%AD%A6(%E4%BA%94)/"/>
    <url>/2022/08/31/zabbix/Zabbix4.0%E5%89%8D%E7%AB%AF%E6%8A%A5%E8%AD%A6%E5%AA%92%E4%BB%8B-%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E6%8A%A5%E8%AD%A6(%E4%BA%94)/</url>
    
    <content type="html"><![CDATA[<h2 id="一、注册企业微信企业号"><a href="#一、注册企业微信企业号" class="headerlink" title="一、注册企业微信企业号"></a>一、注册企业微信企业号</h2><p>这里我就略过了，网上很多教程，搜索一下就有了</p><h2 id="二、创建企业微信应用"><a href="#二、创建企业微信应用" class="headerlink" title="二、创建企业微信应用"></a>二、创建企业微信应用</h2><p>这里就我创建好了，大家也可以自己创建一下 动动手很快的事情<br><img src="/img/zabbix/zabbix_63.png"></p><h2 id="三、记录企业id-应用id"><a href="#三、记录企业id-应用id" class="headerlink" title="三、记录企业id,应用id"></a>三、记录企业id,应用id</h2><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">CorpId:</span> wwa7286c8e57ee83bb<br><span class="hljs-symbol">AgentId:</span> <span class="hljs-number">1000004</span><br><span class="hljs-symbol">Secret:</span> n1iE9h1GzioA8DPh0vXm0gSgjkqJd1T18wwvjK4aah4<br><br></code></pre></td></tr></table></figure><p><img src="/img/zabbix/zabbix_64.png"><br><img src="/img/zabbix/zabbix_65.png"></p><h2 id="四、企业微信接口调试"><a href="#四、企业微信接口调试" class="headerlink" title="四、企业微信接口调试"></a>四、<a href="https://open.work.weixin.qq.com/wwopen/devtool/interface/combine">企业微信接口调试</a></h2><p>如果检查完，回复Http 200 ok就说明没有问题了<br><img src="/img/zabbix/zabbix_66.png"></p><h2 id="五、准备企业微信报警媒介脚本"><a href="#五、准备企业微信报警媒介脚本" class="headerlink" title="五、准备企业微信报警媒介脚本"></a>五、准备企业微信报警媒介脚本</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment">#-*- coding: utf-8 -*-2.将脚本创建在报警脚本目录下</span><br>import requests<br>import sys<br>import os<br>import json<br>import<span class="hljs-built_in"> logging</span><br><span class="hljs-built_in"></span>logging.basicConfig(level = logging.DEBUG, format = <span class="hljs-string">&#x27;%(asctime)s, %(filename)s,%(levelname)s, %(message)s&#x27;</span>,<br>datefmt = <span class="hljs-string">&#x27;%a, %d %b %Y %H:%M:%S&#x27;</span>,<br>filename = os.path.join(<span class="hljs-string">&#x27;/tmp&#x27;</span>,<span class="hljs-string">&#x27;weixin.log&#x27;</span>),<br>filemode = <span class="hljs-string">&#x27;a&#x27;</span>)<br><span class="hljs-comment">#企业id</span><br><span class="hljs-attribute">corpid</span>=<span class="hljs-string">&#x27;wwa7286c8e57ee83bb&#x27;</span><br><span class="hljs-comment">#应用密码</span><br><span class="hljs-attribute">appsecret</span>=<span class="hljs-string">&#x27;n1iE9h1GzioA8DPh0vXm0tsNV3m0Q6xbT__ldaLkURE&#x27;</span><br><span class="hljs-comment">#应用id</span><br><span class="hljs-attribute">agentid</span>=1000004<br><span class="hljs-comment">#获取accesstoken</span><br><span class="hljs-attribute">token_url</span>=<span class="hljs-string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=&#x27;</span> + corpid +<span class="hljs-string">&#x27;&amp;corpsecret=&#x27;</span> + appsecret <br><span class="hljs-attribute">req</span>=requests.get(token_url) <br><span class="hljs-attribute">accesstoken</span>=req.json()[<span class="hljs-string">&#x27;access_token&#x27;</span>]<br><span class="hljs-comment">#发送消息</span><br><span class="hljs-attribute">msgsend_url</span>=<span class="hljs-string">&#x27;https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=&#x27;</span> + accesstoken<br><span class="hljs-attribute">touser</span>=sys.argv[1]<br><span class="hljs-attribute">subject</span>=sys.argv[2]<br><span class="hljs-comment">#toparty=&#x27;3|4|5|6&#x27;</span><br><span class="hljs-attribute">message</span>=sys.argv[2] + <span class="hljs-string">&quot;\n\n&quot;</span> +sys.argv[3]<br><span class="hljs-comment">#需要传入三个参数</span><br>params=&#123;<br><span class="hljs-string">&quot;touser&quot;</span>: touser,<br><span class="hljs-comment"># &quot;toparty&quot;: toparty,</span><br><span class="hljs-string">&quot;msgtype&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br><span class="hljs-string">&quot;agentid&quot;</span>: agentid,<br><span class="hljs-string">&quot;text&quot;</span>: &#123;<br><span class="hljs-string">&quot;content&quot;</span>: message<br>&#125;,<br><span class="hljs-string">&quot;safe&quot;</span>:0<br>&#125; <br><span class="hljs-attribute">req</span>=requests.post(msgsend_url, <span class="hljs-attribute">data</span>=json.dumps(params))<br>logging.<span class="hljs-built_in">info</span>(<span class="hljs-string">&#x27;sendto:&#x27;</span> + touser + <span class="hljs-string">&#x27;;;subject:&#x27;</span> + subject + <span class="hljs-string">&#x27;;;message:&#x27;</span> + message)<br><br><span class="hljs-comment">#corpid=wwa7286c8e57ee83aa</span><br><span class="hljs-comment">#Agentld=1000004</span><br><span class="hljs-comment">#secret=n1iE9h1GzioA8DPh0vXm0qbnee7iorhjZCAxtDXggb4</span><br><span class="hljs-comment">#ge ren id =ChenDanTao</span><br><span class="hljs-comment">#[root@zabbix-server ~]# python monitoring_wxwork.py  &#x27;ChenDanTao&#x27; &#x27;可以吃饭了&#x27; &#x27;快下班吃饭把&#x27;</span><br><br><br></code></pre></td></tr></table></figure><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs ruby">[root<span class="hljs-variable">@server</span> ~]<span class="hljs-comment"># egrep -v &#x27;^#|^$&#x27; /etc/zabbix/zabbix_server.conf</span><br>AlertScriptsPath=<span class="hljs-regexp">/usr/lib</span><span class="hljs-regexp">/zabbix/alertscripts</span><br><br><span class="hljs-comment">#将脚本放到该目录下</span><br>[root<span class="hljs-variable">@server</span> alertscripts]<span class="hljs-comment"># ls</span><br>monitoring_wxwork.py<br><br><span class="hljs-comment">#需要安装requests包</span><br>[root<span class="hljs-variable">@server</span> alertscripts]<span class="hljs-comment"># python monitoring_wxwork.py </span><br>Traceback (most recent call last):<br>  File <span class="hljs-string">&quot;monitoring_wxwork.py&quot;</span>, line <span class="hljs-number">5</span>, <span class="hljs-keyword">in</span> &lt;<span class="hljs-keyword">module</span>&gt;<br>    import requests<br><span class="hljs-symbol">ImportError:</span> No <span class="hljs-keyword">module</span> named requests<br>[root<span class="hljs-variable">@server</span> alertscripts]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#先安装python-pip,然后再用pip安装requests即可</span><br><br>[root<span class="hljs-variable">@server</span> alertscripts]<span class="hljs-comment"># yum -y install python-pip</span><br><span class="hljs-comment">#临时使用清华源加速下载包</span><br>[root<span class="hljs-variable">@server</span> alertscripts]<span class="hljs-comment"># pip install -i https://pypi.tuna.tsinghua.edu.cn/simple requests</span><br><br><span class="hljs-comment">#给脚本加权限并执行</span><br>[root<span class="hljs-variable">@server</span> alertscripts]<span class="hljs-comment"># chmod +x monitoring_wxwork.py</span><br><span class="hljs-comment">#执行脚本</span><br>[root<span class="hljs-variable">@server</span> alertscripts]<span class="hljs-comment"># python monitoring_wxwork.py</span><br><br></code></pre></td></tr></table></figure><p><strong>报警成功</strong></p><p><img src="/img/zabbix/zabbix_67.png"></p><h2 id="六、在web端设置自动企业微信报警"><a href="#六、在web端设置自动企业微信报警" class="headerlink" title="六、在web端设置自动企业微信报警"></a>六、在web端设置自动企业微信报警</h2><ul><li>首先还是定义发件人，创建一个企业微信报警媒介</li></ul><p><img src="/img/zabbix/zabbix_68.png"><br><img src="/img/zabbix/zabbix_69.png"></p><ul><li>然后定义收件人，不然出问题谁会知道呢</li></ul><p><img src="/img/zabbix/zabbix_70.png"><br><img src="/img/zabbix/zabbix_71.png"><br><img src="/img/zabbix/zabbix_72.png"></p><ul><li>然后执行测试命令，看下是否正常能发送,连续测试了两次，都报了以下错误<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@server alertscripts]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br>[root@server alertscripts]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br>[root@server alertscripts]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br>[root@server alertscripts]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br><br></code></pre></td></tr></table></figure><img src="/img/zabbix/zabbix_73.png"><br><img src="/img/zabbix/zabbix_74.png"></li></ul><p>第一个图片的解决方法<a href="https://blog.csdn.net/zhengzaifeidelushang/article/details/106871440">在这里</a><br>第二个图片的解决方法</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mel">#修改<span class="hljs-keyword">log</span>的用户和组<br>[root@server alertscripts]# <span class="hljs-keyword">ls</span> -ld /tmp/weixin.<span class="hljs-keyword">log</span> <br>-rw-r--r--. <span class="hljs-number">1</span> root root <span class="hljs-number">927</span> Mar <span class="hljs-number">21</span> <span class="hljs-number">01</span>:<span class="hljs-number">49</span> /tmp/weixin.<span class="hljs-keyword">log</span><br>[root@server alertscripts]# chown zabbix:zabbix /tmp/weixin.<span class="hljs-keyword">log</span><br><br></code></pre></td></tr></table></figure><ul><li>然后再执行测试就可以正常企业微信和邮件都收到了!</li></ul><p><img src="/img/zabbix/zabbix_75.png"></p>]]></content>
    
    
    <categories>
      
      <category>Zabbix</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Zabbix</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Zabbix4.0安装Grafana插件(七)</title>
    <link href="/2022/08/31/zabbix/Zabbix4.0%E5%AE%89%E8%A3%85Grafana%E6%8F%92%E4%BB%B6(%E4%B8%83)/"/>
    <url>/2022/08/31/zabbix/Zabbix4.0%E5%AE%89%E8%A3%85Grafana%E6%8F%92%E4%BB%B6(%E4%B8%83)/</url>
    
    <content type="html"><![CDATA[<h2 id="一、Grafana简介"><a href="#一、Grafana简介" class="headerlink" title="一、Grafana简介"></a>一、Grafana简介</h2><p>1、Grafana是什么，其实我也不知道，我也是小白开始学习的，但是通过我的了解发现Grafana是个好牛逼的开源工具，他可以接入各种数据源，然后用酷炫的图给我们展示出来，然后我们可以理解当前的指标，当前服务的状况，总之很吊，反正我是要学会它的了。</p><p>2、Grafana常用的数据源有MySQL、Prometheus、AWS、还有Microsoft SQL Server、Oracle数据库等。<br>Grafana还支持多种告警模式，比如我知道的就有，Email、Telegram、钉钉等Webhook方式和，但监控与告警并非Grafana强项。</p><p>3、Grafana如何展示数据？ Grafana靠各种插件来展示数据，插件分原生(内置)插件和社区插件。原生插件包括：Graph(图形)、Singlestat(单值状态图)、Stat(状态图)、Gauge(仪表度量图)、Bar Gauge(条状态度量图)、Table(表格图)、Text(文本图)、Dashboard list(仪表列盘)、Plugin list(插件列表)、AlertList(告警列表图)等。</p><h2 id="二、安装Grafana"><a href="#二、安装Grafana" class="headerlink" title="二、安装Grafana"></a>二、安装Grafana</h2><ul><li>这边可以到<a href="https://grafana.com/grafana/download/6.7.3?pg=get&plcmt=selfmanaged-box1-cta1">官网</a>下载，有多个版本下载，我这边用的是7.1.5的版本</li></ul><p><img src="/img/zabbix/grafana_02.png"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@<span class="hljs-keyword">server</span> ~]# ls<br>anaconda-ks.cfg  grafana<span class="hljs-number">-7.1</span><span class="hljs-number">.5</span><span class="hljs-number">-1.</span>x86_64.rpm  graphfont.ttf  graphfont.ttf.bak  <span class="hljs-keyword">show</span>  use  zabbix-<span class="hljs-keyword">release</span><span class="hljs-number">-4.0</span><span class="hljs-number">-1.</span>el7.noarch.rpm<br>[root@<span class="hljs-keyword">server</span> ~]# yum -y install grafana<span class="hljs-number">-7.1</span><span class="hljs-number">.5</span><span class="hljs-number">-1.</span>x86_64.rpm <br><br>#设置开机自启动<br>[root@<span class="hljs-keyword">server</span> ~]# systemctl <span class="hljs-keyword">enable</span> grafana-<span class="hljs-keyword">server</span> <span class="hljs-comment">--now</span><br>Created symlink <span class="hljs-keyword">from</span> /etc/systemd/<span class="hljs-keyword">system</span>/multi-<span class="hljs-keyword">user</span>.target.wants/grafana-<span class="hljs-keyword">server</span>.service <span class="hljs-keyword">to</span> /usr/lib/systemd/<span class="hljs-keyword">system</span>/grafana-<span class="hljs-keyword">server</span>.service.<br>[root@<span class="hljs-keyword">server</span> ~]# netstat -tunlp | grep grafana<br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> :::<span class="hljs-number">3000</span>                 :::*                    <span class="hljs-keyword">LISTEN</span>      <span class="hljs-number">1646</span>/grafana-<span class="hljs-keyword">server</span> <br><br></code></pre></td></tr></table></figure><ul><li><strong>默认账户和密码都是admin</strong><br><img src="/img/zabbix/grafana_03.png"></li><li><strong>界面还是很高大上的，有没有</strong><br><img src="/img/zabbix/grafana_04.png"></li></ul><h2 id="三、Grafana接入zabbix"><a href="#三、Grafana接入zabbix" class="headerlink" title="三、Grafana接入zabbix"></a>三、Grafana接入zabbix</h2><ul><li><p><strong>我们可以在线安装插件，我查了下默认安装位置在&#x2F;var&#x2F;lib&#x2F;grafana&#x2F;plugins;插件安装后需要重启grafana-server，安装插件需要用到grafana的命令。</strong><br><strong>可以用以下命令查看grafana的命令是如何使用的</strong><br><img src="/img/zabbix/grafana_05.png"><br><img src="/img/zabbix/grafana_06.png"><br><img src="/img/zabbix/grafana_07.png"></p></li><li><p><strong>只有安装zabbix的插件了才可以在grafana中添加zabbix的数据源，使用zabbix的监控数据绘画出图形来</strong><br><img src="/img/zabbix/grafana_09.png"></p></li><li><p><strong>这里我找了一些常用的插件，有需要的可以用</strong></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">grafana-cli plugins <span class="hljs-keyword">install </span>alexanderzobnin-zabbix-app<br>grafana-cli plugins <span class="hljs-keyword">install </span>grafana-piechart-panel<br>grafana-cli plugins <span class="hljs-keyword">install </span>agenty-flowcharting-panel<br>grafana-cli plugins <span class="hljs-keyword">install </span>grafana-<span class="hljs-keyword">clock-panel</span><br><span class="hljs-keyword"></span>grafana-cli plugins <span class="hljs-keyword">install </span>pierosavi-imageit-panel<br>grafana-cli plugins <span class="hljs-keyword">install </span><span class="hljs-keyword">jdbranham-diagram-panel</span><br><span class="hljs-keyword"></span>grafana-cli plugins <span class="hljs-keyword">install </span>agenty-flowcharting-panel<br><br></code></pre></td></tr></table></figure></li></ul><h2 id="四、配置zabbix源"><a href="#四、配置zabbix源" class="headerlink" title="四、配置zabbix源"></a>四、配置zabbix源</h2><ul><li><p><strong>安装完alexanderzobnin-zabbix-app插件后，记得要重启grafana，然后才可以进行启用插件</strong></p><p><img src="/img/zabbix/grafana_10.png"><br><img src="/img/zabbix/grafana_11.png"><br><img src="/img/zabbix/grafana_12.png"></p></li></ul><p>-<strong>这里添加zabbix的数据源,然后我第一次添加的时候找不到zabbix插件，查了一下，原因是因为我使用的grafana7.1.5版本的问题，要修改配置才启动才可以使用。</strong><br>  <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@server plugins]</span><span class="hljs-comment"># vim /etc/grafana/grafana.ini </span><br><span class="hljs-attr">allow_loading_unsigned_plugins</span> = alexanderzobnin-zabbix-datasource<br><span class="hljs-section">[root@server plugins]</span><span class="hljs-comment"># systemctl restart grafana-server</span><br><br></code></pre></td></tr></table></figure><br>  <img src="/img/zabbix/grafana_13.png"><br>  <img src="/img/zabbix/grafana_14.png"><br>  <img src="/img/zabbix/grafana_15.png"><br>  <img src="/img/zabbix/grafana_16.png"></p><p>  <strong>这里就成功在grafana下添加zabbix成功了 nice！ 又能愉快的操作了</strong></p>]]></content>
    
    
    <categories>
      
      <category>Zabbix</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Zabbix、grafana</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Zabbix4.0前端报警媒介-qq邮件报警（四）</title>
    <link href="/2022/08/31/zabbix/Zabbix4.0%E5%89%8D%E7%AB%AF%E6%8A%A5%E8%AD%A6%E5%AA%92%E4%BB%8B-%E9%82%AE%E4%BB%B6%E6%8A%A5%E8%AD%A6(%E5%9B%9B)/"/>
    <url>/2022/08/31/zabbix/Zabbix4.0%E5%89%8D%E7%AB%AF%E6%8A%A5%E8%AD%A6%E5%AA%92%E4%BB%8B-%E9%82%AE%E4%BB%B6%E6%8A%A5%E8%AD%A6(%E5%9B%9B)/</url>
    
    <content type="html"><![CDATA[<h2 id="一、报警前提-zabbix-server必须能访问internet"><a href="#一、报警前提-zabbix-server必须能访问internet" class="headerlink" title="一、报警前提,zabbix-server必须能访问internet"></a>一、报警前提,zabbix-server必须能访问internet</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs routeros">1.zabbix-server必须能访问internet,保证server可以和外界的SMTP（邮件传输协议25端口）服务器建立连接。<br>2.必须具备一个能发邮件的邮箱<br>3.必须确定要给谁发邮件<br><br>[root@server ~]#<span class="hljs-built_in"> ping </span>-c 1 mail.qq.com<span class="hljs-built_in"></span><br><span class="hljs-built_in">PING </span>v6.mail.qq.com (14.18.245.237) 56(84) bytes of data.<br>64 bytes <span class="hljs-keyword">from</span> 14.18.245.237 (14.18.245.237): <span class="hljs-attribute">icmp_seq</span>=1 <span class="hljs-attribute">ttl</span>=54 <span class="hljs-attribute">time</span>=3.30 ms<br><br>--- v6.mail.qq.com<span class="hljs-built_in"> ping </span>statistics ---<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min/avg/max/mdev = 3.303/3.303/3.303/0.000 ms<br>[root@server ~]# <br></code></pre></td></tr></table></figure><h2 id="二、zabbix设置告警的完整流程"><a href="#二、zabbix设置告警的完整流程" class="headerlink" title="二、zabbix设置告警的完整流程"></a>二、zabbix设置告警的完整流程</h2><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-number">1</span>.添加用户组(添加权限)权限只能按用户分配<br><span class="hljs-number">2</span>.添加用户(选择用户类型、用户、管理员、超级管理员、添加报警媒介)<br><span class="hljs-number">3</span>.在<span class="hljs-string">&quot;管理&gt;报警媒介类型&quot;</span>中设置好报警媒介<br><span class="hljs-number">4</span>.启动<span class="hljs-built_in">action</span>，在<span class="hljs-string">&quot;配置&gt;动作&quot;</span>中启用,并配置操作<br></code></pre></td></tr></table></figure><h2 id="三、zabbix设置邮件报警大体可以分为两大类"><a href="#三、zabbix设置邮件报警大体可以分为两大类" class="headerlink" title="三、zabbix设置邮件报警大体可以分为两大类"></a>三、zabbix设置邮件报警大体可以分为两大类</h2><ul><li><strong>使用外部邮箱账号发送报警邮件设置</strong><ul><li>Email</li><li>自定义脚本</li></ul></li><li><strong>使用zabbix服务端本地邮箱账号发送邮件</strong></li></ul><p><strong>1、使用QQ邮箱发送报警邮件</strong></p><ul><li>登录mail.qq.com获取QQ邮箱的授权码</li></ul><p><img src="/img/zabbix/zabbix_51.png"><br><img src="/img/zabbix/zabbix_52.png"></p><figure class="highlight golo"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs golo"><span class="hljs-comment">#安装sendmail和mailx软件</span><br>[root<span class="hljs-meta">@server</span> ~]<span class="hljs-comment"># yum -y install sendmail mailx</span><br><span class="hljs-comment">#开启sendmail服务</span><br>[root<span class="hljs-meta">@server</span> ~]<span class="hljs-comment"># systemctl enable sendmail --now</span><br>[root<span class="hljs-meta">@server</span> etc]<span class="hljs-comment"># cp mail.rc mail2.rc</span><br>[root<span class="hljs-meta">@server</span> etc]<span class="hljs-comment"># mv mail.rc mail.rc.bak</span><br>[root<span class="hljs-meta">@server</span> etc]<span class="hljs-comment"># mv mail2.rc mail.rc</span><br><br><br><span class="hljs-comment">#配置sendmail客户端邮件配置</span><br>[root<span class="hljs-meta">@server</span> etc]<span class="hljs-comment"># cat mail.rc</span><br><span class="hljs-keyword">set</span> from=lmxi_dei<span class="hljs-meta">@qq</span>.com<br><span class="hljs-keyword">set</span> smtp=smtp.qq.com<br><span class="hljs-keyword">set</span> smtp-auth-user=lmxi_dei<span class="hljs-meta">@qq</span>.com<br><span class="hljs-comment">#password是qq邮箱的授权码，并不是qq密码</span><br><span class="hljs-keyword">set</span> smtp-auth-password=xlxildjofkexwerf<br><span class="hljs-keyword">set</span> smtp-auth=login<br>[root<span class="hljs-meta">@server</span> etc]<span class="hljs-comment"># </span><br><br><span class="hljs-comment">#邮件发送测试</span><br>[root<span class="hljs-meta">@server</span> etc]<span class="hljs-comment"># echo &#x27;zabbix邮件主题告警&#x27; | mail -s &#x27;邮件测试第一次&#x27; lemonchen@lexin.com</span><br><br></code></pre></td></tr></table></figure><p><img src="/img/zabbix/zabbix_53.png"></p><p><strong>2、在zabbix-web上设置邮件报警媒介</strong></p><ul><li>这里我们首先设置发件人,设置报警媒介，我们选择电子邮件报警</li></ul><p><img src="/img/zabbix/zabbix_54.png"><br><img src="/img/zabbix/zabbix_55.png"></p><ul><li>设置完发件人以后，需要设置收件人，收件人可以填多个，这里我就填自己的，大家不要给我炸我邮箱了哈哈</li></ul><p><img src="/img/zabbix/zabbix_56.png"></p><ul><li>发件人和收件人都设置完了，这时候需要有一个动作，当设置的值高于阈值的时候，有一个动作产生报警</li></ul><p><img src="/img/zabbix/zabbix_57.png"></p><p>这里的报警内容，可以做修改(<a href="https://www.zabbix.com/documentation/4.0/zh/manual/appendix/macros/supported_by_location">https://www.zabbix.com/documentation/4.0/zh/manual/appendix/macros/supported_by_location</a>)</p><ul><li>操作发送报警的内容</li></ul><p><img src="/img/zabbix/zabbix_58.png"></p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">zabbix报警名称: </span><span class="hljs-template-variable">&#123;EVENT.NAME&#125;</span><span class="language-xml"></span><br><span class="language-xml">告警主机：</span><span class="hljs-template-variable">&#123;HOSTNAME1&#125;</span><span class="language-xml"></span><br><span class="language-xml">告警地址：</span><span class="hljs-template-variable">&#123;HOST.IP&#125;</span><span class="language-xml"></span><br><span class="language-xml">告警时间：</span><span class="hljs-template-variable">&#123;EVENT.DATE&#125;</span><span class="language-xml"> </span><span class="hljs-template-variable">&#123;EVENT.TIME&#125;</span><span class="language-xml"></span><br><span class="language-xml">告警等级：</span><span class="hljs-template-variable">&#123;TRIGGER.SEVERITY&#125;</span><span class="language-xml"></span><br><span class="language-xml">告警信息：</span><span class="hljs-template-variable">&#123;TRIGGER.NAME&#125;</span><span class="language-xml"></span><br><span class="language-xml">告警项目：</span><span class="hljs-template-variable">&#123;TRIGGER.KEY1&#125;</span><span class="language-xml"></span><br><span class="language-xml">问题详情：</span><span class="hljs-template-variable">&#123;ITEM.NAME&#125;</span><span class="language-xml">:</span><span class="hljs-template-variable">&#123;ITEM.VAULE&#125;</span><span class="language-xml"></span><br><span class="language-xml">当前状态：Error</span><br><span class="language-xml">事件ID：</span><span class="hljs-template-variable">&#123;EVENT.ID&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br></code></pre></td></tr></table></figure><ul><li>恢复操作报警的内容<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml">zabbix恢复名称: </span><span class="hljs-template-variable">&#123;EVENT.NAME&#125;</span><span class="language-xml"></span><br><span class="language-xml">已恢复主机：</span><span class="hljs-template-variable">&#123;HOSTNAME1&#125;</span><span class="language-xml"></span><br><span class="language-xml">已恢复地址：</span><span class="hljs-template-variable">&#123;HOST.IP&#125;</span><span class="language-xml"></span><br><span class="language-xml">已恢复时间：</span><span class="hljs-template-variable">&#123;EVENT.DATE&#125;</span><span class="language-xml"> </span><span class="hljs-template-variable">&#123;EVENT.TIME&#125;</span><span class="language-xml"></span><br><span class="language-xml">已恢复信息：</span><span class="hljs-template-variable">&#123;TRIGGER.NAME&#125;</span><span class="language-xml"></span><br><span class="language-xml">已恢复项目：</span><span class="hljs-template-variable">&#123;TRIGGER.KEY1&#125;</span><span class="language-xml"></span><br><span class="language-xml">已恢复详情：</span><span class="hljs-template-variable">&#123;ITEM.NAME&#125;</span><span class="language-xml">:</span><span class="hljs-template-variable">&#123;ITEM.VAULE&#125;</span><span class="language-xml"></span><br><span class="language-xml">当前状态：true</span><br><span class="language-xml">事件ID：</span><span class="hljs-template-variable">&#123;EVENT.ID&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><br></code></pre></td></tr></table></figure></li></ul><p><img src="/img/zabbix/zabbix_59.png"></p><ul><li><p>测试报警结果图</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@server etc]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br>[root@server etc]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br>[root@server etc]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br>[root@server etc]# cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> &amp;<br><br></code></pre></td></tr></table></figure><p><img src="/img/zabbix/zabbix_60.png"></p></li><li><p>自动恢复报警</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@server etc]# pkill cat<br>[<span class="hljs-number">7</span>]   Terminated              cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br>[<span class="hljs-number">9</span>]   Terminated              cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br>[<span class="hljs-number">8</span>]   Terminated              cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br>[<span class="hljs-number">11</span>]   Terminated              cat <span class="hljs-regexp">/dev/</span>zero &gt;&gt; <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span><br><br></code></pre></td></tr></table></figure><p><img src="/img/zabbix/zabbix_61.png"></p></li></ul><p>这里能做恢复是因为之前我们前面触发器设置了恢复表达式小于0.7就恢复<br><img src="/img/zabbix/zabbix_62.png"></p>]]></content>
    
    
    <categories>
      
      <category>Zabbix</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Zabbix</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WSUS部署 Windows 10 更新</title>
    <link href="/2022/08/31/Windows/wsus_update_win10/"/>
    <url>/2022/08/31/Windows/wsus_update_win10/</url>
    
    <content type="html"><![CDATA[<p>WSUS概述<br>为了让用户的windows系统与其他microsoft产品能够更安全，更稳定，因此microsoft会不定期在网站上推出最新的更新程序供用户下载与安装，而用户可以通过以下方式来取得这些程序：</p><ul><li><strong>手动连接microsoft update网站</strong></li><li><strong>通过windows系统的自动更新功能</strong></li></ul><p>然而以上两种方式对企业内部来说，都可能会有以下缺点。</p><ul><li><strong>影响网络效率：</strong>如果企业内部每台计算机都自行上网更新，将会增加对外网络的负担。</li><li><strong>与现有软件相互干扰：</strong>如果企业内部使用的软件与更新程序发生冲突，则用户自行下载与安装更新程序可能会影响该软件或更新程序的正常运行。<br>WSUS是一个可以解决上述问题的产品，企业内部可以通过WSUS服务器集中从Microsoft update网站下载更新程序，并且在完成这些更新程序的测试工作，确定对企业内部计算机没有不良影响后，在通过网管审批程序，将程序部署到客户机上。</li></ul><p><strong>实验环境：</strong><br>1.hyper-v下的虚拟机进行<br>2.DC域控制器一台<br>3.WSUS补丁服务器一台<br>4.win10客户端一台</p><p><strong>实验目的:</strong><br>1.WSUS获取Microsoft 更新<br>2.WSUS下发更新到客户端<br>3.客户端更新成功</p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-0e2420e45bb0a553.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="拓步.jpg"></p><p><strong>1、</strong> WSUS服务器角色的安装，安装的整个过程还是比较简单的，只需要一直下一步下一步即可，使用作为本地 Administrators 组成员的帐户登录到你计划安装 WSUS 服务器角色的服务器。</p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-1bc1745001f8837a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-72f0223bd8f81e21.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><ul><li>选择数据库。使用内置数据库，如果要使用SQL数据库，勾选数据库</li><li>WID connectivity: wsus需要数据库的支持，使用内置数据库。</li><li>WSUS服务：包含了更新服务、web服务、服务器同步数据等wsus的角色</li><li>SQL Server：使wsus连接SQL server数据，适合大规模部署或高可靠性</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-99e77cca06d7afd5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-5aafe22f4658944f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a9987cf325b2fa04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-03b8cce70b6e3ede.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-b76807eb2ba163e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p><p><strong>2、</strong> WSUS服务器角色之后，第一次使用WSUS的时候会进入WSUS的配置向导，对WSUS做一个基本的设置。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-b5823714fdb8415e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-6867638b7227ff33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-4331f7d5c6c8b6ad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-309f71eb6f4fe049.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p>在<strong>“选择上游服务器”</strong>页上，你可选择将更新与 Microsoft 更新或其他 WSUS 服务器同步。</p><ul><li><p>如果你选择从其他 WSUS 服务器同步，请指定服务器名称以及该服务器与上游服务器通信时所在的端口。</p></li><li><p><strong>若要使用 SSL，请选中“同步更新信息时使用 SSL”复选框。</strong></p></li><li><p><strong>如果这是副本服务器，请选择“这是上游服务器的副本”复选框</strong>。</p></li></ul><p>因为我这里是第一个wsus服务器，如果你是二级wsus，这里就需要填第二个选项。</p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-63640450f465fdb3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><p><strong>在“指定代理服务器”页上，选中“同步时使用代理服务器”复选框，然后在对应的框中键入代理服务器名称和端口号（默认是端口80）。</strong></p><p><strong>如果你确定 WSUS 需要代理服务器才能访问 Internet，则必须完成上一步骤。</strong></p><p><strong>如果你希望通过使用特定用户凭据来连接代理服务器，请选择“使用用户凭据连接代理服务器”复选框，然后在对应的框中键入用户名称、域和用户密码。如果你希望启用已连接代理服务器的用户的基本身份验证，请选择“允许基本身份验证（以明文形式发送密码）”对话框。</strong></p><p>这里我就默认下一步了</p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-410fc852ac062d06.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><p>这里要求必须有<strong>internet</strong>链接。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-3e4b88e4b2171080.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c92860386e2fb539.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-2151425f263bfa33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-3eb125cc37b37484.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p><p><strong>选择手动或自动同步。选择自动同步，需要设置第一次同步的时间与每天同步的次数。</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-332ea4853f75a520.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a69c7da5897dc114.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="12.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-d8f8cb039847b5ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="13.png"></p><p><strong>WSUS 管理控制台</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-976bb581e7945bbd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="14.png"></p><h1 id="设置客户端的自动更新"><a href="#设置客户端的自动更新" class="headerlink" title="设置客户端的自动更新"></a>设置客户端的自动更新</h1><p>我们要让客户端计算机能够通过WSUS服务器下载更新程序，而这个设置可以通过以下两种方法来完成。</p><ul><li><p>组策略:在AD域环境下，可以通过组策略进行设置。</p></li><li><p>本地计算机策略：如果没有AD域环境，或客户端计算机未加入域，则可以通过本地计算机策略进行设置。</p></li></ul><p>我们利用组策略来进行说明。在域中创建一个GPO，WSUS策略，然后通过这个GPO来设置域内的所有客户端计算机的自动更新配置。</p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-b9dde4416b520581.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p><p>######在组策略管理编辑器中，依次转到“计算机配置”\“策略”\“管理模板”\“Windows 组件”\“Windows 更新”</p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-0fc38b97fe52c90e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><ul><li><strong>通知下载并通知安装：</strong>在下载更新程序前会通知已登录的系统管理员，由他自行决定是否现在下载；下载完成后和准备安装前也会通知系统管理员，然后由他自行决定是否现在安装。</li><li><strong>自动下载并通知安装：</strong>自动下载更新程序，下载完成后和准备安装前会通知已登录的系统管理员，然后由他自行决定是否现在安装。</li><li><strong>自动下载并计划安装：</strong>自动下载更新程序，并且会在指定的时间自动安装。需要指定安装时间。</li><li><strong>允许本地管理员选择设置：</strong>此选项让在客户端的本地管理员可以通过控制面板自行选择更新方式。</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-545478c2f3ac8097.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9391a042bc691f49.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p>在 “选项” 下，在 “设置用于检测更新和设置 intranet 统计信息的 intranet 更新服务” 服务器选项中，键入，然后 <a href="http://Your_WSUS_Server_FQDN:PortNumber">http://Your_WSUS_Server_FQDN:PortNumber</a> 选择 “确定”。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://<span class="hljs-number">192.168.137.98:8530</span> #这是我WSUS服务器的ip地址，这里需要填自己wsus服务器地址。<br><span class="hljs-attribute">WSUS</span> 的默认 HTTP 端口是 <span class="hljs-number">8530</span>，安全套接字层上的默认 HTTP (HTTPS) 端口是 <span class="hljs-number">8531</span>。 (其他选项为<span class="hljs-number">80</span>和 <span class="hljs-number">443</span>;不支持任何其他端口。 )<br></code></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a1a6c6c13fc13662.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><ul><li>可以设置“自动更新检测的频率”，默认是22小时，我们可以根据实际的需要来调整间隔。如图。</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-ac7442514dbb79e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-718f1e1708c1f6b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p><ul><li>可以启用“对于已登录用户的计算机，计划的自动更新安装不执行重新启动”，这样的话，当计算机存在已登录的用户的时候，装完更新是否重启取决于用户的行为，计算机不会强制重启，</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-95ed297e5b7a198f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-b796283cae2423f1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p><ul><li>对于某些不会中断windows服务，也不会需要重启服务器才生效的更新，我们可以配置启用“允许自动更新立即安装”。</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9d3f864b593018b7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-94a4ab76271549bf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p><p>设置完成后，必须等域内的客户端应用这个策略才能有效，而客户端计算机默认每隔90-120分钟应用一次。到客户端计算机上执行<strong>gpupdate&#x2F;force</strong>命令。</p><p>应用完成后，还必须等客户机与wsus服务器接触后，在wsus管理控制台才能看到这些客户机。不过需要等待20分钟才会主动联系WSUS服务器。在客户机上执行<strong>wuauclt&#x2F;detectnow</strong> 命令。</p><h1 id="配置自动审批规则"><a href="#配置自动审批规则" class="headerlink" title="配置自动审批规则"></a>配置自动审批规则</h1><ul><li>可以设置当WSUS服务器与Windows Update同步时，自动审批下载的更新程序。例如，如果希望所有下载的安全更新与重要更新都能够自动审批给所有计算机:单击选项中的自动审批，在前景图中勾选默认的自动审批规则。如果还要将此规则应用到已经同步的更新程序，请单击允许规则。</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-3104c95153edd771.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-b7f8c2867fa5bf1d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-3817d2b3be8bdf47.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-36dea5d3d6336538.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-6b4c0111f85332e5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-6105f6aa29b89c1a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9bcf456739578ec0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p><h1 id="手动批准并部署功能更新"><a href="#手动批准并部署功能更新" class="headerlink" title="手动批准并部署功能更新"></a>手动批准并部署功能更新</h1><p><img src="https://upload-images.jianshu.io/upload_images/9650472-150bbe452c0a4dd0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-2f54227fdee98498.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-26433d2d62b44f27.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-68b7a2a147a853fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><pre><code>参考 [https://blog.51cto.com/search/user?uid=639838&amp;q=WSUS] [https://docs.microsoft.com/zh-cn/windows/deployment/update/waas-manage-updates-wsus#%E7%AE%A1%E7%90%86-windows-10-%E6%9B%B4%E6%96%B0%E7%9A%84%E6%AD%A5%E9%AA%A4steps-to-manage-updates-for-windows-10](https://docs.microsoft.com/zh-cn/windows/deployment/update/waas-manage-updates-wsus#%E7%AE%A1%E7%90%86-windows-10-%E6%9B%B4%E6%96%B0%E7%9A%84%E6%AD%A5%E9%AA%A4steps-to-manage-updates-for-windows-10)</code></pre>]]></content>
    
    
    <categories>
      
      <category>Windows</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WinServer</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Powershell批量创建AD用户</title>
    <link href="/2022/08/31/Powershell/powershell_add_user/"/>
    <url>/2022/08/31/Powershell/powershell_add_user/</url>
    
    <content type="html"><![CDATA[<p><strong>查看Powershell版本</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-78582f4b3d5563e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p><ul><li>准备好相关域用户信息，一般都是Excel表，以AdUserData.csv格式保存，再以文档模式打开，编码设置<strong>UTF-8</strong>保存覆盖当前文件。</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-7a674dd0e9f9cd39.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a2592079e3018cbd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-90e106183dce459e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15860831608682.png"></p><ul><li>此时无用户<br><img src="https://upload-images.jianshu.io/upload_images/9650472-d98286ee79eceebe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Import-Csv</span> <span class="hljs-string">&#x27;C:\Users\administrator\Desktop\AdUserData.csv&#x27;</span>| <br><span class="hljs-built_in">ForEach-Object</span>&#123;<span class="hljs-built_in">New-ADUser</span> <span class="hljs-literal">-SamAccountName</span> <span class="hljs-variable">$_</span>.SamAccountName <span class="hljs-literal">-Surname</span> <span class="hljs-variable">$_</span>.Surname <span class="hljs-literal">-GivenName</span> <span class="hljs-variable">$_</span>.GivenName <span class="hljs-literal">-Name</span> `<br><span class="hljs-variable">$_</span>.Name <span class="hljs-literal">-UserPrincipalName</span> <span class="hljs-variable">$_</span>.UserPrincipalName <span class="hljs-literal">-DisplayName</span> `<br><span class="hljs-variable">$_</span>.Name <span class="hljs-literal">-Description</span> <span class="hljs-variable">$_</span>.Name <span class="hljs-literal">-Path</span> <span class="hljs-variable">$_</span>.Path <span class="hljs-literal">-AccountPassword</span>(<span class="hljs-built_in">ConvertTo-SecureString</span> <span class="hljs-literal">-AsPlainText</span> <span class="hljs-variable">$_</span>.AccountPassword <span class="hljs-literal">-Force</span>) <span class="hljs-literal">-Enabled</span> <span class="hljs-number">1</span> <span class="hljs-literal">-ChangePasswordAtLogon</span> <span class="hljs-number">1</span> &#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/9650472-435d00f80bb71b86.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-1b7868cb6433574c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><p><strong>New-ADUser -SamAccountName</strong>: 新建域用户</p><p><strong>$_.SamAccountName</strong>: 匹配表格第一列</p><p><strong>-Enabled 1</strong> :启用域用户</p><p><strong>-ChangePasswordAtLogon 1</strong> ：用户下次登陆时必须更改密码</p>]]></content>
    
    
    <categories>
      
      <category>Windows</category>
      
    </categories>
    
    
    <tags>
      
      <tag>powershell</tag>
      
      <tag>WinServer</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Windows自动化装机部署（六）自动化部署配置</title>
    <link href="/2022/08/31/MDT/windows_autoinstall_06/"/>
    <url>/2022/08/31/MDT/windows_autoinstall_06/</url>
    
    <content type="html"><![CDATA[<p><strong>现在我们就可以通过MDT进行部署了，在开始部署操作系统之前，我们需要对Windows PE启动引导进行简单自动化配置，从而方便后续操作系统部署的顺利进行，需要补充的是：在未集成SQL之前，这里的自定制设置是整个自动化部署过程中最重要的环节。接下来就为大家带来今日的自动化部署配置、客户端部署过程中信息系统日志的远程存放（Logs日志的远程存放是为了方便大家在分发失败的时候更好的排错）、控制台的更新内容。</strong></p><ul><li><p>配置启动镜像，选择“MDT Deployment Share”右键属性：<br><img src="https://upload-images.jianshu.io/upload_images/9650472-0418781644a6abe8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p></li><li><p>Network(UNC) path网络共享存放路径，及Local path本地存放路径位置<br><img src="https://upload-images.jianshu.io/upload_images/9650472-ae21960db190f321.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p></li><li><p>设置 Rules 参数（自动化部署参数）<br><img src="https://upload-images.jianshu.io/upload_images/9650472-8bab89ede8a202cf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-d19c6a3d5cf8da46.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15882408357760.png"></p><ul><li>点击Windows PE 出现了报错是因为没有预安装PE负载项 <a href="%5Bhttps://docs.microsoft.com/zh-cn/windows-hardware/get-started/adk-install%5D(https://docs.microsoft.com/zh-cn/windows-hardware/get-started/adk-install)">下载链接</a><br><img src="https://upload-images.jianshu.io/upload_images/9650472-50f54e9457e802c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-71b5e0e639c4a3b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15882315885634.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-df2f203ee80e63ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-18fd083477ab6896.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-32f283bdd0c70747.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-6496337bc142e22c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-8564818bd093e72f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p><ul><li>勾选掉“Generate a lite Touch bootable ISO image”，即不创建ISO镜像<br><img src="https://upload-images.jianshu.io/upload_images/9650472-4e36d8fd5917f439.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a583648b8e944931.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><ul><li><p>为了防止有中文识别乱码问题，建议奖香港台湾两地语言包一起勾选<br><img src="https://upload-images.jianshu.io/upload_images/9650472-8c54b159bd1eb09f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p></li><li><p>相关驱动及补丁包的默认调用设置<br><img src="https://upload-images.jianshu.io/upload_images/9650472-38eecdfc31043a16.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p></li><li><p>我们需要在相应服务器上设置一个共享文件夹，everyone有可读可写权限，以方便客户端日志信息的远程写入。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-79d4ee6aff70332c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-cb91287ce3b72a21.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-db5c6681701645a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p><ul><li>右键MDT Deployment Share ，选择Update Deployment Share进行更新 (每次更改操作后都需要更新)<br><img src="https://upload-images.jianshu.io/upload_images/9650472-98fd9616426a47e6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-ab19ad0bb65ea623.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-2a3cb1ecfd1aa9bd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p><ul><li><p>启动映像生成完成，会在对应Deploymentshare下的Boot目录下生成相应的启动WIM映像；<br><img src="https://upload-images.jianshu.io/upload_images/9650472-86c2c80cc5ada111.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p></li><li><p>rules 自动化参数详解</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs awk">Rules 参数设置注解：<br>[Settings]<br>Priority=Default<br>Properties=MyCustomProperty<br>[Default]<br>OSInstall=YES <span class="hljs-regexp">//</span>是否允许部署操作系统到目标计算机<br>SkipBDDWelcome= NO <span class="hljs-regexp">//</span>是否跳过欢迎界面<br>SkipCapture= NO <span class="hljs-regexp">//</span>是否跳过镜像捕获<br>SkipDeploymentType= NO <span class="hljs-regexp">//</span>是否跳过选择部署类型<br>DeploymentType=NEWCOMPUTER<br>SkipAdminPassword= NO <span class="hljs-regexp">//</span>是否跳过设置本地管理员密码<br>adminpassword=<br>SkipAppsOnUpgrade=NO <span class="hljs-regexp">//</span>是否跳过应用程序安装向导页<br>SkipComputerName=NO <span class="hljs-regexp">//</span>是否跳过设置计算机名<br>SkipProductKey= NO <span class="hljs-regexp">//</span>是否跳过输入产品密钥<br>SkipDomainMembership=NO <span class="hljs-regexp">//</span>是否跳过加域或工作组<br>SkipComputerBackup= NO <span class="hljs-regexp">//</span>是否跳过计算机备份<br>SkipBitLocker=YES <span class="hljs-regexp">//</span>是否跳过BitLocker配置<br>SKipTaskSequence=NO <span class="hljs-regexp">//</span>是否跳过任务序列（可自定义）<br>SkipFinalSummary= NO <span class="hljs-regexp">//</span>是否跳过系统部署完成后的最后总结<br>SkipTimeZone= NO <span class="hljs-regexp">//</span>是否跳过时区和语言设置<br>TimeZoneName=China Standard Time <span class="hljs-regexp">//</span>时区<br>KeyboardLocale=zh-cn <span class="hljs-regexp">//</span>键盘区域<br>UserLocale=zh-cn <span class="hljs-regexp">//</span>用户区域<br>UILanguage=zh-cn <span class="hljs-regexp">//</span>语言<br>SkipLocaleSelection= NO <span class="hljs-regexp">//</span>是否跳过本地选择<br>SkipUserData= NO <span class="hljs-regexp">//</span>是否跳过用户数据配置<br>SkipSummary= NO <span class="hljs-regexp">//</span>是否跳过配置摘要确认<br>SLShare=\********\logs <span class="hljs-regexp">//</span>可指定部署日志存放位置，以方便日常排错<br>Bootstrap 参数设置注解：<br>[Settings]<br>Priority=Default<br>[Default]<br>DeployRoot=\<span class="hljs-number">10.0</span>.<span class="hljs-number">0.2</span>\DeploymentShare$ <span class="hljs-regexp">//</span>共享目录<br>UserID=administrator <span class="hljs-regexp">//</span>启动管理账户设置<br>UserDomain=***** <span class="hljs-regexp">//</span>启动账户所属的域<br>UserPassword=***** <span class="hljs-regexp">//</span>账户对应密码<br>KeyboardLocale=zh-cn <span class="hljs-regexp">//</span>键盘语言设置<br>SkipBDDWelcome=YES <span class="hljs-regexp">//</span>是否跳过欢迎界面<br><br>作者：强出头<br>链接：https:<span class="hljs-regexp">//</span>www.jianshu.com<span class="hljs-regexp">/p/</span><span class="hljs-number">60</span>cc9cfc3c17<br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。<br></code></pre></td></tr></table></figure></li><li><p>下面是我的rules规则，可以参考下</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Settings]</span><br><span class="hljs-attr">Priority</span>=Default<br><span class="hljs-attr">Properties</span>=MyCustomProperty<br><br><span class="hljs-section">[Default]</span><br><span class="hljs-attr">OSInstall</span>=Y<br><span class="hljs-attr">SkipCapture</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipAdminPassword</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipProductKey</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipComputerBackup</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipBitLocker</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipProductKey</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipComputerBackup</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipBitLocker</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipUserData</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipTimeZone</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipLocalSelection</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">TimeZoneName</span>=China Standard Time<br><span class="hljs-attr">KeyboardLocale</span>=zh-cn<br><span class="hljs-attr">UserLocale</span>=zh-cn<br><span class="hljs-attr">UILanguage</span>=zh-cn<br><span class="hljs-attr">SkipAppsOnUpgrade</span>=<span class="hljs-literal">NO</span><br><span class="hljs-attr">SkipApplications</span>=N0<br><span class="hljs-attr">Applications1</span>=&#123;cfa9a4cf-<span class="hljs-number">167</span>a-<span class="hljs-number">4380</span>-<span class="hljs-number">9</span>c3f-dc657377de2c&#125;<br><span class="hljs-attr">Applications2</span>=&#123;f158bf0d-facd-<span class="hljs-number">49</span>b9-<span class="hljs-number">9761</span>-<span class="hljs-number">6</span>d1207ec18b7&#125;<br><span class="hljs-attr">Applications3</span>=&#123;e5d86726-d376-<span class="hljs-number">43</span>b1-<span class="hljs-number">9484</span>-a7d2ac9af3a5&#125;<br><span class="hljs-attr">Applications4</span>=&#123;<span class="hljs-number">5490</span>fcee-<span class="hljs-number">5573</span>-<span class="hljs-number">4</span>ea1-be11-<span class="hljs-number">152</span>e3fa7137a&#125;<br><span class="hljs-attr">Applications5</span>=&#123;<span class="hljs-number">418507</span>b4-a13a-<span class="hljs-number">4119</span>-aab8-<span class="hljs-number">4</span>d413b9a8eea&#125;<br><span class="hljs-attr">Applications6</span>=&#123;d8879eda-<span class="hljs-number">9</span>a6e-<span class="hljs-number">4608</span>-ad6b-<span class="hljs-number">45</span>dd5cc0f203&#125;<br><span class="hljs-attr">Applications7</span>=&#123;<span class="hljs-number">4</span>c5e5b9d-a634-<span class="hljs-number">44</span>a2-af91-<span class="hljs-number">2092</span>da80c029&#125;<br><span class="hljs-attr">Applications8</span>=&#123;<span class="hljs-number">2</span>fa352d7-b77f-<span class="hljs-number">44</span>f1-bfc5-<span class="hljs-number">813</span>bc9b8b083&#125;<br><span class="hljs-attr">Applications9</span>=&#123;c58a59db-<span class="hljs-number">1337</span>-<span class="hljs-number">4</span>b94-<span class="hljs-number">8</span>d86-<span class="hljs-number">9</span>ab61d1d0f8e&#125;<br><span class="hljs-attr">Applications10</span>=&#123;a07efd26-fda3-<span class="hljs-number">4410</span>-<span class="hljs-number">8462</span>-<span class="hljs-number">74</span>ba1437d466&#125;<br><span class="hljs-attr">Applications11</span>=&#123;<span class="hljs-number">22</span>ae8f4d-<span class="hljs-number">439</span>d-<span class="hljs-number">437</span>f-<span class="hljs-number">97</span>be-ff5b8363d9aa&#125;<br><span class="hljs-attr">Applications12</span>=&#123;<span class="hljs-number">8</span>d4e2fef-ff16-<span class="hljs-number">4</span>fd8-bac8-<span class="hljs-number">42</span>d47b3ce8c4&#125;<br><span class="hljs-attr">Applications13</span>=&#123;<span class="hljs-number">59584478</span>-<span class="hljs-number">35</span>e1-<span class="hljs-number">4209</span>-ad37-<span class="hljs-number">30</span>c53b6261cc&#125;<br><span class="hljs-attr">SkipLocaleSelection</span>= <span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipSummary</span>= <span class="hljs-literal">YES</span><br><span class="hljs-attr">SkipUserData</span>=<span class="hljs-literal">YES</span><br><span class="hljs-attr">SLShare</span>=\\iphonefintech\Logs<br></code></pre></td></tr></table></figure><p><strong>bootstrap</strong></p></li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[Settings]</span><br><span class="hljs-attr">Priority</span>=Default<br><br><span class="hljs-section">[Default]</span><br><span class="hljs-attr">DeployRoot</span>=\\<span class="hljs-number">192.168</span>.<span class="hljs-number">135.23</span>\DeploymentShare$<br><span class="hljs-attr">userid</span>=poweruser<br><span class="hljs-attr">userdomain</span>=iphonefintech.com<br><span class="hljs-attr">userpassword</span>=Abc123456<br><span class="hljs-attr">SkipBDDWelcome</span>=<span class="hljs-literal">YES</span><br></code></pre></td></tr></table></figure><p><strong>有关自动化配置和自动化参数的都在上面了，还有更详细更自动化的要自己参考琢磨了，后续也不定期更新其中更细的内容，以上只做参考</strong></p>]]></content>
    
    
    <categories>
      
      <category>WDS+MDT</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WDS+MDT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Windows自动化装机部署（五）Task部署任务创建及磁盘分区驱动对应调整</title>
    <link href="/2022/08/31/MDT/windows_autoinstall_05/"/>
    <url>/2022/08/31/MDT/windows_autoinstall_05/</url>
    
    <content type="html"><![CDATA[<p><strong>Windows自动化部署 Task部署任务创建</strong></p><ul><li>右键Task Sequence，选择New Task Sequence<br><img src="https://upload-images.jianshu.io/upload_images/9650472-994b29f605456f3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-3db1ea17f83f8485.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-0898837159df0c84.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c7d64fc1277609f0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-3ca77032bd950723.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><ul><li><p>输入任务ID号，任务名称及描述<br><img src="https://upload-images.jianshu.io/upload_images/9650472-d9110aade509c94c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p></li><li><p>选择部署类型<br><img src="https://upload-images.jianshu.io/upload_images/9650472-d0ade92f28a59d5b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p></li><li><p>选择需要部署的操作系统<br><img src="https://upload-images.jianshu.io/upload_images/9650472-bf420536fcc8b804.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p></li><li><p>暂时不输入密钥<br><img src="https://upload-images.jianshu.io/upload_images/9650472-45d3fa37fdae5e54.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p></li><li><p>输入组织信息、主页等信息<br><img src="https://upload-images.jianshu.io/upload_images/9650472-0ab50cacc3a95f4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p></li><li><p>这边为administrator管理员创建密码</p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9fcd24b64e3e10c4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-1052847d5884bc47.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="12.png"></p><ul><li>任务创建完成<br><img src="https://upload-images.jianshu.io/upload_images/9650472-39397a85d110ab62.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="13.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-fb95b9c1ce419383.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15856556031340.png"></p><p><strong>Task任务创建完成后，我们肯定对Task Sequence选项中涉及到的诸多个性化设置很感兴趣，本章中暂不做细化界面介绍。为了后续部署操作的顺利进行，我们需要对部署系统进行磁盘分区及分区格式化调整。接下来我们就来了解一下对应设置的相关配置步骤及注意事项：<br>生产环境中，我们一般有两种需求：一种是全盘格式化进行全新安装；另一种是只格式化系统盘数据，保留其他分区资料信息等；其实不管哪种部署方式我们都需要关注数据的安全性，生产环境中永远把数据安全放在第一位才是王道（注：在很多公司做此类项目的时候总有那么几台本来设置只格式系统盘，但是安装完成后会发现是全盘格式化，暂时未找到根源，所以还是建议大家做好数据备份，相关资料最好日常使用的时候在非系统盘做好备份，同时在安装操作系统的时候对重要数据进行移动外置介质备份，做到防患于未然。）</strong></p><p><strong>磁盘分区调整</strong><br><strong>- 双硬盘</strong> </p><ul><li><p>单击新建任务序列，右键选择属性<br><img src="https://upload-images.jianshu.io/upload_images/9650472-0ef98e32fbba0522.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p></li><li><p>Enable this task sequence ：部署引导过程中显示此task任务</p></li><li><p>Hide this task sequence in the Deployment wizard ：不显示此Task任务<br><img src="https://upload-images.jianshu.io/upload_images/9650472-62c5ca515415533d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p></li><li><p>选择Task Sequence选项<br><img src="https://upload-images.jianshu.io/upload_images/9650472-5ad5d8f26542a8c4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p></li><li><p>依次展看Preinstall —New Computer only—Format and Partition Disk<br><img src="https://upload-images.jianshu.io/upload_images/9650472-06b7a9af08144ebe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p></li><li><p>这里MBR格式的我拿来做机械硬盘对半分区<br><img src="https://upload-images.jianshu.io/upload_images/9650472-9e86218a55c04dd5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p></li><li><p>新建一个分区</p></li><li><p>partition name ：磁盘名字</p></li><li><p>Size：分磁盘空间的50%，剩下的给另一个磁盘就是100%<br><img src="https://upload-images.jianshu.io/upload_images/9650472-d679e0e749c54372.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-185ef97c6ddf34a3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p><ul><li><p>分区创建完成后分区信息如下：</p></li><li><p>disk number：机械硬盘我接的是SATA1 这里对应填的就是1</p></li><li><p>disk type : 机械硬盘我采用了MBR格式分区<br><img src="https://upload-images.jianshu.io/upload_images/9650472-c867ad284242d943.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p></li><li><p>固态硬盘的分区，我这里固态硬盘240G全给了做系统，就不做任何改变</p></li><li><p>disk number：固态硬盘我接的是SATA0，这里也就选择0</p></li><li><p>disk type : 固态硬盘的系统我采取用UEFI模式启动，这里就选择GPT模式<br><img src="https://upload-images.jianshu.io/upload_images/9650472-f53319f0ccd86dce.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p></li><li><p>勾选Disable this step 可以防止格式化<br><img src="https://upload-images.jianshu.io/upload_images/9650472-3b94231de902fbe5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p></li></ul><p><strong>单硬盘分区</strong></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-b4cb8eab4d4a6f9d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-d24e2358f4ee6e8c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a58bd7d247789674.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-f4506052c13e9970.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-990081a69265d9e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><p><strong>机型驱动调整</strong> </p><ul><li>这里要选相对应的机型的驱动，驱动是我们之前创建好的，在前面的章节有。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-c87161c24c730bfe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c7d52d907f26a15c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-34387204dab762cd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p>磁盘分区就介绍到这里了。</p>]]></content>
    
    
    <categories>
      
      <category>WDS+MDT</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WDS+MDT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Windows自动化装机部署（三）镜像驱动程序导入</title>
    <link href="/2022/08/31/MDT/windows_autoinstall_03/"/>
    <url>/2022/08/31/MDT/windows_autoinstall_03/</url>
    
    <content type="html"><![CDATA[<p>在上文配置好WDS、MDT控制台后，接下来我们就可以开始我们后续的分目录导入OS映像、各系统版本驱动、软件。</p><p><strong>一、目录结构创建：</strong></p><ul><li>打开MDT控制台</li><li>右键operating system选择New Folder</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9ed7fcf5d19de793.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p><ul><li>根据实际环境输入目录名称<br><img src="https://upload-images.jianshu.io/upload_images/9650472-589a5599bd898431.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-e62ca9e5bc443902.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-8d1de2d157397ae8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><ul><li>创建完成后控制台信息如下<br><img src="https://upload-images.jianshu.io/upload_images/9650472-2d9feab0e43dcd0e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></li></ul><p><strong>二、导入镜像</strong></p><ul><li><p>选中对应文件夹，右键“Import Operating System”<br><img src="https://upload-images.jianshu.io/upload_images/9650472-96805b85d4e17055.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p></li><li><p>这里我选择“Full set of source files”,可根据自己实际情况选择。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-401f4c67196ddd9e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-8dafc8f427713fb0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a17feb3af0498e52.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p><ul><li>输入操作系统描述名称<br><img src="https://upload-images.jianshu.io/upload_images/9650472-5361fd3fe32aab2c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9e9c2c9cbf0ce1bf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p><ul><li><p>导入镜像完成<br><img src="https://upload-images.jianshu.io/upload_images/9650472-60b1d4a1d54bdd77.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="12.png"></p></li><li><p>导入后控制台显示<br><img src="https://upload-images.jianshu.io/upload_images/9650472-b009923ebaccb78a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="13.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-d318acd275111aca.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="14.png"></p><p><strong>三、下载对应机型驱动程序：</strong></p><ul><li><p>以Dell 3046 主机为例</p></li><li><p><a href="https://www.dell.com/support/article/zh-cn/sln312414/dell-command-deploy-driver-packs-for-enterprise-client-os-deployment">Dell 驱动程序下载</a></p></li><li><p>ctrl+F 搜索<br><img src="https://upload-images.jianshu.io/upload_images/9650472-93730e478de24476.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p></li><li><p>下载<br><img src="https://upload-images.jianshu.io/upload_images/9650472-b7c66dff17904cda.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p></li><li><p>解压到文件夹<br><img src="https://upload-images.jianshu.io/upload_images/9650472-a88196eec71ab92d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p></li></ul><p><strong>四、导入驱动程序：</strong></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-ee71acbfe2be102b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-3614a28a124dda16.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-f2129f1f6eb8986b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9995f55222972463.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-10c2fa85efec1883.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-dfc2910c8ffe0d32.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-caa8db3d919fe8c5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-24d0139008459db8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p><ul><li>导入后驱动视图与目录相对应<br><img src="https://upload-images.jianshu.io/upload_images/9650472-5e0d425221332ef1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></li></ul><p><strong>五、建立每个机型驱动包文件：</strong></p><ul><li>新建profile<br><img src="https://upload-images.jianshu.io/upload_images/9650472-2bcd8eec736abbe8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></li><li>命名相对应机型的驱动<br><img src="https://upload-images.jianshu.io/upload_images/9650472-9e53d055aead076f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></li><li>选择已导入的相对应驱动<br><img src="https://upload-images.jianshu.io/upload_images/9650472-1a5cebf0092a4846.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-0a6db69cc4f550bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-04fd81f64a5be2af.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><ul><li>刷新后查看导入成功<br><img src="https://upload-images.jianshu.io/upload_images/9650472-4882fddf0cab080c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></li></ul><p><strong>生产或测试环境中，我们可能在控制台建立对应的分类目录后，在最终生成的目录中是按MDT自己的命名规则去分类的，新建每个机型相对应的驱动程序包，方便后续每个机型安装系统驱动都是相对应的。</strong></p>]]></content>
    
    
    <categories>
      
      <category>WDS+MDT</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WDS+MDT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Windows自动化装机部署（四）软件参数设置及导入</title>
    <link href="/2022/08/31/MDT/windows_autoinstall_04/"/>
    <url>/2022/08/31/MDT/windows_autoinstall_04/</url>
    
    <content type="html"><![CDATA[<p><strong>上一章我们已经对OS映像及分类导入驱动信息做了介绍，这一章我们针对自动化安装软件设置软件的参数</strong></p><p><strong>常用软件静默安装参数</strong><br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs bash">1. .msi 格式<br>msiexec.exe /i ActiveSync.msi /quiet /norestart<br><br>2. .msp 格式<br>msiexec.exe /p hotfix.msp /quiet /norestart<br><br>3. 系统运行库<br>        ○ Visual C++ 2008 (VC8)解压出来得到msi文件 (官方下载的是exe文件，通过.exe /?查询也是/Q，但部署/Q和/q均报错，所以用解压部署的方法)<br>        ○ Visual C++ 2009(VC9).exe /q<br>        ○ Visual C++ 2010 (VC10).exe /q<br>        ○ Microsoft .NET Framework 1.1解压出来得到msi文件 (官方下载的是exe文件，通过.exe /?查询也是/Q，但部署/Q和/q均报错，所以用解压部署的方法)<br>        ○ Microsoft .NET Framework 2.0.exe /q<br>        ○ Microsoft .NET Framework 3.0.exe /q<br>        ○ Microsoft .NET Framework 3.5.exe /q<br>        ○ Microsoft .NET Framework 4.0.exe /q<br><br>4. 系统常用<br>        ○ Windows补丁，通常都是/quiet /norestart即可。如WindowsXP-KB915865-v11-x86-CHS.exe<br>        ○<br>        ○ WinRAR.exe /S<br>        ○ 7-ZIP.exe /S<br>        ○ Google拼音.exe /S<br>        ○ 搜狗拼音.exe /S<br>        ○ 驱动精灵2012.exe /S<br>        ○ CPU-Z v1.60 官方中文安装版.exe /S<br>        ○ Google Picasa v3.9.135.93 官方简体中文版.exe /S<br>        ○ 迅雷看看播放器 v4.8.8.966.exe /S<br>        ○ 网易有道桌面词典 5.0 正式版.exe /S<br>        ○ 微软雅黑字体<span class="hljs-keyword">for</span> XP.exe /Q<br>        ○ VMware-workstation-full-8.0.2-591240.exe /silent /noSilentReboot<br><br>5. 即时通讯<br>        ○ 阿里旺旺淘宝买家版 2011 正式版 SP1.exe /S<br>        ○ 飞信 2012 贺岁版 v4.7.0.exe /S<br>        ○ 腾讯 QQ 2011 正式版.exe /S<br>        ○ 腾讯 TM 2009 Beta v3.3.exe /S<br>        ○ 腾讯通 RTX 2011 正式版.exe /S<br><br>6. 文字办公<br>        ○ Office 2003 Professional<br>方法1：<br>对office2003原始安装光盘进行重新封装（也称：管理员安装方式），使其支持网络安装。运行原始安装光盘下的Setup.exe /a，然后输入序列号，选择一个文件夹作为office安装点。（如在硬盘上的d:\office）<br><br>运行msiexec.exe /i Pro11.msi /quiet /norestart即可<br>方法2：<br>Step3：制作定制安装的MST文件：运行office 2003 resource kit工具的Custom Installation Wizard，创建一个对应的MST文件，存放在Office 2003目录下。（在setup和pro11.msi文件同一目录）<br>msiexec.exe /a pro11.msi /p setup.msp<br>        ○ Office 2003 兼容包<br>FileFormatConverters.exe /quiet /norestart<br><br>        ○ Office System 2007 /Office System 2010  (包括Project/Visio)<br>运行setup.exe /admin，用Office 2007自定义工具生成.msp文件（包含同意许可协议、序列号、注册信息、显示级别等内容），msp文件名字可随意取。(下图 为：Auto_Office_2007.msp，其它的msp是Office 2007 Service Pack 3运行/extract后解压出来的安装文件)<br><br>将定制后的msp放到Office 2007/2010的Updates目录后，运行根目录下的setup.exe 即可实现全自动安装（office 2007/2010的Service Pack补丁包同样适用，放入Updates目录即可）<br>另外要集成Office 2007或2010的Service Pack，只需要运行Service Pack的exe安装程序后加/extract参数到Office 的Updates目录即可。<br>        ○ Adobe PDF Reader v9.1.exe /sAll<br>        ○ Adobe Acrobat X Pro v10.1.0<br>解压出来，得到msi文件，msiexec.exe /i AcroPro.msi /quiet /norestart<br>        ○ Foxit PDF Reader v5.1.0.1117.exe /S<br>        之前的版本是 -i<br>        ○ Foxmail.exe 6.0.exe /sp- /verysilent /norestart<br>        ○ Google金山词霸.exe  /S<br><br>7. 网络与安全<br>        ○ 微软TMG防火墙客户端<br>msiexec.exe /i TMGClient.msi  ENABLE_AUTO_DETECT=1 REFRESH_WEB_PROXY=1 /quiet /norestart<br>        ○ Adobe Flash Player ActiveX <span class="hljs-keyword">for</span> IE v11.3<br>10之前的版本好像是/S，之后的版本通过查询注册表得知静默安装是/install，卸载是-maintain activex<br>        ○  IE 8<br>IE8-WindowsXP-x86-CHS.exe /quiet /update-no /promptrestart<br>        ○ Microsoft Security Essential (MSE)<br>mseinstall_xp_v2.1.1116.exe /s /q /o /runwgacheck<br>        ○ 360安全卫士.exe  /S<br>        ○ 超级兔子.exe  /S<br>        ○ PPLive.exe /S<br>        ○ 迅雷.exe  /S<br><br>8. 手机相关<br>        ○ 91手机助手<br>需要Microsoft .NET Framework 2.0，msiexec.exe /i netfs.msi  /quiet /norestart<br>91mobilesetup_v3.1.8.583.exe /sp- /verysilent /norestart<br>        ○  iTunes<br>解压出来均是msi格式文件，只需要注意参考下面的安装顺序即可<br>(1) AppleApplicationSupport.msi<br>(2) AppleMobileDeviceSupport.msi<span class="hljs-string">&quot;</span><br><span class="hljs-string">(3) AppleSoftwareUpdate.msi&quot;</span><br>(4) Bonjour.msi<span class="hljs-string">&quot;</span><br><span class="hljs-string">(5) iTunes.msi&quot;</span><br>        ○ Nokia 套件<br>同理解压出来均是msi文件，顺序：<br>(1) Packages\CCD\Setup\Nokia_Connectivity_Cable_Driver.msi<br>(2) Packages\PCCS\Setup\PCCS.msi<br>(3) Packages\VC80_x86\Setup\VC80_x86_v2.msi  或 Packages\VC80_x64\Setup\VC80_x64_v2.msi<br>(4) Packages\Nokia_Suite\Setup\Nokia_Suite.msi<br><br>9. 设计类<br>        ○ AutoCAD 2004/AuctoCAD 2007<br>找到AutoCAD\ACAD.msi文件,参数为<br>msiexec.exe /i  acad.msi ACADSERIALPREFIX=&lt;序列号前缀:111&gt; ACADSERIALNUMBER=&lt;序列号:20111111&gt;  ACADFIRSTNAME=&lt;注册者姓&gt; ACADLASTNAME=&lt;注册者名&gt; ACADORGANIZATION=&lt;注册单位&gt;  ACADDEALER=&lt;经销商&gt;  ACADDEALERPHONE=&amp; lt;经销商电话12345&gt;  /quiet<br>        ○ Google SketchUp v8.0.11752 中文免费版<br>解压得到msi<br>        ○ CorelDraw 较老版本：<br>Setup32.exe /silent（很少界面的静默安装）；新版本是MSI<br></code></pre></td></tr></table></figure></p><p><strong>一、软件导入</strong></p><ul><li>应用程序建立文件夹<br><img src="https://upload-images.jianshu.io/upload_images/9650472-743eb760da948203.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></li><li>对应文件夹名称<br><img src="https://upload-images.jianshu.io/upload_images/9650472-f2ca09bd8463baf7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-dcb14770b6fe25cf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-8f458d67bdedc0c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><ul><li>新建New Application导入软件应用<br><img src="https://upload-images.jianshu.io/upload_images/9650472-c7a4f72929964ada.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-95ee9544f848c1b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><ul><li><p>指定版本、名称和语言<br><img src="https://upload-images.jianshu.io/upload_images/9650472-fe2123e12a4cedd0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p></li><li><p>选择应用程序存放目录位置<br><img src="https://upload-images.jianshu.io/upload_images/9650472-4b0834e42d2d9848.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-82c212b5b551901b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p><ul><li><p>即将创建的目录名称<br><img src="https://upload-images.jianshu.io/upload_images/9650472-23f60b9f67718467.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p></li><li><p>应用程序执行安装命令<br><img src="https://upload-images.jianshu.io/upload_images/9650472-162570e5514c4b3a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-ec739ee1768e40cb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="12.png"></p><ul><li><p>完成应用程序的添加<br><img src="https://upload-images.jianshu.io/upload_images/9650472-78f1c3f2ca653043.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="13.png"></p></li><li><p>相对应的文件夹下也捕获到了应用程序<br><img src="https://upload-images.jianshu.io/upload_images/9650472-a2f98e63115c7d3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_1585647070184.png"></p></li><li><p>双击新添加Application查看对应属性如下<br><img src="https://upload-images.jianshu.io/upload_images/9650472-4cc0f047825a9ec5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="14.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-b64647ba7b50db3b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="15.png"></p><p><strong>到这里我们就完成了应用程序的导入安装，前提下可以在电脑设置好默认参数，编写成bat脚本去跑一编，确定没问题了，在放到mdt上去，静默安装参数可以参考上面。</strong></p>]]></content>
    
    
    <categories>
      
      <category>WDS+MDT</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WDS+MDT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Windows自动化装机部署（二）MDT环境准备</title>
    <link href="/2022/08/31/MDT/windows_autoinstall_02/"/>
    <url>/2022/08/31/MDT/windows_autoinstall_02/</url>
    
    <content type="html"><![CDATA[<p><strong>1.下载并安装 Windows ADK</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-ca7987e1a2ae5828.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p><ul><li>这里我选择默认路径，也可以选其他路径<br><img src="https://upload-images.jianshu.io/upload_images/9650472-2ca55395a29a2116.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-750445ef0ed35b4c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-d456b420e0347672.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p><ul><li><p>可根据实际需求选择所要安装的功能<br><img src="https://upload-images.jianshu.io/upload_images/9650472-2a2ef7e136a35f37.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p></li><li><p>暂时不启动”开始指南”<br><img src="https://upload-images.jianshu.io/upload_images/9650472-4d5f5aa79627f016.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="07.png"></p></li></ul><p><strong>2.下载并安装MDT2013</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-c44abeb5067abb4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-734e278c081e01cc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-e430026d81bfe300.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><ul><li>暂时不加入，直接选择“Next”<br><img src="https://upload-images.jianshu.io/upload_images/9650472-a638fd8be3b53a4f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-085fc4832b7694d6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-0ccea74530097786.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></p><p><strong>服务器端：AD、DNS、DHCP<br>客户端：MDT、WDS、ADK 8.1<br>服务端与客户端所需的环境准备条件到此完成。<br>在设置准备好MDT环境后，我们需要对MDT、WDS等进行首次使用的简单设置，以方便后续OS、驱动等的导入及分发部署。</strong></p><p><strong>3.windows部署服务配置</strong></p><ul><li>打开windows部署服务控制台</li><li>右键MDT服务器，选择配置服务器<br><img src="https://upload-images.jianshu.io/upload_images/9650472-697f8d9e7353f2bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-de86241647878fa5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-ed0b3acb10c364fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-7e9822fbe7378976.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-22b47c0941b3329a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p><ul><li><p>配置界面<br><img src="https://upload-images.jianshu.io/upload_images/9650472-a0a2d89af05ca950.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p></li><li><p>WDS控制台配置好后会在安装后指定文件下生成相应的文件目录<br><img src="https://upload-images.jianshu.io/upload_images/9650472-c53780da6d3f7232.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p></li></ul><p><strong>4.MDT服务台配置</strong></p><ul><li>打开 MDT 控制台“Deployment Workbench”并新建<br><img src="https://upload-images.jianshu.io/upload_images/9650472-0bb3dd3e4ee4887d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-8c93a6a9e4526d5d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><ul><li><p>指定网络共享路径，可以自定义设置。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-9f29bc16ad79e33e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p></li><li><p>设置共享名称<br><img src="https://upload-images.jianshu.io/upload_images/9650472-64a19a86afdd5896.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p></li><li><p>设置共享描述<br><img src="https://upload-images.jianshu.io/upload_images/9650472-fb94d290710eb76b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p></li><li><p>相关选项，可根据需要勾选，这里全不选。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-6b1acd8739d8df9b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-dd7f115f8bf9d72b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="07.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-3fbefdb4e558c32d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="08.png"></p><ul><li><p>配置完成后视图如下，互相对应的<br><img src="https://upload-images.jianshu.io/upload_images/9650472-759e9a91897f6a10.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="09.png"></p></li><li><p>各目录互相对应的信息<br><img src="https://upload-images.jianshu.io/upload_images/9650472-69c8323975b7385a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="010.png"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>WDS+MDT</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WDS+MDT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux系统磁盘划分、物理卷、卷组、逻辑卷建立以及扩容挂载自启动</title>
    <link href="/2022/08/31/Linux/Linux_extend/"/>
    <url>/2022/08/31/Linux/Linux_extend/</url>
    
    <content type="html"><![CDATA[<h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><p><strong>1、物理卷(pvcreate):通常一个分区或者一个硬盘就可以建立一个物理卷，物理卷的最小单位是PE,一般默认是4MB。</strong></p><p><strong>2、卷组(vgcreate):用于创建LVM卷组。卷组（Volume Group）将多个物理卷组织成一个整体，屏蔽了底层物理卷细节。在卷组上创建逻辑卷时不用考虑具体的物理卷信息。</strong></p><p><strong>3、逻辑卷(lvcreate):用于创建LVM的逻辑卷。逻辑卷是创建在卷组之上的。逻辑卷对应的设备文件保存在卷组目录下，例如：在卷组”vg1000”上创建一个逻辑卷”lvol0”，则此逻辑卷对应的设备文件为”&#x2F;dev&#x2F;vg1000&#x2F;lvol0”。</strong></p><h2 id="实验开始"><a href="#实验开始" class="headerlink" title="实验开始"></a>实验开始</h2><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs livescript">[root@server ~]<span class="hljs-comment"># fdisk -l /dev/sdb</span><br>Disk /dev/sdb: <span class="hljs-number">20</span> GiB, <span class="hljs-number">21474836480</span> bytes, <span class="hljs-number">41943040</span> sectors<br>Units: sectors <span class="hljs-keyword">of</span> <span class="hljs-number">1</span> * <span class="hljs-number">512</span> = <span class="hljs-number">512</span> bytes<br>Sector size (logical<span class="hljs-regexp">/physical): 512 bytes /</span> <span class="hljs-number">512</span> bytes<br>I<span class="hljs-regexp">/O size (minimum/optimal): 512 bytes /</span> <span class="hljs-number">512</span> bytes<br>Disklabel type: dos<br>Disk identifier: <span class="hljs-number">0x1a726657</span><br>[root@server ~]<span class="hljs-comment"># </span><br><span class="hljs-comment">#分了两个主分区各10G</span><br>[root@server ~]<span class="hljs-comment"># fdisk /dev/sdb</span><br>Device     Boot    Start      End  Sectors Size Id Type<br>/dev/sdb1           <span class="hljs-number">2048</span> <span class="hljs-number">20973567</span> <span class="hljs-number">20971520</span>  <span class="hljs-number">10</span>G <span class="hljs-number">83</span> Linux<br>/dev/sdb2       <span class="hljs-number">20973568</span> <span class="hljs-number">41943039</span> <span class="hljs-number">20969472</span>  <span class="hljs-number">10</span>G <span class="hljs-number">83</span> Linux<br><br><span class="hljs-comment">#创建物理卷</span><br>[root@server ~]<span class="hljs-comment"># pvcreate /dev/sdb1 /dev/sdb2</span><br>WARNING: dos signature detected <span class="hljs-literal">on</span> /dev/sdb2 at offset <span class="hljs-number">510.</span> Wipe <span class="hljs-literal">it</span>? [y/n]: y<br>  Wiping dos signature <span class="hljs-literal">on</span> /dev/sdb2.<br>WARNING: atari signature detected <span class="hljs-literal">on</span> /dev/sdb2 at offset <span class="hljs-number">466.</span> Wipe <span class="hljs-literal">it</span>? [y/n]: y<br>  Wiping atari signature <span class="hljs-literal">on</span> /dev/sdb2.<br>  Physical volume <span class="hljs-string">&quot;/dev/sdb1&quot;</span> successfully created.<br>  Physical volume <span class="hljs-string">&quot;/dev/sdb2&quot;</span> successfully created.<br>[root@server ~]<span class="hljs-comment"># </span><br><span class="hljs-comment">##查看创建是否成功</span><br>[root@server ~]<span class="hljs-comment"># pvscan</span><br>  PV <span class="hljs-regexp">/dev/sda2   VG rhel_server     lvm2 [&lt;19.00 GiB /</span> <span class="hljs-number">0</span>    free]<br>  PV /dev/sdb1                      lvm2 [<span class="hljs-number">10.00</span> GiB]<br>  PV /dev/sdb2                      lvm2 [&lt;<span class="hljs-number">10.00</span> GiB]<br>  Total: <span class="hljs-number">3</span> [&lt;<span class="hljs-number">39.00</span> GiB] / <span class="hljs-keyword">in</span> use: <span class="hljs-number">1</span> [&lt;<span class="hljs-number">19.00</span> GiB] / <span class="hljs-keyword">in</span> <span class="hljs-literal">no</span> VG: <span class="hljs-number">2</span> [&lt;<span class="hljs-number">20.00</span> GiB]<br><br><span class="hljs-comment">##将物理卷添加到卷组，这里暂时只添加了/dev/sdb1的一个分区</span><br>[root@server ~]<span class="hljs-comment"># vgcreate vg1 /dev/sdb1</span><br>  Volume group <span class="hljs-string">&quot;vg1&quot;</span> successfully created<br><br><span class="hljs-comment">##pvs查看加入的情况</span><br>[root@server ~]<span class="hljs-comment"># pvs</span><br>  PV         VG          Fmt  Attr PSize   PFree  <br>  /dev/sda2  rhel_server lvm2 a--  &lt;<span class="hljs-number">19.00g</span>      <span class="hljs-number">0</span> <br>  /dev/sdb1  vg1         lvm2 a--  &lt;<span class="hljs-number">10.00g</span> &lt;<span class="hljs-number">10.00g</span><br>  /dev/sdb2              lvm2 ---  &lt;<span class="hljs-number">10.00g</span> &lt;<span class="hljs-number">10.00g</span><br><br><span class="hljs-comment">#在卷组Vg1下创建data并分配8G空间给到逻辑data</span><br>[root@server ~]<span class="hljs-comment"># lvcreate -n data -L 8G vg1</span><br>WARNING: ext4 signature detected <span class="hljs-literal">on</span> /dev/vg1/data at offset <span class="hljs-number">1080.</span> Wipe <span class="hljs-literal">it</span>? [y/n]: y<br>  Wiping ext4 signature <span class="hljs-literal">on</span> /dev/vg1/data.<br>  Logical volume <span class="hljs-string">&quot;data&quot;</span> created.<br>[root@server ~]<span class="hljs-comment"># </span><br><span class="hljs-comment">#将磁盘格式化为ext4类型</span><br>[root@server ~]<span class="hljs-comment"># mkfs.ext4 /dev/vg1/data</span><br>mke2fs <span class="hljs-number">1.44</span>.<span class="hljs-number">3</span> (<span class="hljs-number">10</span>-July-<span class="hljs-number">2018</span>)<br>Creating filesystem <span class="hljs-keyword">with</span> <span class="hljs-number">2097152</span> <span class="hljs-number">4k</span> blocks <span class="hljs-keyword">and</span> <span class="hljs-number">524288</span> inodes<br>Filesystem UUID: <span class="hljs-number">3e</span>9d17d5-f6f8-<span class="hljs-number">459e</span>-bcdc-b0a4805fffbf<br>Superblock backups stored <span class="hljs-literal">on</span> blocks: <br><span class="hljs-number">32768</span>, <span class="hljs-number">98304</span>, <span class="hljs-number">163840</span>, <span class="hljs-number">229376</span>, <span class="hljs-number">294912</span>, <span class="hljs-number">819200</span>, <span class="hljs-number">884736</span>, <span class="hljs-number">1605632</span><br><br>Allocating group tables: done                            <br>Writing inode tables: done                            <br>Creating journal (<span class="hljs-number">16384</span> blocks): done<br>Writing superblocks <span class="hljs-keyword">and</span> filesystem accounting information: done <br>[root@server ~]<span class="hljs-comment"># </span><br><br><span class="hljs-comment">##然后挂载就可以使用了</span><br>[root@server ~]<span class="hljs-comment"># mount /dev/vg1/data /root/data</span><br>[root@server ~]<span class="hljs-comment"># df -Th | grep data</span><br>/dev/mapper/vg1-data         ext4      <span class="hljs-number">7.9</span>G   <span class="hljs-number">36</span>M  <span class="hljs-number">7.4</span>G   <span class="hljs-number">1</span>% /root/data<br><br><span class="hljs-comment">##假如data空间不够用了，这时候就要开始扩容了，将/dev/sdb2加入卷组Vg1</span><br>[root@server ~]<span class="hljs-comment"># vgextend vg1 /dev/sdb2</span><br>  Volume group <span class="hljs-string">&quot;vg1&quot;</span> successfully extended<br><span class="hljs-comment">##查看剩余空间</span><br>[root@server ~]<span class="hljs-comment"># vgs</span><br>  VG          <span class="hljs-comment">#PV #LV #SN Attr   VSize   VFree </span><br>  rhel_server   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">0</span> wz--n- &lt;<span class="hljs-number">19.00g</span>     <span class="hljs-number">0</span> <br>  vg1           <span class="hljs-number">2</span>   <span class="hljs-number">1</span>   <span class="hljs-number">0</span> wz--n-  <span class="hljs-number">19.99g</span> <span class="hljs-number">11.99g</span><br><br><span class="hljs-comment">#在线扩容将data增加多5G的空间</span><br>[root@server ~]<span class="hljs-comment"># lvextend /dev/vg1/data -L +5G</span><br>  Size <span class="hljs-keyword">of</span> logical volume vg1/data changed <span class="hljs-keyword">from</span> <span class="hljs-number">8.00</span> GiB (<span class="hljs-number">2048</span> extents) <span class="hljs-keyword">to</span> <span class="hljs-number">13.00</span> GiB (<span class="hljs-number">3328</span> extents).<br>  Logical volume vg1/data successfully resized.<br>[root@server ~]<span class="hljs-comment"># lvs</span><br>  LV   VG          Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert<br>  root rhel_server -wi-ao---- &lt;<span class="hljs-number">17.00g</span>                                                    <br>  swap rhel_server -wi-ao----   <span class="hljs-number">2.00g</span>                                                    <br>  data vg1         -wi-ao----  <span class="hljs-number">13.00g</span>   <br><br><span class="hljs-comment">#因为扩容后没有格式化所以在文件系统上查看不到</span><br>[root@server ~]<span class="hljs-comment"># df -Th | grep data</span><br>/dev/mapper/vg1-data         ext4      <span class="hljs-number">7.9</span>G   <span class="hljs-number">36</span>M  <span class="hljs-number">7.4</span>G   <span class="hljs-number">1</span>% /root/data<br><br><span class="hljs-comment">#将扩容的空间加入到data文件系统上, resize2fs :针对文件系统ext2 ext3 ext4  xfs_growfs:针对文件系统xfs </span><br><br>[root@server ~]<span class="hljs-comment"># resize2fs /dev/vg1/data</span><br>resize2fs <span class="hljs-number">1.44</span>.<span class="hljs-number">3</span> (<span class="hljs-number">10</span>-July-<span class="hljs-number">2018</span>)<br>Filesystem at /dev/vg1/data <span class="hljs-keyword">is</span> mounted <span class="hljs-literal">on</span> /root/data; <span class="hljs-literal">on</span>-line resizing required<br>old_desc_blocks = <span class="hljs-number">1</span>, new_desc_blocks = <span class="hljs-number">2</span><br>The filesystem <span class="hljs-literal">on</span> /dev/vg1/data <span class="hljs-keyword">is</span> now <span class="hljs-number">3407872</span> (<span class="hljs-number">4k</span>) blocks long.<br><br>[root@server ~]<span class="hljs-comment"># df -Th | grep data</span><br>/dev/mapper/vg1-data         ext4       <span class="hljs-number">13</span>G   <span class="hljs-number">40</span>M   <span class="hljs-number">13</span>G   <span class="hljs-number">1</span>% /root/data<br>[root@server ~]<span class="hljs-comment"># </span><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kickstart</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Windows自动化装机部署（一）WDS环境准备</title>
    <link href="/2022/08/31/MDT/windows_autoinstall_01/"/>
    <url>/2022/08/31/MDT/windows_autoinstall_01/</url>
    
    <content type="html"><![CDATA[<h1 id="整个流程的图吗，个人觉得很清晰，网络上找到。-重要！！"><a href="#整个流程的图吗，个人觉得很清晰，网络上找到。-重要！！" class="headerlink" title="整个流程的图吗，个人觉得很清晰，网络上找到。(重要！！)"></a><strong>整个流程的图吗，个人觉得很清晰，网络上找到。(重要！！)</strong></h1><p><img src="/img/MDT/MDT_01.jpg"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-1defde2ccc6e5a8f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15852809188763.png"></p><p>AD（DC）:Windows部署服务器必须是Ad域的成员，或者域控制器，在这里我们的WDS是属于域成员。<br>DNS：网络中需要有效的DNS服务器<br>DHCP:windows部署服务依靠DHCP进行IP寻址PXE，因此网络中必须要有有效的DHCP服务器，在我们这里DHCP设置在思科交换机中。<br>WDS:Windows 部署服务（Window Deployment Services）<br>MDT：MicrosoftDeploymentToolkit，系统部署工具</p><p><strong>一、 安装准备</strong></p><p>首先介绍本次项目所涉及到的内容：</p><p> <strong>MDT</strong> <br>    Microsoft Deployment Toolkit 2012（简称MDT 2012）是<a href="http://baike.baidu.com/view/2353.htm">微软</a>最新一代部署工具，通过它可以自动完成<a href="http://baike.baidu.com/view/79807.htm">桌面</a>和服务器部署的推荐操作进程和工具，MDT主要是为大型或者中型企业部署windows 系列操作系统的部署工具，用MDT部署能大大减少系统管理员的工作，提高系统稳定性，安全性和持续的配置管理，以及方便统一大量部署。</p><p>MDT 2012新增功能：<br>可以从任何地方通过网络访问部署状况，跨区域复制文件或是进行系统设置；<br>为组织管理驱动、操作系统、应用、软件包和任务进程提供了改进的用户界面；</p><p><strong>必要组件</strong></p><p>windows ADK<br>     Windows 评估和部署工具包 (Windows ADK) 是一组可用来自定义 Windows pc和 Windows Server 操作系统并将其部署到新的计算机和服务器的工具和文档。 <br>**WDS **<br>   Windows deploy sever (windows 部署服务 WDS) 是 windows Server 2008 中部署OS（操作系统）的一个利器，顾名思义WDS 是针对大容量部署操作系统而设置的（部署是针对批量操作系统的安装，有的时候还需要考虑设置相同的桌面环境，这个角色是通过网络来安装操作系统，这样可以避免亲自在每台机器上做操作，而且还省去了通过光盘（这么不环保的”东西”）来安装操作系统的过程。 </p><p><strong>MDT与WDS的区别：</strong><br>    MDT是一款最新部署工具，其中他的自动部署和应用、软件包任务序列是它的亮点，它可以将以上的应用和软件包集成到系统，最后加上他的完美自动部署脚本使整个部署简单化，既省时又方便管理。<br>WDS他也可以进行部署操作系统，只是单一将OS，软件等加载进去，最后还是需要人为干预进行部署。<br>现在将两者结合起来，基本可以实现所需功能，由于MDT不能单独引导PXE启动，而WDS有为客户机提供PXE引导的功能，因此所以选择了WDS+MDT模式。</p><p>MDT工具我选择MDT2013  下载地址：<a href="https://www.microsoft.com/en-us/download/details.aspx?id=48595">https://www.microsoft.com/en-us/download/details.aspx?id=48595</a><br>ADK win10  下载地址：<a href="https://docs.microsoft.com/zh-cn/windows-hardware/get-started/adk-install">https://docs.microsoft.com/zh-cn/windows-hardware/get-started/adk-install</a></p><p>1.<strong>机子需要加域</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-f6cccd28417ad7bf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15853033032537.png"></p><p><strong>2.添加Windows部署服务及 .NET Framework3.5 功能</strong></p><ul><li>放个镜像包然后装载后续会用到<br><img src="https://upload-images.jianshu.io/upload_images/9650472-5b817346e1846d8f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-78ca552835f45cf8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-f85804f2dd6b862e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-6328bad54c7a9ddf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-7c786ddc5da2a415.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9cc5aee7d92baeaa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a38c569c9f2326d2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-407dd69e774a8dd2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-72c9dc4849158391.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-65b24dc9a442c0da.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-420dcebddd016e73.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15853941264482.png"></p>]]></content>
    
    
    <categories>
      
      <category>WDS+MDT</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WDS+MDT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pxe+Dhcp+Httpd+Tftp+Kickstart搭建无人值守服务器</title>
    <link href="/2022/08/31/Linux/kickstart/"/>
    <url>/2022/08/31/Linux/kickstart/</url>
    
    <content type="html"><![CDATA[<h2 id="原理和概念"><a href="#原理和概念" class="headerlink" title="原理和概念"></a>原理和概念</h2><ul><li><p><strong>PXE</strong> ：Pxe并不是一种安装方式，而是一种引导的方式，进行 PXE 安装的必要条件是要安装的计算机中包含一个 PXE 支持的网卡（NIC），即网卡中必须要有 PXE Client。PXE （Pre-boot Execution Environment）协议使计算机可以通过网络启动，简而言之就是引导从网络中下载系统来安装。</p></li><li><p><strong>Dhcp</strong>: 用来给 客户端（将要安装系统的主机）分配IP 地址。</p></li><li><p><strong>Httpd</strong>：超文本传输协议,这里的角色仅提供安装系统所需的软件包。</p></li><li><p><strong>Tftp</strong>:  服务器用来存放PXE的相关文件，比如：系统引导文件；</p></li><li><p><strong>Kickstart</strong> : KickStart是一种无人职守安装方式。KickStart的工作原理是通过记录典型的安装过程中所需人工干预填写的各种参数，并生成一个名为 ks.cfg的文件；在其后的安装过程中（不只局限于生成KickStart安装文件的机器）当出现要求填写参数的情况时，安装程序会首先去查找 KickStart生成的文件，当找到合适的参数时，就采用找到的参数，当没有找到合适的参数时，才需要安装者手工干预。这样，如果KickStart文件涵盖了安装过程中出现的所有需要填写的参数时，安装者完全可以只告诉安装程序从何处取ks.cfg文件，然后去忙自己的事情。等安装完毕，安装程序会根据ks.cfg中设置的重启选项来重启系统，并结束安装。<br>设置BIOS引导顺序为：  硬盘，网络<br><img src="https://upload-images.jianshu.io/upload_images/9650472-74035760cf8318db.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="pxe.jpg"></p></li></ul><h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><p><strong>实验环境</strong>：Vmware Workstation 15<br><strong>系统平台</strong>：Centos7 （界面版本）<br><strong>网络模式</strong>：仅主机模式（Vmnet10网卡）</p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">#关闭防火墙</span><br>[root@server yum.repos.d]<span class="hljs-comment"># systemctl stop firewalld </span><br><span class="hljs-comment">#临时关闭selinux</span><br>[root@server yum.repos.d]<span class="hljs-comment"># setenforce 0</span><br><span class="hljs-comment">#搭建本地源仓库安装需要的软件</span><br>[root@server yum.repos.d]<span class="hljs-comment"># mount /dev/sr0 /home/lemonchen/iso</span><br>[root@server yum.repos.d]<span class="hljs-comment"># vim /etc/yum.repos.d/CentOS-Base.repo</span><br>[<span class="hljs-keyword">local</span>]<br>name=<span class="hljs-keyword">local</span><br>baseurl=file:<span class="hljs-regexp">//</span><span class="hljs-regexp">/home/l</span>emonchen/iso<br>enable=<span class="hljs-number">1</span><br>gpgcheck=<span class="hljs-number">1</span><br>gpgkey=file:<span class="hljs-regexp">//</span><span class="hljs-regexp">/etc/p</span>ki/rpm-gpg/RPM-GPG-KEY-CentOS-<span class="hljs-number">7</span><br><span class="hljs-comment">#增加一块网卡并配置</span><br>nmcli con add con-name ens37 type ethernet ifname ens37 ipv4.addresses <span class="hljs-number">10.1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>/<span class="hljs-number">24</span> ipv4.method manual<br>Connection <span class="hljs-string">&#x27;ens37&#x27;</span> (<span class="hljs-number">28</span>b0b6a1-<span class="hljs-number">0377</span>-<span class="hljs-number">4</span>e4b-<span class="hljs-number">87</span>f6-ef4c6b2b6da<span class="hljs-number">0</span>) successfully added.successfully added.<br><span class="hljs-comment">#启用该网卡</span><br>[root@localhost ~]<span class="hljs-comment"># nmcli con up ens37</span><br>Connection successfully activated (D-Bus active path: <span class="hljs-regexp">/org/</span>freedesktop/NetworkManager/ActiveConnection/<span class="hljs-number">7</span>)<br><span class="hljs-comment">#查看是否网卡连接成功</span><br>[root@localhost ~]<span class="hljs-comment"># nmcli device status</span><br>DEVICE  TYPE      STATE      CONNECTION <br>ens33   ethernet  connected  ens33      <br>ens37   ethernet  connected  ens37      <br>lo      loopback  unmanaged  --<br></code></pre></td></tr></table></figure><p>1、 <strong>配置Httpd服务器</strong></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-comment">#httpd服务器搭建 默认端口80</span><br>[root<span class="hljs-variable">@server</span> ~]<span class="hljs-comment"># yum -y install httpd</span><br><span class="hljs-comment">#httpd的主配置文件是</span><br><span class="hljs-regexp">/etc/httpd</span><span class="hljs-regexp">/conf/httpd</span>.conf<br><span class="hljs-comment">#启动httpd服务</span><br>[root<span class="hljs-variable">@server</span> ~]<span class="hljs-comment"># systemctl start httpd</span><br><span class="hljs-comment">#设置开机自启动</span><br>[root<span class="hljs-variable">@server</span> ~]<span class="hljs-comment"># systemctl enable httpd</span><br><span class="hljs-comment">#在该目录下创建install_iso(存放系统文件)ks(存放后续kickstart配置文件)</span><br>[root<span class="hljs-variable">@server</span> ~]<span class="hljs-comment"># mkdir /var/www/html/&#123;install_iso,ks&#125;</span><br><span class="hljs-comment">#挂载系统文件到install_iso下</span><br>[root<span class="hljs-variable">@server</span> ~]<span class="hljs-comment"># mount /dev/sr0 /var/www/html/install_iso/</span><br><span class="hljs-comment">#添加开机自动挂载</span><br>[root<span class="hljs-variable">@server</span> ~]<span class="hljs-comment"># echo &#x27;/dev/sr0 /var/www/html/install_iso&#x27; &gt;&gt; /etc/fstab</span><br></code></pre></td></tr></table></figure><p>2、 <strong>配置TFTP服务器</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gradle">#TfTP服务器搭建 默认端口<span class="hljs-number">69</span><br>[root@server ~]# yum -y install tftp-server xinetd<br>#启动tftp服务<br>[root@server ~]# systemctl enable tftp --now<br>#安装syslinux<br>[root@server ~]# yum -y install syslinux<br>#拷贝syslinux文件啊，将这个文件放入到<span class="hljs-regexp">/var/</span>lib/tftpboot下<br>#说明：syslinux是一个功能强大的引导加载程序，而且兼容各种介质<br>[root@server ~]# cp -rf <span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/syslinux/</span>* <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/tftpboot/</span><br>#拷贝镜像下的vmlinuz initrd.img到tftp下<br>[root@server ~]# cp <span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/html/i</span>nstall_iso<span class="hljs-regexp">/isolinux/</span>vmlinuz <span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/html/i</span>nstall_iso<span class="hljs-regexp">/isolinux/i</span>nitrd.img <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/tftpboot/</span><br>#创建一个文件夹<br>[root@localhost tftpboot]# mkdir <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/tftpboot/</span>pxelinux.cfg<br>#拷贝引导配置文件到tftp目录下并修改<br>[root@server ~]# cp <span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/html/i</span>nstall_iso<span class="hljs-regexp">/isolinux/i</span>solinux.cfg <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/tftpboot/</span>pxelinux.cfg/<span class="hljs-keyword">default</span><br></code></pre></td></tr></table></figure><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">#<span class="hljs-keyword">default</span><br>[root@localhost tftpboot]# cat /<span class="hljs-keyword">var</span>/lib/tftpboot/pxelinux.cfg/<span class="hljs-keyword">default</span> <br><span class="hljs-keyword">default</span> menu.c32<br>label lemonchenpxe<br>kernel vmlinuz<br>append initrd=initrd.img <span class="hljs-keyword">method</span>=<span class="hljs-title function_">http</span>:<span class="hljs-comment">//10.1.0.1/install_iso #httpd下的系统文件路径</span><br></code></pre></td></tr></table></figure><p>3、 <strong>配置DHCP服务器</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment">#安装dhcp服务</span><br>[root<span class="hljs-variable">@server</span> cache]<span class="hljs-comment"># yum -y install dhcp</span><br><span class="hljs-comment">#copy模板到dhcp配置目录下</span><br>[root<span class="hljs-variable">@server</span> ~]<span class="hljs-comment"># cp /usr/share/doc/dhcp-4.2.5/dhcpd.conf.example /etc/dhcp/dhcpd.conf</span><br>[root<span class="hljs-variable">@localhost</span> tftpboot]<span class="hljs-comment"># cat /etc/dhcp/dhcpd.conf </span><br><span class="hljs-comment"># dhcpd.conf</span><br><span class="hljs-comment"># # A slightly different configuration for an internal subnet.</span><br><span class="hljs-comment">#dhcp服务器告诉dhcp客户端，如果你是pxe引导，那么tftp服务器的地址</span><br><span class="hljs-comment">#是10.1.0.1，你可以到tftp服务器上的根⽬录上下载pxelinux.0</span><br>subnet <span class="hljs-number">10.1</span>.<span class="hljs-number">0.0</span> netmask <span class="hljs-number">255.255</span>.<span class="hljs-number">255.0</span> &#123; <span class="hljs-comment">#ip子网及子网掩码</span><br>  range <span class="hljs-number">10.1</span>.<span class="hljs-number">0.100</span> <span class="hljs-number">10.1</span>.<span class="hljs-number">0.200</span>; <span class="hljs-comment">#网络段</span><br>  <span class="hljs-keyword">next</span>-server <span class="hljs-number">10.1</span>.<span class="hljs-number">0.1</span>; <span class="hljs-comment">#指向服务器</span><br>  filename <span class="hljs-string">&quot;pxelinux.0&quot;</span>; <span class="hljs-comment">#指向安装文件</span><br>&#125;<br></code></pre></td></tr></table></figure><p>4、 <strong>Kickstart配置自动化安装</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta">#就是自动化的一个配置</span><br>[root<span class="hljs-symbol">@localhost</span> ~]<span class="hljs-meta"># ls</span><br>anaconda-ks.cfg<br><span class="hljs-meta">#拷贝一份配置到httpd目录下</span><br>[root<span class="hljs-symbol">@localhost</span> ~]<span class="hljs-meta"># cp anaconda-ks.cfg /var/www/html/ks/lemonchen-ks.cfg</span><br></code></pre></td></tr></table></figure><p>kickstart配置</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[root@localhost ks]# cat anaconda-ks.cfg <br><span class="hljs-comment">#version=DEVEL</span><br><span class="hljs-comment"># System authorization information(系统授权信息)</span><br>auth --enableshadow <span class="hljs-attribute">--passalgo</span>=sha512<br><span class="hljs-comment"># Use CDROM installation media(使用光盘安装介质)</span><br><span class="hljs-comment">#cdrom</span><br>url --url = <span class="hljs-string">&quot;http://10.1.0.1/install_iso&quot;</span> #下载安装路径<br><span class="hljs-comment"># Use graphical install(使用图形化安装)</span><br>graphical<br><span class="hljs-comment"># Run the Setup Agent on first boot(在第一次引导时运行安装代理)</span><br>firstboot --<span class="hljs-built_in">enable</span><br>ignoredisk <span class="hljs-attribute">--only-use</span>=sda<br><span class="hljs-comment"># Keyboard layouts(键盘布局)</span><br>keyboard <span class="hljs-attribute">--vckeymap</span>=us <span class="hljs-attribute">--xlayouts</span>=<span class="hljs-string">&#x27;us&#x27;</span><br><span class="hljs-comment"># System language(系统语言)</span><br>lang en_US.UTF-8<br><br><span class="hljs-comment"># Network information(网络信息)</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">network </span> <span class="hljs-attribute">--bootproto</span>=dhcp <span class="hljs-attribute">--device</span>=ens33 <span class="hljs-attribute">--onboot</span>=off <span class="hljs-attribute">--ipv6</span>=auto --no-activate<span class="hljs-built_in"></span><br><span class="hljs-built_in">network </span> <span class="hljs-attribute">--hostname</span>=localhost.localdomain<br><br><span class="hljs-comment"># Root password(根密码)</span><br>rootpw --iscrypted <span class="hljs-variable">$1</span><span class="hljs-variable">$MWC7lQya</span><span class="hljs-variable">$o</span>/114lD9L58dVYPiJvNoM0<br><span class="hljs-comment"># System services(系统服务)</span><br>services <span class="hljs-attribute">--enabled</span>=<span class="hljs-string">&quot;chronyd&quot;</span><br><span class="hljs-comment"># System timezone(系统时区)</span><br>timezone Asia/Shanghai <span class="hljs-built_in"></span><br><span class="hljs-built_in">user </span><span class="hljs-attribute">--groups</span>=wheel <span class="hljs-attribute">--name</span>=lemonchen <span class="hljs-attribute">--password</span>=<span class="hljs-variable">$1</span><span class="hljs-variable">$MWC7lQya</span><span class="hljs-variable">$o</span>/114lD9L58dVYPiJvNoM0 --iscrypted <span class="hljs-attribute">--gecos</span>=<span class="hljs-string">&quot;lemonchen&quot;</span><br><span class="hljs-comment"># System bootloader configuration(系统引导装载程序配置)</span><br>bootloader <span class="hljs-attribute">--append</span>=<span class="hljs-string">&quot; crashkernel=auto&quot;</span> <span class="hljs-attribute">--location</span>=mbr <span class="hljs-attribute">--boot-drive</span>=sda<br>autopart <span class="hljs-attribute">--type</span>=lvm<br><span class="hljs-comment"># Partition clearing information(分区结算信息)</span><br>clearpart --none --initlabel<br><span class="hljs-comment">#最小化安装 </span><br>%packages<br>@^minimal<br>@core<br>chrony<br>kexec-tools<br><br>%end<br><span class="hljs-comment">#安装完成后自动重启。</span><br>reboot<br><br>%addon com_redhat_kdump --<span class="hljs-built_in">enable</span> <span class="hljs-attribute">--reserve-mb</span>=<span class="hljs-string">&#x27;auto&#x27;</span><br><br>%end<br><br>%anaconda<br>pwpolicy root <span class="hljs-attribute">--minlen</span>=6 <span class="hljs-attribute">--minquality</span>=1 --notstrict --nochanges --notempty<br>pwpolicy<span class="hljs-built_in"> user </span><span class="hljs-attribute">--minlen</span>=6 <span class="hljs-attribute">--minquality</span>=1 --notstrict --nochanges --emptyok<br>pwpolicy luks <span class="hljs-attribute">--minlen</span>=6 <span class="hljs-attribute">--minquality</span>=1 --notstrict --nochanges --notempty<br>%end<br>[root@localhost ks]# <br></code></pre></td></tr></table></figure><p>#default修改后</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">[root@localhost tftpboot]# cat /<span class="hljs-keyword">var</span>/lib/tftpboot/pxelinux.cfg/<span class="hljs-keyword">default</span> <br><span class="hljs-keyword">default</span> menu.c32<br>timeout <span class="hljs-number">10</span><br>label lemonchenpxe<br>kernel vmlinuz<br>append initrd=initrd.img <span class="hljs-keyword">method</span>=<span class="hljs-title function_">http</span>:<span class="hljs-comment">//10.1.0.1/install_iso ks=http://10.1.0.1/ks/lemonchen-ks.cfg#httpd下的系统文件路径</span><br></code></pre></td></tr></table></figure><ul><li>如果打开访问不了，需要增加权限<br><img src="https://upload-images.jianshu.io/upload_images/9650472-433e9ccef29fea37.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_16024146907930.png"><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@localhost ks]# chmod o+r <span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/html/</span>ks/lemonchen-ks.cfg<br></code></pre></td></tr></table></figure>5、 <strong>基本就完成了，后续的更精细如何配置需要好好研究了</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-e47dc0679f1ec7b2.gif?imageMogr2/auto-orient/strip" alt="auto_install.gif"></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kickstart</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Ceph部署实践</title>
    <link href="/2022/08/31/Linux/ceph_experiment/"/>
    <url>/2022/08/31/Linux/ceph_experiment/</url>
    
    <content type="html"><![CDATA[<h2 id="Ceph部署实践-虚拟环境下实现"><a href="#Ceph部署实践-虚拟环境下实现" class="headerlink" title="Ceph部署实践(虚拟环境下实现)"></a>Ceph部署实践(虚拟环境下实现)</h2><p><strong>osd</strong>：存储数据、复制数据、平衡数据、恢复数据等，与其它OSD间进行心跳检查等，并将一些变化情况上报给Ceph Monitor。</p><p><strong>mon</strong>：一个监视器，负责监视Ceph集群，维护Ceph集群的健康状态，同时维护着Ceph集群中的各种Map图。<br><strong>Mds</strong>: Ceph 元数据服务器（ MDS ）为 Ceph 文件系统存储元数据（也就是说，Ceph 块设备和 Ceph 对象存储不使用MDS ）。<br><strong>mgr</strong>：负责ceph集群管理，如pg map，对外提供集群性能指标（如cpeh -s 下IO信息），具有web界面的监控系统（dashboard）</p><h2 id="一、环境部署的准备"><a href="#一、环境部署的准备" class="headerlink" title="一、环境部署的准备"></a>一、环境部署的准备</h2><p><strong>使用Ceph版本</strong><br>Nautilus 14.2.9<br>Ceph-deploy：2.0.1</p><p><strong>节点信息</strong><br><img src="/img/Linux/ceph_info.png"></p><p><strong>服务器系统版本：</strong></p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm">[root<span class="hljs-title">@localhost</span> ~]# cat /etc/centos-<span class="hljs-keyword">release</span><br>CentOS Linux <span class="hljs-keyword">release</span> <span class="hljs-number">7.6</span>.<span class="hljs-number">1810</span> (Core)<br><br></code></pre></td></tr></table></figure><p><strong>1、关闭防火墙以及SELinux</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root@localhost ~]<span class="hljs-comment"># systemctl stop firewalld</span><br>[root@localhost ~]<span class="hljs-comment"># systemctl disable firewalld</span><br>Removed <span class="hljs-keyword">symlink</span> /etc/systemd/<span class="hljs-keyword">system</span>/multi-user.target.wants/firewalld.service.<br>Removed <span class="hljs-keyword">symlink</span> /etc/systemd/<span class="hljs-keyword">system</span>/dbus-org.fedoraproject.FirewallD1.service.<br>[root@localhost ~]<span class="hljs-comment"># sed -i  &quot;s/SELINUX=enforcing/SELINUX=permissive/g&quot; /etc/selinux/config</span><br>[root@localhost ~]<span class="hljs-comment">#</span><br>[root@localhost ~]<span class="hljs-comment"># setenforce 0</span><br>[root@localhost ~]<span class="hljs-comment"># getenforce</span><br>Permissive<br>[root@localhost ~]<span class="hljs-comment">#nmcli conn mod ens33 ipv4.address 192.168.142.136/24 ipv4.gateway 192.168.142.2 ipv4.dns 192.168.142.2 ipv4.method manual </span><br></code></pre></td></tr></table></figure><p><strong>2、配置Hosts所有节点进行</strong></p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">保证集群内主机名称和ip解析正常(每个节点都需要配置)<br><span class="hljs-string">[root@localhost ~]</span># cat /etc/hosts<br><span class="hljs-number">127.0.0.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::<span class="hljs-number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6<br><span class="hljs-number">192.168.142.134</span> ceph_node1<br><span class="hljs-number">192.168.142.135</span> ceph_node2<br><span class="hljs-number">192.168.142.136</span> ceph_node3<br><span class="hljs-string">[root@localhost ~]</span>#<br></code></pre></td></tr></table></figure><p><strong>3、创建部署用户及配置sudo权限(所有节点进行)</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs ruby">[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># useradd ceph-admin</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># echo &quot;Lemon/123&quot; | passwd --stdin ceph-admin</span><br>Changing password <span class="hljs-keyword">for</span> user ceph-admin.<br><span class="hljs-symbol">passwd:</span> all authentication tokens updated successfully.<br><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># echo &quot;ceph-admin ALL = NOPASSWD:ALL&quot; | tee /etc/sudoers.d/ceph-admin</span><br>ceph-admin <span class="hljs-variable constant_">ALL</span> = <span class="hljs-variable constant_">NOPASSWD</span><span class="hljs-symbol">:ALL</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># chmod 0440 /etc/sudoers.d/ceph-admin      </span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># ll /etc/sudoers.d/ceph-admin</span><br>-r--r-----. <span class="hljs-number">1</span> root root <span class="hljs-number">30</span> Nov <span class="hljs-number">10</span> <span class="hljs-number">04</span><span class="hljs-symbol">:</span><span class="hljs-number">12</span> /etc/sudoers.d/ceph-admin<br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment">#</span><br><br><br>测试<br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># su - ceph-admin</span><br>[ceph-admin<span class="hljs-variable">@localhost</span> ~]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span>[ceph-admin<span class="hljs-variable">@localhost</span> ~]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span>[ceph-admin<span class="hljs-variable">@localhost</span> ~]<span class="hljs-variable">$ </span>ls<br>[ceph-admin<span class="hljs-variable">@localhost</span> ~]<span class="hljs-variable">$ </span>sudo su -<br>Last <span class="hljs-symbol">login:</span> Wed Nov <span class="hljs-number">10</span> <span class="hljs-number">01</span><span class="hljs-symbol">:</span><span class="hljs-number">54</span><span class="hljs-symbol">:</span><span class="hljs-number">32</span> <span class="hljs-variable constant_">EST</span> <span class="hljs-number">2021</span> from <span class="hljs-number">10.1</span>.<span class="hljs-number">130.7</span> on pts/<span class="hljs-number">1</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment">#</span><br><br></code></pre></td></tr></table></figure><p><strong>4、配置ssh无密码访问（ceph_admin）上进行</strong><br>[ceph-admin@localhost ~]$ ssh-keygen<br>[ceph-admin@localhost ~]$ ssh-copy-id ceph-admin@ceph_node1<br>[ceph-admin@localhost ~]$ ssh-copy-id ceph-admin@ceph_node2<br>[ceph-admin@localhost ~]$ ssh-copy-id ceph-admin@ceph_node3</p><p><strong>5、配置ntp时间同步(所有节点进行)</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-id">#ceph_admin</span>节点安装<span class="hljs-selector-tag">ntp</span>，同步阿里云的时间，节点<span class="hljs-selector-tag">ceph_node1</span> <span class="hljs-selector-tag">ceph_node2</span> <span class="hljs-selector-tag">ceph_node3</span> 同步<span class="hljs-selector-tag">ceph_admin</span>节点的时间<br><span class="hljs-selector-attr">[root@admin ~]</span># <span class="hljs-selector-tag">sudo</span> <span class="hljs-selector-tag">yum</span> <span class="hljs-selector-tag">-y</span> <span class="hljs-selector-tag">install</span> <span class="hljs-selector-tag">ntp</span><br><span class="hljs-selector-attr">[root@admin ~]</span># <span class="hljs-selector-tag">sudo</span> <span class="hljs-selector-tag">vim</span> /<span class="hljs-selector-tag">etc</span>/<span class="hljs-selector-tag">ntp</span><span class="hljs-selector-class">.conf</span><br><span class="hljs-selector-attr">[root@admin ~]</span>#<br><span class="hljs-selector-attr">[root@admin ~]</span>#<br><span class="hljs-selector-attr">[root@admin ~]</span># <span class="hljs-selector-tag">grep</span> <span class="hljs-selector-tag">server</span> /<span class="hljs-selector-tag">etc</span>/<span class="hljs-selector-tag">ntp</span><span class="hljs-selector-class">.conf</span><br># <span class="hljs-selector-tag">Use</span> <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">servers</span> <span class="hljs-selector-tag">from</span> <span class="hljs-selector-tag">the</span> <span class="hljs-selector-tag">pool</span><span class="hljs-selector-class">.ntp</span><span class="hljs-selector-class">.org</span> <span class="hljs-selector-tag">project</span>.<br><span class="hljs-selector-id">#server</span> <span class="hljs-number">0</span><span class="hljs-selector-class">.centos</span><span class="hljs-selector-class">.pool</span><span class="hljs-selector-class">.ntp</span><span class="hljs-selector-class">.org</span> <span class="hljs-selector-tag">iburst</span><br><span class="hljs-selector-id">#server</span> <span class="hljs-number">1</span><span class="hljs-selector-class">.centos</span><span class="hljs-selector-class">.pool</span><span class="hljs-selector-class">.ntp</span><span class="hljs-selector-class">.org</span> <span class="hljs-selector-tag">iburst</span><br><span class="hljs-selector-id">#server</span> <span class="hljs-number">2</span><span class="hljs-selector-class">.centos</span><span class="hljs-selector-class">.pool</span><span class="hljs-selector-class">.ntp</span><span class="hljs-selector-class">.org</span> <span class="hljs-selector-tag">iburst</span><br><span class="hljs-selector-id">#server</span> <span class="hljs-number">3</span><span class="hljs-selector-class">.centos</span><span class="hljs-selector-class">.pool</span><span class="hljs-selector-class">.ntp</span><span class="hljs-selector-class">.org</span> <span class="hljs-selector-tag">iburst</span><br><span class="hljs-selector-tag">server</span> <span class="hljs-selector-tag">ntp1</span><span class="hljs-selector-class">.aliyun</span><span class="hljs-selector-class">.com</span>  #阿里云服务器<br><span class="hljs-selector-tag">server</span> <span class="hljs-number">127.127</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.0</span> <span class="hljs-selector-tag">iburst</span> #本地<span class="hljs-selector-tag">ntp</span>服务器，配置此项为了在外网<span class="hljs-selector-tag">ntp</span>连接异常的情况下还能保证<span class="hljs-selector-tag">ntp</span>的正常<br><span class="hljs-selector-id">#broadcast</span> <span class="hljs-number">192.168</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.255</span> <span class="hljs-selector-tag">autokey</span>        # <span class="hljs-selector-tag">broadcast</span> <span class="hljs-selector-tag">server</span><br><span class="hljs-selector-id">#broadcast</span> <span class="hljs-number">224.0</span><span class="hljs-selector-class">.1</span><span class="hljs-selector-class">.1</span> <span class="hljs-selector-tag">autokey</span>            # <span class="hljs-selector-tag">multicast</span> <span class="hljs-selector-tag">server</span><br><span class="hljs-selector-id">#manycastserver</span> <span class="hljs-number">239.255</span><span class="hljs-selector-class">.254</span><span class="hljs-selector-class">.254</span>         # <span class="hljs-selector-tag">manycast</span> <span class="hljs-selector-tag">server</span><br><span class="hljs-selector-attr">[root@admin ~]</span># <span class="hljs-selector-tag">systemctl</span> <span class="hljs-selector-tag">restart</span> <span class="hljs-selector-tag">ntpd</span><br><span class="hljs-selector-attr">[root@admin ~]</span># <span class="hljs-selector-tag">systemctl</span> <span class="hljs-selector-tag">enable</span> <span class="hljs-selector-tag">ntpd</span><br><span class="hljs-selector-tag">Created</span> <span class="hljs-selector-tag">symlink</span> <span class="hljs-selector-tag">from</span> /<span class="hljs-selector-tag">etc</span>/<span class="hljs-selector-tag">systemd</span>/<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">multi-user</span><span class="hljs-selector-class">.target</span><span class="hljs-selector-class">.wants</span>/<span class="hljs-selector-tag">ntpd</span><span class="hljs-selector-class">.service</span> <span class="hljs-selector-tag">to</span> /<span class="hljs-selector-tag">usr</span>/<span class="hljs-selector-tag">lib</span>/<span class="hljs-selector-tag">systemd</span>/<span class="hljs-selector-tag">system</span>/<span class="hljs-selector-tag">ntpd</span><span class="hljs-selector-class">.service</span>.<br><span class="hljs-selector-attr">[root@admin ~]</span># <span class="hljs-selector-tag">ntpq</span> <span class="hljs-selector-tag">-p</span><br>     <span class="hljs-selector-tag">remote</span>           <span class="hljs-selector-tag">refid</span>      <span class="hljs-selector-tag">st</span> <span class="hljs-selector-tag">t</span> <span class="hljs-keyword">when</span> poll reach   delay   offset  jitter<br>==============================================================================<br> <span class="hljs-number">120.25</span>.<span class="hljs-number">115.20</span>   <span class="hljs-number">10.137</span>.<span class="hljs-number">53.7</span>      <span class="hljs-number">2</span> u   <span class="hljs-number">46</span>   <span class="hljs-number">64</span>    <span class="hljs-number">3</span>    <span class="hljs-number">5.968</span>   -<span class="hljs-number">3.188</span>  <span class="hljs-number">19.905</span><br>*<span class="hljs-built_in">LOCAL</span>(<span class="hljs-number">0</span>)        .LOCL.           <span class="hljs-number">5</span> l   <span class="hljs-number">48</span>   <span class="hljs-number">64</span>    <span class="hljs-number">3</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.000</span>   <span class="hljs-number">0.000</span><br>[root<span class="hljs-variable">@admin</span> ~]#<br>[root<span class="hljs-variable">@admin</span> ~]# ntpstat<br>synchronised to local net (<span class="hljs-number">127.127</span>.<span class="hljs-number">1.0</span>) at stratum <span class="hljs-number">6</span><br>   time correct to within <span class="hljs-number">449</span> ms<br>   polling server every <span class="hljs-number">64</span> s<br>[root<span class="hljs-variable">@admin</span> ~]#<br><br><br>#ceph_node1节点配置<br>[root<span class="hljs-variable">@node1</span> ~]# grep <span class="hljs-number">142</span> /etc/ntp.conf<br>server <span class="hljs-number">192.168</span>.<span class="hljs-number">142.130</span>  #ceph_admin的ntp服务器<br>[root<span class="hljs-variable">@node1</span> ~]# systemctl restart ntpd<br>[root<span class="hljs-variable">@node1</span> ~]# systemctl enable ntpd<br>[root<span class="hljs-variable">@node1</span> ~]# ntpq -p<br>     remote           refid      st t <span class="hljs-keyword">when</span> poll reach   delay   offset  jitter<br>==============================================================================<br> ceph_admin      <span class="hljs-built_in">LOCAL</span>(<span class="hljs-number">0</span>)         <span class="hljs-number">6</span> u   <span class="hljs-number">56</span>   <span class="hljs-number">64</span>    <span class="hljs-number">3</span>    <span class="hljs-number">0.821</span>    <span class="hljs-number">3.245</span>   <span class="hljs-number">0.565</span><br><br><br>##ceph_node2节点配置<br>[root<span class="hljs-variable">@node2</span> ~]# grep <span class="hljs-number">142</span> /etc/ntp.conf<br>server <span class="hljs-number">192.168</span>.<span class="hljs-number">142.130</span>  ##ceph_admin的ntp服务器<br>[root<span class="hljs-variable">@node2</span> ~]# systemctl restart ntpd<br>[root<span class="hljs-variable">@node2</span> ~]# systemctl enable ntpd<br>[root<span class="hljs-variable">@node2</span> ~]# ntpq -p<br>     remote           refid      st t <span class="hljs-keyword">when</span> poll reach   delay   offset  jitter<br>==============================================================================<br> ceph_admin      <span class="hljs-built_in">LOCAL</span>(<span class="hljs-number">0</span>)         <span class="hljs-number">6</span> u   <span class="hljs-number">54</span>   <span class="hljs-number">64</span>    <span class="hljs-number">3</span>    <span class="hljs-number">0.871</span>   -<span class="hljs-number">0.474</span>   <span class="hljs-number">0.508</span><br><br><br><br>#ceph_node3节点配置<br>[root<span class="hljs-variable">@node3</span> ~]# grep <span class="hljs-number">142</span> /etc/ntp.conf<br>server <span class="hljs-number">192.168</span>.<span class="hljs-number">142.130</span>  #ceph_admin的ntp服务器<br>[root<span class="hljs-variable">@node3</span> ~]# systemctl restart ntpd<br>[root<span class="hljs-variable">@node3</span> ~]# systemctl enable ntpd<br>[root<span class="hljs-variable">@node3</span> ~]# ntpq -p<br>     remote           refid      st t <span class="hljs-keyword">when</span> poll reach   delay   offset  jitter<br>==============================================================================<br> ceph_admin      <span class="hljs-built_in">LOCAL</span>(<span class="hljs-number">0</span>)         <span class="hljs-number">6</span> u   <span class="hljs-number">53</span>   <span class="hljs-number">64</span>    <span class="hljs-number">3</span>    <span class="hljs-number">0.864</span>    <span class="hljs-number">1.155</span>   <span class="hljs-number">0.596</span><br><br></code></pre></td></tr></table></figure><h2 id="二、开始部署Ceph的集群"><a href="#二、开始部署Ceph的集群" class="headerlink" title="二、开始部署Ceph的集群"></a>二、开始部署Ceph的集群</h2><p><strong>1、修改yum源(所有节点进行)</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta">#ceph_node1 ceph_node2 ceph_node3以上三节点也需要执行以下步骤</span><br>[root<span class="hljs-symbol">@admin</span> ~]<span class="hljs-meta"># mkdir /mnt/repo_bak</span><br>[root<span class="hljs-symbol">@admin</span> ~]<span class="hljs-meta"># mv /etc/yum.repos.d/* /mnt/repo_bak/</span><br>[root<span class="hljs-symbol">@admin</span> ~]<span class="hljs-meta"># wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br>[root<span class="hljs-symbol">@admin</span> ~]<span class="hljs-meta"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><br><br></code></pre></td></tr></table></figure><p><strong>2、添加ceph的yum源(所有节点进行)</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@admin ~]</span><span class="hljs-comment"># cat /etc/yum.repos.d/ceph.repo</span><br><span class="hljs-section">[Ceph]</span><br><span class="hljs-attr">name</span>=Ceph<br><span class="hljs-attr">baseurl</span>=http://download.ceph.com/rpm-nautilus/el7/x<span class="hljs-number">86_64</span><br><span class="hljs-attr">enbaled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">type</span>=rpm-md<br><span class="hljs-attr">gpgkey</span>=https://download.ceph.com/keys/release.asc<br><span class="hljs-attr">priority</span>=<span class="hljs-number">1</span><br><br><span class="hljs-section">[Ceph-noarch]</span><br><span class="hljs-attr">name</span>=Ceph noarch packages<br><span class="hljs-attr">baseurl</span>=http://download.ceph.com/rpm-nautilus/el7/noarch<br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">type</span>=rpm-md<br><span class="hljs-attr">gpgkey</span>=https://download.ceph.com/keys/release.asc<br><span class="hljs-attr">priority</span>=<span class="hljs-number">1</span><br><br><span class="hljs-section">[Ceph-source]</span><br><span class="hljs-attr">name</span>=Ceph source packages<br><span class="hljs-attr">baseurl</span>=http://download.ceph.com/rpm-nautilus/el7/SRPMS<br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">type</span>=rpm-md<br><span class="hljs-attr">gpgkey</span>=https://download.ceph.com/keys/release.asc<br><span class="hljs-attr">priority</span>=<span class="hljs-number">1</span><br><br><span class="hljs-section">[root@admin ~]</span><span class="hljs-comment">#</span><br><span class="hljs-section">[root@admin ~]</span><span class="hljs-comment"># yum makecache</span><br><span class="hljs-section">[root@admin ~]</span><span class="hljs-comment"># yum update</span><br><br><br><span class="hljs-section">[root@admin ~]</span><span class="hljs-comment"># scp /etc/yum.repos.d/ceph.repo root@ceph_node1:/etc/yum.repos.d/</span><br><span class="hljs-section">[root@admin ~]</span><span class="hljs-comment"># scp /etc/yum.repos.d/ceph.repo root@ceph_node2:/etc/yum.repos.d/</span><br><span class="hljs-section">[root@admin ~]</span><span class="hljs-comment"># scp /etc/yum.repos.d/ceph.repo root@ceph_node3:/etc/yum.repos.d/</span><br><br><br></code></pre></td></tr></table></figure><p><strong>3、安装ceph-deploy(在ceph-admin节点上执行)</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">[root@<span class="hljs-keyword">admin</span> ~]# su - ceph-<span class="hljs-keyword">admin</span><br>Last <span class="hljs-keyword">login</span>: Wed Nov <span class="hljs-number">10</span> <span class="hljs-number">04</span>:<span class="hljs-number">18</span>:<span class="hljs-number">17</span> EST <span class="hljs-number">2021</span> <span class="hljs-keyword">on</span> pts/<span class="hljs-number">1</span><br>[ceph-<span class="hljs-keyword">admin</span>@<span class="hljs-keyword">admin</span> ~]$ sudo yum -y install python-setuptools<br>[ceph-<span class="hljs-keyword">admin</span>@<span class="hljs-keyword">admin</span> ~]$ sudo yum -y install ceph-deploy<br>[ceph-<span class="hljs-keyword">admin</span>@<span class="hljs-keyword">admin</span> ~]$ ceph-deploy <span class="hljs-comment">--version</span><br><span class="hljs-number">2.0</span><span class="hljs-number">.1</span><br></code></pre></td></tr></table></figure><p><strong>4、初始化集群(在ceph-node1节点上执行)</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#创建集群安装目录（ceph-deploy部署程序会将文件输出到当前目录）</span><br><span class="hljs-comment">#因为我是把ceph_node1节点作为mon监视器使用，所以规划中部署mon的节点ceph_node1</span><br><br>[ceph-admin@ceph_admin cluster]$ ceph-deploy new ceph_node1<br>[ceph_deploy.conf][<span class="hljs-built_in">DEBUG</span> ] found configuration file at: /home/ceph-admin/.cephdeploy.conf<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ] Invoked (2.0.1): /bin/ceph-deploy new ceph_node1<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ] ceph-deploy options:<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  username                      : None<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  func                          : &lt;function new at 0x7fadd8b53d70&gt;<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  verbose                       : <span class="hljs-literal">False</span><br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  overwrite_conf                : <span class="hljs-literal">False</span><br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  quiet                         : <span class="hljs-literal">False</span><br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf<span class="hljs-built_in"> instance </span>at 0x7fadd82cc758&gt;<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  cluster                       : ceph<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  ssh_copykey                   : <span class="hljs-literal">True</span><br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  mon                           : [<span class="hljs-string">&#x27;ceph_node1&#x27;</span>]<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  public_network                : None<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  ceph_conf                     : None<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  cluster_network               : None<br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  default_release               : <span class="hljs-literal">False</span><br>[ceph_deploy.cli][<span class="hljs-built_in">INFO</span>  ]  fsid                          : None<br>[ceph_deploy.new][<span class="hljs-built_in">DEBUG</span> ] Creating new cluster named ceph<br>[ceph_deploy.new][<span class="hljs-built_in">INFO</span>  ] making sure passwordless SSH succeeds<br>[ceph_node1][<span class="hljs-built_in">DEBUG</span> ] connected <span class="hljs-keyword">to</span> host: ceph_admin<br>[ceph_node1][<span class="hljs-built_in">INFO</span>  ] Running command: ssh -CT -o <span class="hljs-attribute">BatchMode</span>=<span class="hljs-literal">yes</span> ceph_node1<br>[ceph_node1][<span class="hljs-built_in">DEBUG</span> ]<span class="hljs-built_in"> connection </span>detected need <span class="hljs-keyword">for</span> sudo<br>[ceph_node1][<span class="hljs-built_in">DEBUG</span> ] connected <span class="hljs-keyword">to</span> host: ceph_node1<br>[ceph_node1][<span class="hljs-built_in">DEBUG</span> ] detect platform information <span class="hljs-keyword">from</span> remote host<br>[ceph_node1][<span class="hljs-built_in">DEBUG</span> ] detect machine<span class="hljs-built_in"> type</span><br><span class="hljs-built_in"></span>[ceph_node1][<span class="hljs-built_in">DEBUG</span> ] <span class="hljs-built_in">find</span> the location of an executable<br>[ceph_node1][<span class="hljs-built_in">INFO</span>  ] Running command: sudo /usr/sbin<span class="hljs-built_in">/ip </span>link show<br>[ceph_node1][<span class="hljs-built_in">INFO</span>  ] Running command: sudo /usr/sbin<span class="hljs-built_in">/ip </span>addr show<br>[ceph_node1][<span class="hljs-built_in">DEBUG</span> ]<span class="hljs-built_in"> IP </span>addresses found: [u<span class="hljs-string">&#x27;192.168.241.134&#x27;</span>, u<span class="hljs-string">&#x27;192.168.142.134&#x27;</span>]<br>[ceph_deploy.new][<span class="hljs-built_in">DEBUG</span> ] Resolving host ceph_node1<br>[ceph_deploy.new][<span class="hljs-built_in">DEBUG</span> ] Monitor ceph_node1 at 192.168.142.134<br>[ceph_deploy.new][<span class="hljs-built_in">DEBUG</span> ] Monitor initial members are [<span class="hljs-string">&#x27;ceph_node1&#x27;</span>]<br>[ceph_deploy.new][<span class="hljs-built_in">DEBUG</span> ] Monitor addrs are [<span class="hljs-string">&#x27;192.168.142.134&#x27;</span>]<br>[ceph_deploy.new][<span class="hljs-built_in">DEBUG</span> ] Creating a random mon key<span class="hljs-built_in">..</span>.<br>[ceph_deploy.new][<span class="hljs-built_in">DEBUG</span> ] Writing monitor keyring <span class="hljs-keyword">to</span> ceph.mon.keyring<span class="hljs-built_in">..</span>.<br>[ceph_deploy.new][<span class="hljs-built_in">DEBUG</span> ] Writing initial<span class="hljs-built_in"> config </span><span class="hljs-keyword">to</span> ceph.conf<span class="hljs-built_in">..</span>.<br>[ceph-admin@ceph_admin cluster]$<br>[ceph-admin@ceph_admin cluster]$ ls<br>ceph.conf  ceph-deploy-ceph.log  ceph.mon.keyring<br>[ceph-admin@ceph_admin cluster]$<br><br><span class="hljs-comment">#在当前目录下的ceph.conf中添加以下两行内容</span><br>[ceph-admin@ceph_admin cluster]$ cat ceph.conf<br>public_network = 192.168.142.0/24<br>cluster_network = 192.168.241.0/24<br><br><span class="hljs-comment">#登录各个节点安装ceph</span><br><br>[ceph-admin@ceph_admin ~]$ ceph-deploy install --no-adjust-repos ceph_node1 ceph_node2 ceph_node3 <br><span class="hljs-comment">#每个节点需要安装提前安装sudo yum -y install python-setuptools</span><br><span class="hljs-comment">#如果安装不上可以直接sudo yum -y install ceph</span><br><br><span class="hljs-comment">#初始化mon的节点</span><br>[ceph-admin@ceph_admin cluster]$ ceph-deploy mon create-initial<br><br><br><span class="hljs-comment">#将认证密钥拷贝到其他节点，便于ceph命令行可以通过keyring和ceph集群进行交互，其他节点主机也能管理ceph集群</span><br>[ceph-admin@ceph_admin cluster]$ ceph-deploy admin ceph_node1 ceph_node2 ceph_node3<br><br></code></pre></td></tr></table></figure><p><strong>5、添加OSD硬盘</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">#查看节点上可以用的硬盘<br>[ceph-<span class="hljs-keyword">admin</span>@ceph_admin <span class="hljs-keyword">cluster</span>]$ ceph-deploy disk list ceph_node1 ceph_node2 ceph_node3<br>#例如格式化ceph_node1 的/dev/sdb<br>[ceph-<span class="hljs-keyword">admin</span>@ceph_admin <span class="hljs-keyword">cluster</span>]$ sudo ceph-deploy disk zap ceph_node1 /dev/sdb<br>[ceph_node1][WARNIN] <span class="hljs-comment">--&gt; Zapping successful for: &lt;Raw Device: /dev/sdb&gt;</span><br>#添加OSD<br>[ceph-<span class="hljs-keyword">admin</span>@ceph_admin <span class="hljs-keyword">cluster</span>]$ ceph-deploy osd <span class="hljs-keyword">create</span> <span class="hljs-comment">--data /dev/sdb ceph_node1</span><br>[ceph-<span class="hljs-keyword">admin</span>@ceph_admin <span class="hljs-keyword">cluster</span>]$ ceph-deploy osd <span class="hljs-keyword">create</span> <span class="hljs-comment">--data /dev/sdb ceph_node2</span><br>[ceph-<span class="hljs-keyword">admin</span>@ceph_admin <span class="hljs-keyword">cluster</span>]$ ceph-deploy osd <span class="hljs-keyword">create</span> <span class="hljs-comment">--data /dev/sdb ceph_node3</span><br>#可以看到ceph将新增osd创建文LVM格式加入ceph集群中<br>[ceph-<span class="hljs-keyword">admin</span>@ceph_node3 ~]$ sudo pvs<br>  PV         VG                                        Fmt  Attr PSize   PFree<br>  /dev/sda2  centos                                    lvm2 a<span class="hljs-comment">--  &lt;19.00g    0</span><br>  /dev/sdb   ceph<span class="hljs-number">-51501953</span><span class="hljs-number">-9</span>a57<span class="hljs-number">-4</span>f58-bcda<span class="hljs-number">-8</span>a9a2d8ab6e0 lvm2 a<span class="hljs-comment">--  &lt;10.00g    0</span><br>[ceph-<span class="hljs-keyword">admin</span>@ceph_node3 ~]$<br><br></code></pre></td></tr></table></figure><p><strong>6、部署MGR用于获</strong></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-comment">#部署MGR用于获取集群信息</span><br>(<span class="hljs-built_in">reverse</span>-i-search)`creat&#x27;: ceph-deploy mgr create ceph_node1<br></code></pre></td></tr></table></figure><p><img src="/img/Linux/osd.png"></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs dts">如果发现sudo ceph -s 出现health:HEALTH_WARN 的情况下需要 禁用掉不安全的模式<br>[ceph-admin@ceph_node1 ~]$ sudo ceph config set mon auth_allow_insecure_global_id_reclaim false<br><span class="hljs-meta">#查看集群的状态</span><br>[ceph-admin@ceph_node1 ~]$ sudo ceph -s<br><span class="hljs-symbol">  cluster:</span><br><span class="hljs-symbol">    id:</span>     <span class="hljs-number">04</span>af08e4<span class="hljs-number">-3541</span><span class="hljs-number">-4448</span>-b7b3-f456e1302083<br><span class="hljs-symbol">    health:</span> HEALTH_OK<br><span class="hljs-symbol"></span><br><span class="hljs-symbol">  services:</span><br><span class="hljs-symbol">    mon:</span> <span class="hljs-number">1</span> daemons, quorum ceph_node1 (age <span class="hljs-number">3</span>h)<br><span class="hljs-symbol">    mgr:</span> ceph_node1(active, since <span class="hljs-number">44</span>m)<br><span class="hljs-symbol">    osd:</span> <span class="hljs-number">3</span> osds: <span class="hljs-number">3</span> up (since <span class="hljs-number">54</span>m), <span class="hljs-number">3</span> in (since <span class="hljs-number">54</span>m)<br><span class="hljs-symbol"></span><br><span class="hljs-symbol">  data:</span><br><span class="hljs-symbol">    pools:</span>   <span class="hljs-number">0</span> pools, <span class="hljs-number">0</span> pgs<br><span class="hljs-symbol">    objects:</span> <span class="hljs-number">0</span> objects, <span class="hljs-number">0</span> B<br><span class="hljs-symbol">    usage:</span>   <span class="hljs-number">3.0</span> GiB used, <span class="hljs-number">27</span> GiB / <span class="hljs-number">30</span> GiB avail<br><span class="hljs-symbol">    pgs:</span><br><br>[ceph-admin@ceph_node1 ~]$<br><br>因<span class="hljs-keyword">/etc/</span>ceph/下key文件普通用户没有读权限，所以普通用户无权直接执行ceph命令<br>如果需要ceph-admin普通用户也可直接调用集群，增加对ceph配置文件的读权限即可<br>（想要每个节点普通用户都可以执行ceph相关命令，那就所有节点都修改权限）<br></code></pre></td></tr></table></figure><p><strong>7、修改普通用户ceph-admin有调用集群的权限</strong></p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs dts">[ceph-admin@ceph_node1 ~]$ sudo chmod +r <span class="hljs-keyword">/etc/</span>ceph/ceph.client.admin.keyring<br>[ceph-admin@ceph_node1 ~]$ ceph -s<br><span class="hljs-symbol">  cluster:</span><br><span class="hljs-symbol">    id:</span>     <span class="hljs-number">04</span>af08e4<span class="hljs-number">-3541</span><span class="hljs-number">-4448</span>-b7b3-f456e1302083<br><span class="hljs-symbol">    health:</span> HEALTH_OK<br><span class="hljs-symbol"></span><br><span class="hljs-symbol">  services:</span><br><span class="hljs-symbol">    mon:</span> <span class="hljs-number">1</span> daemons, quorum ceph_node1 (age <span class="hljs-number">3</span>h)<br><span class="hljs-symbol">    mgr:</span> ceph_node1(active, since <span class="hljs-number">54</span>m)<br><span class="hljs-symbol">    osd:</span> <span class="hljs-number">3</span> osds: <span class="hljs-number">3</span> up (since <span class="hljs-number">64</span>m), <span class="hljs-number">3</span> in (since <span class="hljs-number">64</span>m)<br><span class="hljs-symbol"></span><br><span class="hljs-symbol">  data:</span><br><span class="hljs-symbol">    pools:</span>   <span class="hljs-number">0</span> pools, <span class="hljs-number">0</span> pgs<br><span class="hljs-symbol">    objects:</span> <span class="hljs-number">0</span> objects, <span class="hljs-number">0</span> B<br><span class="hljs-symbol">    usage:</span>   <span class="hljs-number">3.0</span> GiB used, <span class="hljs-number">27</span> GiB / <span class="hljs-number">30</span> GiB avail<br><span class="hljs-symbol">    pgs:</span><br><br>[ceph-admin@ceph_node1 ~]$<br><br></code></pre></td></tr></table></figure><h2 id="三、配置Mgr-Dashboard模块"><a href="#三、配置Mgr-Dashboard模块" class="headerlink" title="三、配置Mgr-Dashboard模块"></a>三、配置Mgr-Dashboard模块</h2><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-comment">#安装ceph-mgr-dashboard，在mgr的节点上安装</span><br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$ <span class="hljs-string">sudo</span> <span class="hljs-string">yum</span> -<span class="hljs-string">y</span> <span class="hljs-string">install</span> <span class="hljs-string">ceph-mgr-dashboard</span><br><span class="hljs-comment">#开启mgr的dashboard模块</span><br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$ <span class="hljs-string">sudo</span> <span class="hljs-string">ceph</span> <span class="hljs-string">mgr</span> <span class="hljs-string">module</span> <span class="hljs-string">enable</span> <span class="hljs-string">dashboard</span><br><span class="hljs-comment">#默认情况下，仪表板的所有HTTP连接均使用SSL/TLS进行保护，快速启动并运行仪表板，可以使用以下命令生成并安装自签名证书</span><br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$ <span class="hljs-string">sudo</span> <span class="hljs-string">ceph</span> <span class="hljs-string">dashboard</span> <span class="hljs-built_in">create-self-signed-cert</span><br><span class="hljs-string">Self-signed</span> <span class="hljs-string">certificate</span> <span class="hljs-string">created</span><br><br><span class="hljs-comment">#创建具有管理员角色的用户：</span><br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$ <span class="hljs-string">sudo</span> <span class="hljs-string">ceph</span> <span class="hljs-string">dashboard</span> <span class="hljs-built_in">set-login-credentials</span> <span class="hljs-string">admin</span> <span class="hljs-string">admin</span><br><span class="hljs-string">Invalid</span> <span class="hljs-string">command</span>: <span class="hljs-string">unused</span> <span class="hljs-string">arguments</span>: [<span class="hljs-string">u</span><span class="hljs-string">&#x27;admin&#x27;</span>]<br><span class="hljs-string">dashboard</span> <span class="hljs-built_in">set-login-credentials</span> &lt;<span class="hljs-string">username</span>&gt; :  <span class="hljs-string">Set</span> <span class="hljs-string">the</span> <span class="hljs-string">login</span> <span class="hljs-string">credentials</span>. <span class="hljs-string">Password</span> <span class="hljs-string">read</span> <span class="hljs-string">from</span> -<span class="hljs-string">i</span> &lt;<span class="hljs-string">file</span>&gt;<br><span class="hljs-string">Error</span> <span class="hljs-string">EINVAL</span>: <span class="hljs-string">invalid</span> <span class="hljs-string">command</span><br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$<br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$ <span class="hljs-string">ls</span><br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$ <span class="hljs-string">vim</span> <span class="hljs-string">userpass</span><br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$ <span class="hljs-string">sudo</span> <span class="hljs-string">vim</span> <span class="hljs-string">userpass</span><br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$<br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$<br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$ <span class="hljs-string">sudo</span> <span class="hljs-string">ceph</span> <span class="hljs-string">dashboard</span> <span class="hljs-built_in">set-login-credentials</span> <span class="hljs-string">Narwal-admin</span> -<span class="hljs-string">i</span> <span class="hljs-string">userpass</span><br>******************************************************************<br>***          <span class="hljs-string">WARNING</span>: <span class="hljs-string">this</span> <span class="hljs-string">command</span> <span class="hljs-string">is</span> <span class="hljs-string">deprecated</span>.              ***<br>*** <span class="hljs-string">Please</span> <span class="hljs-string">use</span> <span class="hljs-string">the</span> <span class="hljs-string">ac-user</span>-* <span class="hljs-string">related</span> <span class="hljs-string">commands</span> <span class="hljs-string">to</span> <span class="hljs-string">manage</span> <span class="hljs-string">users</span>. ***<br>******************************************************************<br><span class="hljs-string">Username</span> <span class="hljs-string">and</span> <span class="hljs-string">password</span> <span class="hljs-string">updated</span><br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$<br><br><br><span class="hljs-comment">#查看ceph-mgr的服务:</span><br>[<span class="hljs-string">ceph-admin</span>@<span class="hljs-string">ceph_node1</span> ~]$ <span class="hljs-string">ceph</span> <span class="hljs-string">mgr</span> <span class="hljs-string">services</span><br>&#123;<br>    <span class="hljs-string">&quot;dashboard&quot;</span>: <span class="hljs-string">&quot;https://ceph_node1:8443/&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/img/Linux/dashboard.png"></p><h2 id="四、新增服务器实现扩容"><a href="#四、新增服务器实现扩容" class="headerlink" title="四、新增服务器实现扩容"></a>四、新增服务器实现扩容</h2><p><img src="/img/Linux/ceph_info2.png"></p><p><strong>1、进行基本的配置</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">#关闭防火墙和selinu(扩容节点进行)</span><br><br>[root@ceph_node4 ~]<span class="hljs-comment"># systemctl stop firewalld</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># systemctl disable firewalld</span><br>Removed <span class="hljs-keyword">symlink</span> /etc/systemd/<span class="hljs-keyword">system</span>/multi-user.target.wants/firewalld.service.<br>Removed <span class="hljs-keyword">symlink</span> /etc/systemd/<span class="hljs-keyword">system</span>/dbus-org.fedoraproject.FirewallD1.service.<br>[root@ceph_node4 ~]<span class="hljs-comment">#</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># sed -i &quot;s/SELINUX=enforcing/SELINUX=permissive/g&quot; /etc/selinux/config</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># getenforce</span><br>Enforcing<br>[root@ceph_node4 ~]<span class="hljs-comment"># setenforce 0</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># getenforce</span><br>Permissive<br>[root@ceph_node4 ~]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#配置hosts所有节点进行</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># cat /etc/hosts</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain<br>::<span class="hljs-number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6<br><span class="hljs-number">192.168</span>.<span class="hljs-number">142.134</span> ceph_node1<br><span class="hljs-number">192.168</span>.<span class="hljs-number">142.135</span> ceph_node2<br><span class="hljs-number">192.168</span>.<span class="hljs-number">142.136</span> ceph_node3<br><span class="hljs-number">192.168</span>.<span class="hljs-number">142.137</span> ceph_node4<br>[root@ceph_node4 ~]<span class="hljs-comment">#</span><br><br><br><span class="hljs-comment">#添加ceph-admin的账户</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># useradd ceph-admin</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># echo &quot;Lemon/123&quot; | passwd --stdin ceph-admin</span><br>Changing password <span class="hljs-keyword">for</span> user ceph-admin.<br>passwd: all authentication tokens updated successfully.<br>[root@ceph_node4 ~]<span class="hljs-comment"># echo &quot;ceph-admin ALL = NOPASSWD:ALL&quot; | tee /etc/sudoers.d/ceph-admin</span><br>ceph-admin ALL = NOPASSWD:ALL<br>[root@ceph_node4 ~]<span class="hljs-comment"># chmod 0400 /etc/sudoers.d/ceph-admin</span><br>[root@ceph_node4 ~]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#安装ntp并与ceph-admin服务器连接</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># yum -y install ntp</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># cat  /etc/ntp.conf | grep 130</span><br>server <span class="hljs-number">192.168</span>.<span class="hljs-number">142.130</span>  <span class="hljs-comment">#ceph-admin的ntp服务器</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># systemctl restart ntpd</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># systemctl enable ntpd</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># ntpq -p</span><br>     remote           refid      st t <span class="hljs-keyword">when</span> poll reach   delay   offset  jitter<br>==============================================================================<br> <span class="hljs-number">192.168</span>.<span class="hljs-number">142.130</span> <span class="hljs-number">120.25</span>.<span class="hljs-number">115.20</span>    <span class="hljs-number">3</span> u   <span class="hljs-number">16</span>   <span class="hljs-number">64</span>    <span class="hljs-number">1</span>    <span class="hljs-number">1.007</span>    <span class="hljs-number">1.223</span>   <span class="hljs-number">0</span>.<span class="hljs-number">000</span><br><br><br><span class="hljs-comment">#配置yum源</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># mkdir /mnt/repo_bak</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># mv /etc/yum.repos.d/* /mnt/repo_bak/</span><br>[root@ceph_node4 ~]<span class="hljs-comment">#</span><br>[root@ceph_node3 ~]<span class="hljs-comment"># scp /etc/yum.repos.d/* root@ceph_node4:/etc/yum.repos.d/</span><br></code></pre></td></tr></table></figure><p><strong>2、进行对增加的机器扩容</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs tap"><span class="hljs-comment">#安装ceph</span><br>[ceph-admin@ceph_node4 yum.repos.d]$ sudo yum -y install ceph ceph-radosgw<br><span class="hljs-comment">#扫描硬盘</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># echo &quot;- - -&quot; &gt; /sys/class/scsi_host/host0/scan</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># echo &quot;- - -&quot; &gt; /sys/class/scsi_host/host1/scan</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># echo &quot;- - -&quot; &gt; /sys/class/scsi_host/host2/scan</span><br>[root@ceph_node4 ~]<span class="hljs-comment">#</span><br>[root@ceph_node4 ~]<span class="hljs-comment"># lsblk</span><br>NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT<br>sda               8:0   <span class="hljs-number"> 0 </span>  20G <span class="hljs-number"> 0 </span>disk<br>├─sda1            8:1   <span class="hljs-number"> 0 </span>   1G <span class="hljs-number"> 0 </span>part /boot<br>└─sda2            8:2   <span class="hljs-number"> 0 </span>  19G <span class="hljs-number"> 0 </span>part<br>  ├─centos-root 253:0   <span class="hljs-number"> 0 </span>  17G <span class="hljs-number"> 0 </span>lvm  /<br>  └─centos-swap 253:1   <span class="hljs-number"> 0 </span>   2G <span class="hljs-number"> 0 </span>lvm  [SWAP]<br>sdb               8:16  <span class="hljs-number"> 0 </span>  10G <span class="hljs-number"> 0 </span>disk<br>sr0              11:0   <span class="hljs-number"> 1 </span>1024M <span class="hljs-number"> 0 </span>rom<br><br><span class="hljs-comment">#查看当前osd集群</span><br>[ceph-admin@ceph_node1 ~]$ ceph osd stat<br>3 osds:<span class="hljs-number"> 3 </span>up (since 23h),<span class="hljs-number"> 3 </span>in (since 23h); epoch: e1<br><span class="hljs-comment">#格式化硬盘</span><br>[ceph-admin@ceph_admin cluster]$ ceph-deploy disk zap ceph_node4 /dev/sdb<br><span class="hljs-comment">#将新增的节点的硬盘加入到集群osd当中</span><br>[ceph-admin@ceph_admin cluster]$ ceph-deploy osd create --data /dev/sdb ceph_node4<br><span class="hljs-comment">#查看加入后的osd集群</span><br>[ceph-admin@ceph_node1 ~]$ ceph osd stat<br>4 osds:<span class="hljs-number"> 4 </span>up (since 8s),<span class="hljs-number"> 4 </span>in (since 8s); epoch: e17<br><br></code></pre></td></tr></table></figure><p><strong>3、进行对新增加的硬盘实现扩容</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gradle">#识别硬盘当前服务器的硬盘<br>[root@ceph_node4 ~]# sudo echo <span class="hljs-string">&quot;- - -&quot;</span> &gt; <span class="hljs-regexp">/sys/</span><span class="hljs-keyword">class</span><span class="hljs-regexp">/scsi_host/</span>host0/scan<br>[root@ceph_node4 ~]# sudo echo <span class="hljs-string">&quot;- - -&quot;</span> &gt; <span class="hljs-regexp">/sys/</span><span class="hljs-keyword">class</span><span class="hljs-regexp">/scsi_host/</span>host1/scan<br>[root@ceph_node4 ~]# sudo echo <span class="hljs-string">&quot;- - -&quot;</span> &gt; <span class="hljs-regexp">/sys/</span><span class="hljs-keyword">class</span><span class="hljs-regexp">/scsi_host/</span>host2/scan<br>#查看硬盘空间<br>[ceph-admin@ceph_admin cluster]$ ceph-deploy disk list ceph_node4<br>[ceph_node4][INFO  ] Disk <span class="hljs-regexp">/dev/</span>sdc: <span class="hljs-number">10.7</span> GB, <span class="hljs-number">10737418240</span> bytes, <span class="hljs-number">20971520</span> sectors<br>#格式化硬盘<br>[ceph-admin@ceph_admin cluster]$ ceph-deploy disk zap ceph_node4 <span class="hljs-regexp">/dev/</span>sdc<br>[ceph_node4][WARNIN] --&gt; Zapping successful <span class="hljs-keyword">for</span>: &lt;Raw Device: <span class="hljs-regexp">/dev/</span>sdc&gt;<br>#将该硬盘添加进osd空间<br>[ceph-admin@ceph_admin cluster]$ ceph-deploy osd create --data <span class="hljs-regexp">/dev/</span>sdc ceph_node4<br>#查看集群的状态<br>[ceph-admin@ceph_node1 ~]$ ceph osd stat<br><span class="hljs-number">5</span> osds: <span class="hljs-number">5</span> up (since <span class="hljs-number">108</span>s), <span class="hljs-number">5</span> in (since <span class="hljs-number">108</span>s); epoch: e21<br></code></pre></td></tr></table></figure><p><strong>4、创建Pool的资源池</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">#创建一个名称叫ceph_demo pg是<span class="hljs-number">64</span>  pgp是<span class="hljs-number">64</span>的<br>[root@ceph_node1 ~]# ceph osd pool <span class="hljs-keyword">create</span> ceph-demo <span class="hljs-number">64</span> <span class="hljs-number">64</span><br>#查看pool池是否创建成功<br>[root@ceph_node1 ~]# ceph osd lspools<br><span class="hljs-number">1</span> ceph-demo<br><br>#另外<br>#可以将副本调整为<span class="hljs-number">3</span>个或者<span class="hljs-number">2</span>个<br>[root@ceph_node1 ~]# ceph osd pool <span class="hljs-keyword">get</span> ceph-demo size<br>size: <span class="hljs-number">2</span><br>[root@ceph_node1 ~]# ceph osd pool <span class="hljs-keyword">set</span> ceph-demo size <span class="hljs-number">3</span><br>#可以修改pg_num 或者 pgp_num<br>[root@ceph_node1 ~]# ceph osd pool <span class="hljs-keyword">get</span> ceph-demo pg_num<br>pg_num: <span class="hljs-number">128</span><br>[root@ceph_node1 ~]#<br>[root@ceph_node1 ~]# ceph osd pool <span class="hljs-keyword">set</span> ceph-demo pgp_num <span class="hljs-number">128</span><br><span class="hljs-keyword">set</span> pool <span class="hljs-number">1</span> pgp_num <span class="hljs-keyword">to</span> <span class="hljs-number">128</span><br>[root@ceph_node1 ~]# ceph osd pool <span class="hljs-keyword">get</span> ceph-demo pgp_num<br>pgp_num: <span class="hljs-number">128</span><br>[root@ceph_node1 ~]#<br></code></pre></td></tr></table></figure><p><strong>5、RBD的块设备存储创建、映射、扩容</strong></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-comment">#创建一个image大小为1G的文件</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># rbd create -p ceph-demo --image rbd-demo.img --size 1G</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># rbd -p ceph-demo ls</span><br>rbd-demo.img<br><span class="hljs-comment">#查看ceph-demo下的img的信息</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># rbd info ceph-demo/rbd-demo.img</span><br>rbd image <span class="hljs-string">&#x27;rbd-demo.img&#x27;</span>:<br>        size <span class="hljs-number">1</span> GiB in <span class="hljs-number">256</span> objects<br>        order <span class="hljs-number">22</span> (<span class="hljs-number">4</span> MiB objects)<br>        <span class="hljs-symbol">snapshot_count:</span> <span class="hljs-number">0</span><br>        <span class="hljs-symbol">id:</span> <span class="hljs-number">115e</span>d393ae63<br>        <span class="hljs-symbol">block_name_prefix:</span> rbd_data.<span class="hljs-number">115e</span>d393ae63<br>        <span class="hljs-symbol">format:</span> <span class="hljs-number">2</span><br>        <span class="hljs-symbol">features:</span> layering, exclusive-lock, object-map, fast-diff, deep-flatten<br>        <span class="hljs-symbol">op_features:</span><br>        <span class="hljs-symbol">flags:</span><br>        <span class="hljs-symbol">create_timestamp:</span> Thu Nov <span class="hljs-number">18</span> <span class="hljs-number">0</span>4:<span class="hljs-number">32</span>:<span class="hljs-number">50</span> <span class="hljs-number">2021</span><br>        <span class="hljs-symbol">access_timestamp:</span> Thu Nov <span class="hljs-number">18</span> <span class="hljs-number">0</span>4:<span class="hljs-number">32</span>:<span class="hljs-number">50</span> <span class="hljs-number">2021</span><br>        <span class="hljs-symbol">modify_timestamp:</span> Thu Nov <span class="hljs-number">18</span> <span class="hljs-number">0</span>4:<span class="hljs-number">32</span>:<span class="hljs-number">50</span> <span class="hljs-number">2021</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment">#</span><br><span class="hljs-comment">#可以删除img镜像</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># rbd rm -p ceph-demo --image rbd-demo.img</span><br><br><span class="hljs-comment">#挂载设备</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># rbd map ceph-demo/rbd-demo.img</span><br><span class="hljs-symbol">rbd:</span> sysfs write failed<br>RBD image feature set mismatch. You can disable features unsupported by the kernel <span class="hljs-keyword">with</span> <span class="hljs-string">&quot;rbd feature disable ceph-demo/rbd-demo.img object-map fast-diff deep-flatten&quot;</span>.<br>In some cases useful info is found in syslog - try <span class="hljs-string">&quot;dmesg | tail&quot;</span>.<br><span class="hljs-symbol">rbd:</span> map <span class="hljs-symbol">failed:</span> (<span class="hljs-number">6</span>) No such device or address<br><span class="hljs-comment">#可以根据提示禁用以下features</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># rbd feature disable ceph-demo/rbd-demo.img object-map fast-diff deep-flatten</span><br><span class="hljs-comment">#重新挂载块设备</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment">#  rbd map ceph-demo/rbd-demo.img</span><br><span class="hljs-regexp">/dev/rbd</span>0<br><span class="hljs-comment">#查看块设备挂载的情况</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># rbd device list</span><br>id pool      namespace image        snap device<br><span class="hljs-number">0</span>  ceph-demo           rbd-demo.img -    <span class="hljs-regexp">/dev/rbd</span>0<br><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># fdisk -l | grep /dev/rbd0</span><br>Disk /dev/<span class="hljs-symbol">rbd0:</span> <span class="hljs-number">1073</span> MB, <span class="hljs-number">1073741824</span> bytes, <span class="hljs-number">2097152</span> sectors<br><span class="hljs-comment">#格式化分区</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># mkfs.ext4 /dev/rbd0</span><br><span class="hljs-comment">#新建一个文件夹然后挂载</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># mkdir /mnt/rbd-demo</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># mount /dev/rbd0 /mnt/rbd-demo/</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># df -Th</span><br>Filesystem              Type      Size  Used Avail Use% Mounted on<br>devtmpfs                devtmpfs  <span class="hljs-number">898</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">898</span>M   <span class="hljs-number">0</span>% <span class="hljs-regexp">/dev</span><br><span class="hljs-regexp">tmpfs                   tmpfs     910M     0  910M   0% /dev</span><span class="hljs-regexp">/shm</span><br><span class="hljs-regexp">tmpfs                   tmpfs     910M   33M  878M   4% /run</span><br>tmpfs                   tmpfs     <span class="hljs-number">910</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">910</span>M   <span class="hljs-number">0</span>% <span class="hljs-regexp">/sys/fs</span><span class="hljs-regexp">/cgroup</span><br><span class="hljs-regexp">/dev</span><span class="hljs-regexp">/mapper/centos</span>-root xfs        <span class="hljs-number">17</span>G  <span class="hljs-number">2.8</span>G   <span class="hljs-number">15</span>G  <span class="hljs-number">17</span>% <span class="hljs-regexp">/</span><br><span class="hljs-regexp">/dev</span><span class="hljs-regexp">/sda1               xfs      1014M  176M  839M  18% /boot</span><br>tmpfs                   tmpfs     <span class="hljs-number">910</span>M   <span class="hljs-number">52</span>K  <span class="hljs-number">910</span>M   <span class="hljs-number">1</span>% <span class="hljs-regexp">/var/lib</span><span class="hljs-regexp">/ceph/osd</span><span class="hljs-regexp">/ceph-0</span><br><span class="hljs-regexp">tmpfs                   tmpfs     182M     0  182M   0% /run</span><span class="hljs-regexp">/user/</span><span class="hljs-number">0</span><br><span class="hljs-regexp">/dev/rbd</span>0               ext4      <span class="hljs-number">976</span>M  <span class="hljs-number">2.6</span>M  <span class="hljs-number">907</span>M   <span class="hljs-number">1</span>% <span class="hljs-regexp">/mnt/rbd</span>-demo<br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment">#</span><br>[root<span class="hljs-variable">@ceph_node1</span> rbd-demo]<span class="hljs-comment"># touch test</span><br>[root<span class="hljs-variable">@ceph_node1</span> rbd-demo]<span class="hljs-comment"># ll</span><br>total <span class="hljs-number">16</span><br>drwx------. <span class="hljs-number">2</span> root root <span class="hljs-number">16384</span> Nov <span class="hljs-number">18</span> <span class="hljs-number">0</span>5:<span class="hljs-number">29</span> lost+found<br>-rw-r--r--. <span class="hljs-number">1</span> root root     <span class="hljs-number">0</span> Nov <span class="hljs-number">18</span> <span class="hljs-number">0</span>5:<span class="hljs-number">31</span> test<br><br><span class="hljs-comment">##块设备的扩容</span><br>[root<span class="hljs-variable">@ceph_node1</span> rbd-demo]<span class="hljs-comment"># rbd resize ceph-demo/rbd-demo.img --size 2G</span><br>Resizing <span class="hljs-symbol">image:</span> <span class="hljs-number">100</span>% complete...done.<br>[root<span class="hljs-variable">@ceph_node1</span> rbd-demo]<span class="hljs-comment">#</span><br>[root<span class="hljs-variable">@ceph_node1</span> rbd-demo]<span class="hljs-comment"># rbd -p ceph-demo info --image rbd-demo.img</span><br>rbd image <span class="hljs-string">&#x27;rbd-demo.img&#x27;</span>:<br>        size <span class="hljs-number">2</span> GiB in <span class="hljs-number">512</span> objects<br>        order <span class="hljs-number">22</span> (<span class="hljs-number">4</span> MiB objects)<br>        <span class="hljs-symbol">snapshot_count:</span> <span class="hljs-number">0</span><br>        <span class="hljs-symbol">id:</span> <span class="hljs-number">115e</span>d393ae63<br>        <span class="hljs-symbol">block_name_prefix:</span> rbd_data.<span class="hljs-number">115e</span>d393ae63<br>        <span class="hljs-symbol">format:</span> <span class="hljs-number">2</span><br>        <span class="hljs-symbol">features:</span> layering, exclusive-lock<br>        <span class="hljs-symbol">op_features:</span><br>        <span class="hljs-symbol">flags:</span><br>        <span class="hljs-symbol">create_timestamp:</span> Thu Nov <span class="hljs-number">18</span> <span class="hljs-number">0</span>4:<span class="hljs-number">32</span>:<span class="hljs-number">50</span> <span class="hljs-number">2021</span><br>        <span class="hljs-symbol">access_timestamp:</span> Thu Nov <span class="hljs-number">18</span> <span class="hljs-number">0</span>4:<span class="hljs-number">32</span>:<span class="hljs-number">50</span> <span class="hljs-number">2021</span><br>        <span class="hljs-symbol">modify_timestamp:</span> Thu Nov <span class="hljs-number">18</span> <span class="hljs-number">0</span>4:<span class="hljs-number">32</span>:<span class="hljs-number">50</span> <span class="hljs-number">2021</span><br>[root<span class="hljs-variable">@ceph_node1</span> rbd-demo]<span class="hljs-comment">#</span><br><span class="hljs-comment">#块设备扩容成功后,再次进行对文件系统的扩容。</span><br>[root<span class="hljs-variable">@ceph_node1</span> rbd-demo]<span class="hljs-comment"># resize2fs /dev/rbd0</span><br>[root<span class="hljs-variable">@ceph_node1</span> rbd-demo]<span class="hljs-comment"># df -Th | grep /dev/rbd0</span><br><span class="hljs-regexp">/dev/rbd</span>0               ext4      <span class="hljs-number">2.0</span>G  <span class="hljs-number">3.0</span>M  <span class="hljs-number">1.9</span>G   <span class="hljs-number">1</span>% <span class="hljs-regexp">/mnt/rbd</span>-demo<br>[root<span class="hljs-variable">@ceph_node1</span> rbd-demo]<span class="hljs-comment">#</span><br><br><br><span class="hljs-comment">#rbg数据存储的一个过程是,一个文件会被切割成多个对象,而多个对象会被不同写入到不同的pg,pg在存储到不同的osd上的一个过程。</span><br><br></code></pre></td></tr></table></figure><p><strong>6、ceph告警设备的排查</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#可以查看到当前health是WRARN</span><br>[<span class="hljs-string">root@ceph_node1</span> <span class="hljs-string">rbd-demo</span>]<span class="hljs-comment"># ceph -s</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">id:</span>     <span class="hljs-string">04af08e4-3541-4448-b7b3-f456e1302083</span><br>    <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_WARN</span><br>            <span class="hljs-string">application</span> <span class="hljs-string">not</span> <span class="hljs-string">enabled</span> <span class="hljs-string">on</span> <span class="hljs-number">1</span> <span class="hljs-string">pool(s)</span><br><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mon:</span> <span class="hljs-number">1</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph_node1</span> <span class="hljs-string">(age</span> <span class="hljs-string">7d)</span><br>    <span class="hljs-attr">mgr:</span> <span class="hljs-string">ceph_node1(active,</span> <span class="hljs-string">since</span> <span class="hljs-string">6d)</span><br>    <span class="hljs-attr">osd: 5 osds:</span> <span class="hljs-number">5</span> <span class="hljs-string">up</span> <span class="hljs-string">(since</span> <span class="hljs-string">3d),</span> <span class="hljs-number">5</span> <span class="hljs-string">in</span> <span class="hljs-string">(since</span> <span class="hljs-string">3d)</span><br><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">pools:</span>   <span class="hljs-number">1</span> <span class="hljs-string">pools,</span> <span class="hljs-number">128</span> <span class="hljs-string">pgs</span><br>    <span class="hljs-attr">objects:</span> <span class="hljs-number">21</span> <span class="hljs-string">objects,</span> <span class="hljs-number">38</span> <span class="hljs-string">MiB</span><br>    <span class="hljs-attr">usage:</span>   <span class="hljs-number">5.2</span> <span class="hljs-string">GiB</span> <span class="hljs-string">used,</span> <span class="hljs-number">45</span> <span class="hljs-string">GiB</span> <span class="hljs-string">/</span> <span class="hljs-number">50</span> <span class="hljs-string">GiB</span> <span class="hljs-string">avail</span><br>    <span class="hljs-attr">pgs:</span>     <span class="hljs-number">128</span> <span class="hljs-string">active+clean</span><br><br><span class="hljs-comment"># 查看详细ceph健康信息</span><br>[<span class="hljs-string">root@ceph_node1</span> <span class="hljs-string">rbd-demo</span>]<span class="hljs-comment"># ceph health detail</span><br><span class="hljs-string">HEALTH_WARN</span> <span class="hljs-string">application</span> <span class="hljs-string">not</span> <span class="hljs-string">enabled</span> <span class="hljs-string">on</span> <span class="hljs-number">1</span> <span class="hljs-string">pool(s)</span><br><span class="hljs-string">POOL_APP_NOT_ENABLED</span> <span class="hljs-string">application</span> <span class="hljs-string">not</span> <span class="hljs-string">enabled</span> <span class="hljs-string">on</span> <span class="hljs-number">1</span> <span class="hljs-string">pool(s)</span><br>    <span class="hljs-string">application</span> <span class="hljs-string">not</span> <span class="hljs-string">enabled</span> <span class="hljs-string">on</span> <span class="hljs-string">pool</span> <span class="hljs-string">&#x27;ceph-demo&#x27;</span><br>    <span class="hljs-string">use</span> <span class="hljs-string">&#x27;ceph osd pool application enable &lt;pool-name&gt; &lt;app-name&gt;&#x27;</span><span class="hljs-string">,</span> <span class="hljs-string">where</span> <span class="hljs-string">&lt;app-name&gt;</span> <span class="hljs-string">is</span> <span class="hljs-string">&#x27;cephfs&#x27;</span><span class="hljs-string">,</span> <span class="hljs-string">&#x27;rbd&#x27;</span><span class="hljs-string">,</span> <span class="hljs-string">&#x27;rgw&#x27;</span><span class="hljs-string">,</span> <span class="hljs-string">or</span> <span class="hljs-string">freeform</span> <span class="hljs-string">for</span> <span class="hljs-string">custom</span> <span class="hljs-string">applications.</span><br>[<span class="hljs-string">root@ceph_node1</span> <span class="hljs-string">rbd-demo</span>]<span class="hljs-comment">#</span><br>[<span class="hljs-string">root@ceph_node1</span> <span class="hljs-string">rbd-demo</span>]<span class="hljs-comment">#</span><br><span class="hljs-comment">#启用application的rbd后告警显示消除</span><br>[<span class="hljs-string">root@ceph_node1</span> <span class="hljs-string">rbd-demo</span>]<span class="hljs-comment"># ceph osd pool application enable ceph-demo rbd</span><br><span class="hljs-string">enabled</span> <span class="hljs-string">application</span> <span class="hljs-string">&#x27;rbd&#x27;</span> <span class="hljs-string">on</span> <span class="hljs-string">pool</span> <span class="hljs-string">&#x27;ceph-demo&#x27;</span><br>[<span class="hljs-string">root@ceph_node1</span> <span class="hljs-string">rbd-demo</span>]<span class="hljs-comment"># ceph osd pool application get ceph-demo</span><br>&#123;<br>    <span class="hljs-attr">&quot;rbd&quot;:</span> &#123;&#125;<br>&#125;<br>[<span class="hljs-string">root@ceph_node1</span> <span class="hljs-string">rbd-demo</span>]<span class="hljs-comment"># ceph -s</span><br>  <span class="hljs-attr">cluster:</span><br>    <span class="hljs-attr">id:</span>     <span class="hljs-string">04af08e4-3541-4448-b7b3-f456e1302083</span><br>    <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_OK</span><br><br>  <span class="hljs-attr">services:</span><br>    <span class="hljs-attr">mon:</span> <span class="hljs-number">1</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph_node1</span> <span class="hljs-string">(age</span> <span class="hljs-string">7d)</span><br>    <span class="hljs-attr">mgr:</span> <span class="hljs-string">ceph_node1(active,</span> <span class="hljs-string">since</span> <span class="hljs-string">6d)</span><br>    <span class="hljs-attr">osd: 5 osds:</span> <span class="hljs-number">5</span> <span class="hljs-string">up</span> <span class="hljs-string">(since</span> <span class="hljs-string">3d),</span> <span class="hljs-number">5</span> <span class="hljs-string">in</span> <span class="hljs-string">(since</span> <span class="hljs-string">3d)</span><br><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">pools:</span>   <span class="hljs-number">1</span> <span class="hljs-string">pools,</span> <span class="hljs-number">128</span> <span class="hljs-string">pgs</span><br>    <span class="hljs-attr">objects:</span> <span class="hljs-number">21</span> <span class="hljs-string">objects,</span> <span class="hljs-number">38</span> <span class="hljs-string">MiB</span><br>    <span class="hljs-attr">usage:</span>   <span class="hljs-number">5.2</span> <span class="hljs-string">GiB</span> <span class="hljs-string">used,</span> <span class="hljs-number">45</span> <span class="hljs-string">GiB</span> <span class="hljs-string">/</span> <span class="hljs-number">50</span> <span class="hljs-string">GiB</span> <span class="hljs-string">avail</span><br>    <span class="hljs-attr">pgs:</span>     <span class="hljs-number">128</span> <span class="hljs-string">active+clean</span><br><br>[<span class="hljs-string">root@ceph_node1</span> <span class="hljs-string">rbd-demo</span>]<span class="hljs-comment"># ^C</span><br><br></code></pre></td></tr></table></figure><h2 id="五、RGW对象存储"><a href="#五、RGW对象存储" class="headerlink" title="五、RGW对象存储"></a>五、RGW对象存储</h2><p><strong>5.1 部署RGW存储对象网关</strong></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs elixir">[ceph-admin<span class="hljs-variable">@ceph_admin</span> cluster]<span class="hljs-variable">$ </span>sudo yum -y install ceph-radosgw.x86_64<br><span class="hljs-comment">#监听7480的端口</span><br>[ceph-admin<span class="hljs-variable">@ceph_admin</span> cluster]<span class="hljs-variable">$ </span>ceph-deploy rgw create ceph_node1<br><span class="hljs-comment">#可以通过端口去访问</span><br>[ceph-admin<span class="hljs-variable">@ceph_admin</span> cluster]<span class="hljs-variable">$ </span>curl <span class="hljs-symbol">http:</span>//<span class="hljs-symbol">ceph_node1:</span><span class="hljs-number">7480</span><br>&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;&lt;<span class="hljs-title class_">ListAllMyBucketsResult</span> xmlns=<span class="hljs-string">&quot;http://s3.amazonaws.com/doc/2006-03-01/&quot;</span>&gt;&lt;<span class="hljs-title class_">Owner</span>&gt;&lt;<span class="hljs-title class_">ID</span>&gt;anonymous&lt;/<span class="hljs-title class_">ID</span>&gt;&lt;<span class="hljs-title class_">DisplayName</span>&gt;&lt;/<span class="hljs-title class_">DisplayName</span>&gt;&lt;/<span class="hljs-title class_">Owner</span>&gt;&lt;<span class="hljs-title class_">Buckets</span>&gt;&lt;/<span class="hljs-title class_">Buckets</span>&gt;&lt;/<span class="hljs-title class_">ListAllMyBucketsResult</span>&gt;[ceph-admin<span class="hljs-variable">@ceph_admin</span> cluster]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><br><span class="hljs-comment">#修改rgw的端口，修改为80端口</span><br>[ceph-admin<span class="hljs-variable">@ceph_admin</span> cluster]<span class="hljs-variable">$ </span>cat ceph.conf<br>[global]<br>fsid = <span class="hljs-number">04</span>af08e4<span class="hljs-number">-3541</span><span class="hljs-number">-4448</span>-b7b3-f456e1302083<br>mon_initial_members = ceph_node1<br>mon_host = <span class="hljs-number">192.168</span>.<span class="hljs-number">142.134</span><br>auth_cluster_required = cephx<br>auth_service_required = cephx<br>auth_client_required = cephx<br>public_network = <span class="hljs-number">192.168</span>.<span class="hljs-number">142.0</span>/<span class="hljs-number">24</span><br>cluster_network = <span class="hljs-number">192.168</span>.<span class="hljs-number">241.0</span>/<span class="hljs-number">24</span><br><br>[client.rgw.ceph_node1]<br>rgw_frontends = <span class="hljs-string">&quot;civetweb port=80&quot;</span><br>[ceph-admin<span class="hljs-variable">@ceph_admin</span> cluster]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><span class="hljs-comment">#重启rgw的网关</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo systemctl restart ceph-radosgw.target<br><span class="hljs-comment">#监听80的端口</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo netstat -antupl | grep <span class="hljs-string">&quot;80&quot;</span><br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span><span class="hljs-symbol">:</span><span class="hljs-number">80</span>              <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span><span class="hljs-symbol">:*</span>               <span class="hljs-title class_">LISTEN</span>      <span class="hljs-number">116097</span>/radosgw<br><br><br></code></pre></td></tr></table></figure><p><strong>5.2 RGW之S3接口使用</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">#新建一个访问S3的账户<br>[ceph-<span class="hljs-keyword">admin</span>@ceph_node1 ~]$ radosgw-<span class="hljs-keyword">admin</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">create</span> <span class="hljs-comment">--uid ceph-s3-user --display-name &quot;Ceph S3 User Demo&quot;</span><br>#测试S3的接口，需要安装 python-boto 包.<br>[ceph-<span class="hljs-keyword">admin</span>@ceph_node1 ~]$ sudo yum -y install python-boto<br>#新建 Python 脚本:<br>[ceph-<span class="hljs-keyword">admin</span>@ceph_node1 ~]$ cat s3test.py<br>#!/usr/bin/python<br># -*- coding: utf<span class="hljs-number">-8</span> -*-<br><span class="hljs-keyword">import</span> boto<br><span class="hljs-keyword">import</span> boto.s3.<span class="hljs-keyword">connection</span><br>access_key = <span class="hljs-string">&#x27;DTQTVDPZYJY730YJYLM3&#x27;</span> #modify <span class="hljs-keyword">user</span> key<br>secret_key = <span class="hljs-string">&#x27;w5dHYKreB5aNyrmGXWwwewjVLg8cDA9hMDL7kPsT&#x27;</span><br>conn = boto.connect_s3(<br>        aws_access_key_id = access_key,<br>        aws_secret_access_key = secret_key,<br>        host = <span class="hljs-string">&#x27;192.168.142.134&#x27;</span>,port=<span class="hljs-number">80</span>, #hostname<br>        is_secure=<span class="hljs-keyword">False</span>,calling_format = boto.s3.<span class="hljs-keyword">connection</span>.OrdinaryCallingFormat(),)<br>bucket = conn.create_bucket(<span class="hljs-string">&#x27;ceph-s3-bucket&#x27;</span>) #modify bucket <span class="hljs-type">name</span> <span class="hljs-keyword">is</span> ceph-s3-<span class="hljs-keyword">user</span>-bucket<br><span class="hljs-keyword">for</span> bucket <span class="hljs-keyword">in</span> conn.get_all_buckets():<br>        print &quot;&#123;name&#125;\t&#123;created&#125;&quot;.format(<br>                <span class="hljs-type">name</span> = bucket.name,<br>                created = bucket.creation_date,<br>)<br>[ceph-<span class="hljs-keyword">admin</span>@ceph_node1 ~]$<br>#可以看到新建出了一个buckets.<span class="hljs-keyword">index</span>的pool<br>[ceph-<span class="hljs-keyword">admin</span>@ceph_node1 ~]$ ceph osd lspools<br><span class="hljs-number">1</span> ceph-demo<br><span class="hljs-number">2</span> .rgw.root<br><span class="hljs-number">3</span> <span class="hljs-keyword">default</span>.rgw.control<br><span class="hljs-number">4</span> <span class="hljs-keyword">default</span>.rgw.meta<br><span class="hljs-number">5</span> <span class="hljs-keyword">default</span>.rgw.<span class="hljs-keyword">log</span><br><span class="hljs-number">6</span> <span class="hljs-keyword">default</span>.rgw.buckets.<span class="hljs-keyword">index</span><br><br></code></pre></td></tr></table></figure><p><strong>5.3 S3cmd管理</strong></p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs vhdl">#先下载s3cmd的工具<br>[ceph-admin@ceph_node1 ~]$ sudo yum -y install s3cmd<br>#在进行配置<br>[ceph-admin@ceph_node1 ~]$ s3cmd <span class="hljs-comment">--configure</span><br><br>Enter <span class="hljs-keyword">new</span> values <span class="hljs-keyword">or</span> accept defaults <span class="hljs-keyword">in</span> brackets <span class="hljs-keyword">with</span> Enter.<br>Refer <span class="hljs-keyword">to</span> user manual <span class="hljs-keyword">for</span> detailed description <span class="hljs-keyword">of</span> <span class="hljs-keyword">all</span> options.<br><br><span class="hljs-keyword">Access</span> key <span class="hljs-keyword">and</span> Secret key are your identifiers <span class="hljs-keyword">for</span> Amazon S3. Leave them empty <span class="hljs-keyword">for</span> using the env variables.<br><span class="hljs-keyword">Access</span> Key: DTQTVDPZYJY730YJYLM3<br>Secret Key: w5dHYKreB5aNyrmGXWwwewjVLg8cDA9hMDL7kPsT<br><span class="hljs-keyword">Default</span> Region [US]:<br><br><span class="hljs-keyword">Use</span> <span class="hljs-string">&quot;s3.amazonaws.com&quot;</span> <span class="hljs-keyword">for</span> S3 Endpoint <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> modify it <span class="hljs-keyword">to</span> the target Amazon S3.<br>S3 Endpoint [s3.amazonaws.com]: <span class="hljs-number">192.168</span>.<span class="hljs-number">142.134</span><br><br><span class="hljs-keyword">Use</span> <span class="hljs-string">&quot;%(bucket)s.s3.amazonaws.com&quot;</span> <span class="hljs-keyword">to</span> the target Amazon S3. <span class="hljs-string">&quot;%(bucket)s&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;%(location)s&quot;</span> vars can be used<br><span class="hljs-keyword">if</span> the target S3 system supports dns based buckets.<br>DNS-style bucket+hostname:<span class="hljs-keyword">port</span> template <span class="hljs-keyword">for</span> accessing a bucket [%(bucket)s.s3.amazonaws.com]: <span class="hljs-number">192.168</span>.<span class="hljs-number">142.134</span>:<span class="hljs-number">80</span>/%(bucket)s<br><br>Encryption password <span class="hljs-keyword">is</span> used <span class="hljs-keyword">to</span> protect your files from reading<br>by unauthorized persons <span class="hljs-keyword">while</span> <span class="hljs-keyword">in</span> transfer <span class="hljs-keyword">to</span> S3<br>Encryption password:<br>Path <span class="hljs-keyword">to</span> GPG program [/bin/gpg]:<br><br><span class="hljs-keyword">When</span> using secure HTTPS protocol <span class="hljs-keyword">all</span> communication <span class="hljs-keyword">with</span> Amazon S3<br>servers <span class="hljs-keyword">is</span> <span class="hljs-keyword">protected</span> from <span class="hljs-number">3</span>rd party eavesdropping. This method <span class="hljs-keyword">is</span><br>slower than plain HTTP, <span class="hljs-keyword">and</span> can only be proxied <span class="hljs-keyword">with</span> Python <span class="hljs-number">2.7</span> <span class="hljs-keyword">or</span> newer<br><span class="hljs-keyword">Use</span> HTTPS protocol [Yes]: no<br><br><span class="hljs-keyword">On</span> some networks <span class="hljs-keyword">all</span> internet <span class="hljs-keyword">access</span> must go through a HTTP proxy.<br>Try setting it here <span class="hljs-keyword">if</span> you can<span class="hljs-symbol">&#x27;t</span> connect <span class="hljs-keyword">to</span> S3 directly<br>HTTP Proxy server name:<br><br><span class="hljs-keyword">New</span> settings:<br>  <span class="hljs-keyword">Access</span> Key: DTQTVDPZYJY730YJYLM3<br>  Secret Key: w5dHYKreB5aNyrmGXWwwewjVLg8cDA9hMDL7kPsT<br>  <span class="hljs-keyword">Default</span> Region: US<br>  S3 Endpoint: <span class="hljs-number">192.168</span>.<span class="hljs-number">142.134</span><br>  DNS-style bucket+hostname:<span class="hljs-keyword">port</span> template <span class="hljs-keyword">for</span> accessing a bucket: <span class="hljs-number">192.168</span>.<span class="hljs-number">142.134</span>:<span class="hljs-number">80</span>/%(bucket)s<br>  Encryption password:<br>  Path <span class="hljs-keyword">to</span> GPG program: /bin/gpg<br>  <span class="hljs-keyword">Use</span> HTTPS protocol: <span class="hljs-literal">False</span><br>  HTTP Proxy server name:<br>  HTTP Proxy server <span class="hljs-keyword">port</span>: <span class="hljs-number">0</span><br><br>Test <span class="hljs-keyword">access</span> <span class="hljs-keyword">with</span> supplied credentials? [Y/n] y<br>Please <span class="hljs-keyword">wait</span>, attempting <span class="hljs-keyword">to</span> list <span class="hljs-keyword">all</span> buckets...<br>Success. Your <span class="hljs-keyword">access</span> key <span class="hljs-keyword">and</span> secret key worked fine :-)<br><br>Now verifying that encryption works...<br><span class="hljs-keyword">Not</span> configured. Never mind.<br><br>Save settings? [y/N] y<br><span class="hljs-keyword">Configuration</span> saved <span class="hljs-keyword">to</span> &#x27;/home/ceph-admin/.s3cfg&#x27;<br>[ceph-admin@ceph_node1 ~]$<br>#可以看到刚刚生成的一个配置文件<br>[ceph-admin@ceph_node1 ~]$ cat /home/ceph-admin/.s3cfg<br>#创建一个对象存储<br>[ceph-admin@ceph_node1 ~]$ s3cmd mb s3://s3cmd-demo<br>Bucket <span class="hljs-symbol">&#x27;s3</span>://s3cmd-demo/&#x27; created<br>#可以看到当下有那些<br>[ceph-admin@ceph_node1 ~]$ s3cmd ls<br><span class="hljs-number">2021</span>-<span class="hljs-number">11</span>-<span class="hljs-number">22</span> <span class="hljs-number">04</span>:<span class="hljs-number">06</span>  s3://ceph-s3-bucket<br><span class="hljs-number">2021</span>-<span class="hljs-number">11</span>-<span class="hljs-number">22</span> <span class="hljs-number">04</span>:<span class="hljs-number">18</span>  s3://s3cmd-demo<br><br>创建、上传、下载、查看、删除<br>#创建<br>s3cmd mb s3://BUCKET<br>#上传<br>[ceph-admin@ceph_node1 ~]$ s3cmd put /etc/fstab s3://s3cmd-demo/test_fstab<br>[ceph-admin@ceph_node1 ~]$ s3cmd put /etc/ s3://s3cmd-demo/etc <span class="hljs-comment">--recursive</span><br>#查看<br>[ceph-admin@ceph_node1 ~]$ s3cmd ls s3://s3cmd-demo/<br>#下载<br>[ceph-admin@ceph_node1 ~]$ s3cmd get s3://s3cmd-demo/etc/resolv.conf resolv.conf<br>#删除<br>[ceph-admin@ceph_node1 ~]$ s3cmd rm s3://s3cmd-demo/test_fstab<br>#查看帮助指导<br>[ceph-admin@ceph_node1 ~]$ s3cmd <span class="hljs-comment">--help </span><br></code></pre></td></tr></table></figure><p><strong>5.4 swift风格API接口</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">RADOS</span>网关用户管理工具常用命令<span class="hljs-selector-tag">-radosgw-admin</span> (<span class="hljs-attribute">http</span>:<span class="hljs-comment">//www.hulihutu.me/?p=236)</span><br><br><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ radosgw-admin user list<br>[<br>    <span class="hljs-string">&quot;ceph-s3-user&quot;</span><br>]<br>#创建一个swift的user，权限是full<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ sudo radosgw-admin subuser create --uid=<span class="hljs-string">&quot;ceph-s3-user&quot;</span> --subuser=<span class="hljs-string">&quot;ceph-s3-user:swift&quot;</span>  --access=full<br>#创建一个secret<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ radosgw-admin key create --subuser=<span class="hljs-string">&quot;ceph-s3-user:swift&quot;</span> --key-type=swift --gen-secret<br><br>#升级pip，低版本直接升级到高版本可能会报错<br>wget <span class="hljs-attribute">https</span>:<span class="hljs-comment">//files.pythonhosted.org/packages/0b/f5/be8e741434a4bf4ce5dbc235aa28ed0666178ea8986ddc10d035023744e6/pip-20.2.4.tar.gz  #下载安装包</span><br>tar -zxvf pip-<span class="hljs-number">20.2</span>.<span class="hljs-number">4</span>.tar.gz  # 解压<br>cd pip-<span class="hljs-number">20.2</span>.<span class="hljs-number">4</span>/<br>sudo python setup.py install #给予权限不然可能安装失败<br>pip install -U pip #再次更新<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ /bin/python -m pip install --upgrade pip<br><br>#安装swift的客户端<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ pip install python-swiftclient<br>#swift查询创建测bucket<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ swift -A <span class="hljs-attribute">http</span>:<span class="hljs-comment">//192.168.142.134:80/auth -U ceph-s3-user:swift -K Xhitxsypvp5kPE0eWCpxIjatJCU34UznQaeAOAHJ list</span><br>ceph-s3-bucket<br>s3cmd-demo<br><br>#可以定义环境变量<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ swift list<br>Auth version <span class="hljs-number">1.0</span> requires ST_AUTH, ST_USER, <span class="hljs-keyword">and</span> ST_KEY environment variables<br>to be set or overridden with -A, -U, or -K.<br><br>Auth version <span class="hljs-number">2.0</span> requires OS_AUTH_URL, OS_USERNAME, OS_PASSWORD, <span class="hljs-keyword">and</span><br>OS_TENANT_NAME OS_TENANT_ID to be set or overridden with --os-auth-url,<br>--os-username, --os-password, --os-tenant-name or os-tenant-id. <span class="hljs-attribute">Note</span>:<br>adding <span class="hljs-string">&quot;-V 2&quot;</span> is necessary for this.<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ export ST_AUTH=<span class="hljs-attribute">http</span>:<span class="hljs-comment">//192.168.142.134:80/auth</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ export ST_USER=<span class="hljs-attribute">ceph-s3-user</span>:swift<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ export ST_KEY=Xhitxsypvp5kPE0eWCpxIjatJCU34UznQaeAOAHJ<br>#创建、上传、下载、删除、查看<br>#创建<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ swift post swift-demo<br>#上传<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ swift upload swift-demo /etc/passwd<br>#下载<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ swift download swift-demo etc/passwd<br>#删除<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ swift delete swift-demo<br>#查看<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]$ swift list<br></code></pre></td></tr></table></figure><h2 id="六、CephFS文件存储"><a href="#六、CephFS文件存储" class="headerlink" title="六、CephFS文件存储"></a>六、CephFS文件存储</h2><p><strong>6.1 部署RGW存储对象网关</strong></p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs tap"><span class="hljs-comment">#部署mds在ceph-node1节点上</span><br>[ceph-admin@ceph_admin cluster]$ ceph-deploy mds create ceph_node1<br><span class="hljs-comment">#将node2,node3,都部署上mds,配置成高可用模式</span><br>[ceph-admin@ceph_admin cluster]$ ceph-deploy mds create ceph_node2 ceph_node3<br><span class="hljs-comment">#创建谦</span><br>data:<br>    pools:  <span class="hljs-number"> 7 </span>pools,<span class="hljs-number"> 320 </span>pgs<br>    objects:<span class="hljs-number"> 252 </span>objects,<span class="hljs-number"> 42 </span>MiB<br>    usage:   5.2 GiB used,<span class="hljs-number"> 45 </span>GiB /<span class="hljs-number"> 50 </span>GiB avail<br>    pgs:    <span class="hljs-number"> 320 </span>active+clean<br><br><span class="hljs-comment">#创建一个文件系统，设置PG数为8</span><br>[ceph-admin@ceph_node1 ~]$ ceph osd pool create cpehfs_metadata<span class="hljs-number"> 8 </span>8<br>[ceph-admin@ceph_node1 ~]$ ceph osd pool create cephfs_data<span class="hljs-number"> 8 </span>8<br><span class="hljs-comment">#创建后</span><br> data:<br>    pools:  <span class="hljs-number"> 9 </span>pools,<span class="hljs-number"> 336 </span>pgs<br>    objects:<span class="hljs-number"> 252 </span>objects,<span class="hljs-number"> 42 </span>MiB<br>    usage:   5.2 GiB used,<span class="hljs-number"> 45 </span>GiB /<span class="hljs-number"> 50 </span>GiB avail<br>    pgs:     2.381% pgs unknown<br>            <span class="hljs-number"> 328 </span>active+clean<br>            <span class="hljs-number"> 8 </span>  unknown<br><span class="hljs-comment">#查看lspool的资源池             </span><br>[ceph-admin@ceph_node1 ~]$ ceph osd lspools<br>1 ceph-demo<br>2 .rgw.root<br>3 default.rgw.control<br>4 default.rgw.meta<br>5 default.rgw.log<br>6 default.rgw.buckets.index<br>7 default.rgw.buckets.data<br>8 cpehfs_metadata<br>9 cephfs_data<br><br><span class="hljs-comment">#创建文件存储pool后，mds会启用</span><br>[ceph-admin@ceph_node1 ~]$ ceph fs new cephfs-demo cpehfs_metadata cephfs_data<br>new fs with metadata pool<span class="hljs-number"> 8 </span>and data pool 9<br></code></pre></td></tr></table></figure><p><img src="/img/Linux/osd2.png"></p><p><strong>6.2 文件系统挂载–内核驱动挂载</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#例如,path-to-mounted指的是服务器的挂载点   mount-point指的是挂载到哪个地方    name=&#123;user-name&#125; 挂载使用认证的方式</span><br>sudo mount -t ceph :&#123;path-to-mounted&#125; &#123;mount-point&#125; -o name=&#123;user-name&#125;<br>sudo mount -t ceph :<span class="hljs-regexp">/  /m</span>nt/mycephfs -o name=admin<br><br><span class="hljs-comment">#创建一个存放文件</span><br>[ceph-admin@ceph_node1 ~]$ sudo mkdir <span class="hljs-regexp">/mnt/</span>cephfs<br><span class="hljs-comment">#将192.168.142.134的ceph空间挂载到/mnt/cephfs路径上</span><br>[ceph-admin@ceph_node1 ~]$ sudo mount.ceph <span class="hljs-number">192.168</span>.<span class="hljs-number">142.134</span>:<span class="hljs-number">6789</span>:<span class="hljs-regexp">/  /m</span>nt/cephfs  -o name=admin<br>[ceph-admin@ceph_node1 ~]$ df -h<br>Filesystem               Size  Used Avail Use% Mounted on<br>devtmpfs                 <span class="hljs-number">898</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">898</span>M   <span class="hljs-number">0</span>% /dev<br>tmpfs                    <span class="hljs-number">910</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">910</span>M   <span class="hljs-number">0</span>% <span class="hljs-regexp">/dev/</span>shm<br>tmpfs                    <span class="hljs-number">910</span>M   <span class="hljs-number">45</span>M  <span class="hljs-number">866</span>M   <span class="hljs-number">5</span>% /run<br>tmpfs                    <span class="hljs-number">910</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">910</span>M   <span class="hljs-number">0</span>% <span class="hljs-regexp">/sys/</span>fs/cgroup<br><span class="hljs-regexp">/dev/m</span>apper<span class="hljs-regexp">/centos-root   17G  2.9G   15G  17% /</span><br><span class="hljs-regexp">/dev/</span>sda1               <span class="hljs-number">1014</span>M  <span class="hljs-number">176</span>M  <span class="hljs-number">839</span>M  <span class="hljs-number">18</span>% /boot<br>tmpfs                    <span class="hljs-number">182</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">182</span>M   <span class="hljs-number">0</span>% <span class="hljs-regexp">/run/u</span>ser/<span class="hljs-number">0</span><br><span class="hljs-regexp">/dev/</span>rbd0                <span class="hljs-number">2.0</span>G  <span class="hljs-number">3.0</span>M  <span class="hljs-number">1.9</span>G   <span class="hljs-number">1</span>% <span class="hljs-regexp">/mnt/</span>rbd-demo<br><span class="hljs-number">192.168</span>.<span class="hljs-number">142.134</span>:<span class="hljs-number">6789</span>:<span class="hljs-regexp">/    15G     0   15G   0% /m</span>nt/cephfs<br><br></code></pre></td></tr></table></figure><p><strong>6.3 文件系统挂载–用户空间挂载</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs awk">[ceph-admin@ceph_node1 ~]$ ceph-fuse -h<br>usage: ceph-fuse [-n client.username] [-m mon-ip-addr:mon-port] &lt;mount point&gt; [OPTIONS]<br>  --client_mountpoint/-r &lt;sub_directory&gt;<br>                    use sub_directory as the mounted root, rather than the full Ceph tree.<br>                    <br>                    <br><span class="hljs-comment">#安装ceph-fuse客户端</span><br>[ceph-admin@ceph_node1 ~]$ sudo yum -y install ceph-fuse<br>[ceph-admin@ceph_node1 ~]$ mkdir <span class="hljs-regexp">/mnt/</span>ceph-fuse<br><br><span class="hljs-comment">#挂载-m指的是mon的节点，可以挂载多个mon的节点, -n是ceph内置的admin</span><br>[ceph-admin@ceph_node1 ~]$ sudo ceph-fuse -n client.admin -m <span class="hljs-number">192.168</span>.<span class="hljs-number">142.134</span>:<span class="hljs-number">6789</span> <span class="hljs-regexp">/mnt/</span>ceph-fuse<br>ceph-fuse[<span class="hljs-number">2021</span>-<span class="hljs-number">11</span>-<span class="hljs-number">23</span> <span class="hljs-number">21</span>:<span class="hljs-number">44</span>:<span class="hljs-number">17.656</span> <span class="hljs-number">7</span>f72b94b1f80 -<span class="hljs-number">1</span> init, newargv = <span class="hljs-number">0</span>x5596d9d2f930 newargc=<span class="hljs-number">9</span><br><span class="hljs-number">132714</span>]: starting ceph client<br>ceph-fuse[<span class="hljs-number">132714</span>]: starting fuse<br>[ceph-admin@ceph_node1 ~]$ df -h<br>Filesystem               Size  Used Avail Use% Mounted on<br>devtmpfs                 <span class="hljs-number">898</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">898</span>M   <span class="hljs-number">0</span>% /dev<br>tmpfs                    <span class="hljs-number">910</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">910</span>M   <span class="hljs-number">0</span>% <span class="hljs-regexp">/dev/</span>shm<br>tmpfs                    <span class="hljs-number">910</span>M   <span class="hljs-number">45</span>M  <span class="hljs-number">866</span>M   <span class="hljs-number">5</span>% /run<br>tmpfs                    <span class="hljs-number">910</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">910</span>M   <span class="hljs-number">0</span>% <span class="hljs-regexp">/sys/</span>fs/cgroup<br><span class="hljs-regexp">/dev/m</span>apper<span class="hljs-regexp">/centos-root   17G  2.9G   15G  18% /</span><br><span class="hljs-regexp">/dev/</span>sda1               <span class="hljs-number">1014</span>M  <span class="hljs-number">176</span>M  <span class="hljs-number">839</span>M  <span class="hljs-number">18</span>% /boot<br>tmpfs                    <span class="hljs-number">182</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">182</span>M   <span class="hljs-number">0</span>% <span class="hljs-regexp">/run/u</span>ser/<span class="hljs-number">0</span><br><span class="hljs-regexp">/dev/</span>rbd0                <span class="hljs-number">2.0</span>G  <span class="hljs-number">3.0</span>M  <span class="hljs-number">1.9</span>G   <span class="hljs-number">1</span>% <span class="hljs-regexp">/mnt/</span>rbd-demo<br><span class="hljs-number">192.168</span>.<span class="hljs-number">142.134</span>:<span class="hljs-number">6789</span>:<span class="hljs-regexp">/    15G     0   15G   0% /m</span>nt/cephfs<br>ceph-fuse                 <span class="hljs-number">15</span>G     <span class="hljs-number">0</span>   <span class="hljs-number">15</span>G   <span class="hljs-number">0</span>% <span class="hljs-regexp">/mnt/</span>ceph-fuse<br><br></code></pre></td></tr></table></figure><p><strong>6.4 删除之前创建失败的osd</strong></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment">#从集群中删除down掉的osd</span><br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph osd rm osd.<span class="hljs-number">1</span><br>removed osd.<span class="hljs-number">1</span><br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>ceph osd tree<br><span class="hljs-title class_">ID</span> <span class="hljs-title class_">CLASS</span> <span class="hljs-title class_">WEIGHT</span>  <span class="hljs-title class_">TYPE</span> <span class="hljs-title class_">NAME</span>                <span class="hljs-title class_">STATUS</span> <span class="hljs-title class_">REWEIGHT</span> <span class="hljs-title class_">PRI</span>-<span class="hljs-title class_">AFF</span><br><span class="hljs-number">-1</span>       <span class="hljs-number">0.87900</span> root default<br><span class="hljs-number">-3</span>       <span class="hljs-number">0.29300</span>     host szbd-ceph-node1<br> <span class="hljs-number">0</span>   hdd <span class="hljs-number">0.29300</span>         osd.<span class="hljs-number">0</span>                up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-5</span>       <span class="hljs-number">0.29300</span>     host szbd-ceph-node2<br> <span class="hljs-number">5</span>   hdd <span class="hljs-number">0.29300</span>         osd.<span class="hljs-number">5</span>                up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br><span class="hljs-number">-7</span>       <span class="hljs-number">0.29300</span>     host szbd-ceph-node3<br> <span class="hljs-number">6</span>   hdd <span class="hljs-number">0.29300</span>         osd.<span class="hljs-number">6</span>                up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br> <span class="hljs-number">2</span>             <span class="hljs-number">0</span> osd.<span class="hljs-number">2</span>                      down        <span class="hljs-number">0</span> <span class="hljs-number">1.00000</span><br> <span class="hljs-number">3</span>             <span class="hljs-number">0</span> osd.<span class="hljs-number">3</span>                      down        <span class="hljs-number">0</span> <span class="hljs-number">1.00000</span><br> <span class="hljs-number">4</span>             <span class="hljs-number">0</span> osd.<span class="hljs-number">4</span>                      down        <span class="hljs-number">0</span> <span class="hljs-number">1.00000</span><br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph osd rm osd.<span class="hljs-number">2</span><br>removed osd.<span class="hljs-number">2</span><br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph osd rm osd.<span class="hljs-number">3</span><br>removed osd.<span class="hljs-number">3</span><br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph osd rm osd.<span class="hljs-number">4</span><br>removed osd.<span class="hljs-number">4</span><br><span class="hljs-comment">#从crush中删除</span><br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph osd crush rm osd.<span class="hljs-number">1</span><br>device <span class="hljs-string">&#x27;osd.1&#x27;</span> does <span class="hljs-keyword">not</span> appear <span class="hljs-keyword">in</span> the crush map<br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph osd crush rm osd.<span class="hljs-number">2</span><br>device <span class="hljs-string">&#x27;osd.2&#x27;</span> does <span class="hljs-keyword">not</span> appear <span class="hljs-keyword">in</span> the crush map<br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph osd crush rm osd.<span class="hljs-number">3</span><br>device <span class="hljs-string">&#x27;osd.3&#x27;</span> does <span class="hljs-keyword">not</span> appear <span class="hljs-keyword">in</span> the crush map<br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph osd crush rm osd.<span class="hljs-number">4</span><br>device <span class="hljs-string">&#x27;osd.4&#x27;</span> does <span class="hljs-keyword">not</span> appear <span class="hljs-keyword">in</span> the crush map<br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><br><br><span class="hljs-comment">#从中删除掉认证的信息</span><br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph auth del osd.<span class="hljs-number">1</span><br>updated<br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph auth del osd.<span class="hljs-number">2</span><br>updated<br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph auth del osd.<span class="hljs-number">3</span><br>updated<br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>sudo ceph auth del osd.<span class="hljs-number">4</span><br>updated<br>[ceph-admin<span class="hljs-variable">@szbd</span>-ceph-node1 ~]<span class="hljs-variable">$ </span>ceph  auth list<br><br></code></pre></td></tr></table></figure><p><strong>6.5 REBALANCING数据重平衡</strong></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-comment">#临时关闭rebalance</span><br><span class="hljs-comment">#当在做rebalance的时候，每个osd都会按照osd_max_backfills指定数量的线程来同步,如果该数值比较大，同步会比较快，但是#会影响部分性能；另外数据同步时，是走的cluster_network,而客户端连接是用的public_network,生产环境建议这两个网络用</span><br><span class="hljs-comment">#万兆网络，较少网络传输的影响；</span><br><span class="hljs-comment">#设置标志位</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>ceph osd set norebalance<br><span class="hljs-comment">#关闭数据填充</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>ceph osd set nobackfill<br><span class="hljs-comment">#取消标志位</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>ceph osd unset nobackfill<br>nobackfill is unset<br><span class="hljs-comment">#开启数据填充</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>ceph osd unset norebalance<br>norebalance is unset<br><br><span class="hljs-comment">#可以看硬盘哪个有延迟，有延迟的就可能是硬盘有坏道</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ceph]<span class="hljs-variable">$ </span>ceph osd perf<br></code></pre></td></tr></table></figure><p><img src="/img/Linux/balance.png"></p><h2 id="七、Ceph集群运维"><a href="#七、Ceph集群运维" class="headerlink" title="七、Ceph集群运维"></a>七、Ceph集群运维</h2><p><strong>7.1 Ceph守护服务管理</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs less">#开启全部进程<br><span class="hljs-selector-tag">sudo</span> <span class="hljs-selector-tag">systemctl</span> <span class="hljs-selector-tag">start</span> <span class="hljs-selector-tag">ceph</span><span class="hljs-selector-class">.target</span><br>#检查全部<span class="hljs-selector-tag">ceph</span>的进程<br><span class="hljs-selector-tag">sudo</span> <span class="hljs-selector-tag">systemctl</span> <span class="hljs-selector-tag">status</span> <span class="hljs-selector-tag">ceph</span>\*<span class="hljs-selector-class">.service</span> <span class="hljs-selector-tag">ceph</span>\*<span class="hljs-selector-class">.target</span>  <br><br>#启动<span class="hljs-selector-tag">ceph</span>节点上所有特定类型的守护进程(start、stop、restart）<br>sudo systemctl start ceph-osd.target<br>sudo systemctl start ceph-mon.target<br>sudo systemctl start ceph-mds.target<br><br>#启动ceph上某一个特定的守护进程(start、stop、restart）<br>sudo systemctl start ceph-osd<span class="hljs-variable">@&#123;id&#125;</span><br>sudo systemctl start ceph-mon<span class="hljs-variable">@&#123;hostname&#125;</span><br>sudo systemctl start ceph-mds<span class="hljs-variable">@&#123;hostname&#125;</span><br><br># check status of osd.<span class="hljs-number">12</span><br>sudo systemctl status ceph-osd<span class="hljs-variable">@12</span>      <br><br>#会关闭掉在执行机器上osd的关闭<br>sudo systemctl stop ceph-osd.target<br><br>#开启其中的某一个osd<br>sudo systemctl start ceph-osd<span class="hljs-variable">@4</span>   #建议在生产环境中使用这种，影响最小。<br></code></pre></td></tr></table></figure><p><strong>7.2 Ceph服务日志分析</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle">#日志文件路径 <span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/ceph/</span><br>tail ceph-osd.<span class="hljs-number">0</span>.log<br><br></code></pre></td></tr></table></figure><p><strong>7.3 集群状态</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs bash">osd<br><span class="hljs-comment">#检测集群的状态</span><br>ceph -s<br><span class="hljs-comment">#动态可以看到集群的状态</span><br>ceph -w<br><span class="hljs-comment">#可以看到集群资源池空间分配的情况</span><br>ceph <span class="hljs-built_in">df</span><br><span class="hljs-comment">#可以看到很完整的osd的信息</span><br>ceph osd dump<br><span class="hljs-comment">#可以整个集群资源池的状态</span><br>ceph osd tree<br><span class="hljs-comment">#每个osd的大小</span><br>ceph osd <span class="hljs-built_in">df</span><br><br><br>mon<br><span class="hljs-comment">#监视mon的状态</span><br>ceph mon <span class="hljs-built_in">stat</span><br><span class="hljs-comment">#完整的mon信息</span><br>ceph mon dump<br><br><br>mds<br>ceph mds <span class="hljs-built_in">stat</span><br>ceph fs dump<br><br><br><span class="hljs-comment">#用admin socket可以查询到守护进程的配置状态信息</span><br>[root@ceph_node1 ceph]<span class="hljs-comment"># ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node1.asok config show</span><br><span class="hljs-comment">#更多的查询</span><br>ceph --admin-daemon /var/run/ceph/ceph-mgr.ceph_node1.asok <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure><p><strong>7.4 Pool资源池的管理</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">#设置pool资源池的自动收缩放模式<br>ceph osd pool <span class="hljs-keyword">set</span> &lt;pool-<span class="hljs-type">name</span>&gt; pg_autoscale_mode &lt;mode&gt;<br>例子:<br>ceph osd pool <span class="hljs-keyword">set</span> cephfs_data pg_autoscale_mode <span class="hljs-keyword">on</span><br><br>#可以设置pg最小的值<br>ceph osd pool <span class="hljs-keyword">set</span> &lt;pool-<span class="hljs-type">name</span>&gt; pg_num_min &lt;num&gt;<br>#创建一个新的pool池，pg_num的值是可选的。如果不指定pg_num，集群可以(默认情况下)根据池中存储的数据量自动为您调优<br>ceph osd pool <span class="hljs-keyword">create</span> &#123;pool-<span class="hljs-type">name</span>&#125; [pg_num] [pgp_num]<br>ceph osd pool <span class="hljs-keyword">set</span> &#123;pool-<span class="hljs-type">name</span>&#125; pg_autoscale_mode (<span class="hljs-keyword">on</span>|<span class="hljs-keyword">off</span>|warn)<br><br>https://docs.ceph.com/en/latest/rados/operations/placement-<span class="hljs-keyword">groups</span>/(官网pool的文档)<br><br></code></pre></td></tr></table></figure><p><strong>7.5 Ceph参数调整配置</strong></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment">###重启服务后不生效</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>ceph osd pool create pool-demo <span class="hljs-number">12</span> <span class="hljs-number">12</span><br>pool <span class="hljs-string">&#x27;pool-demo&#x27;</span> created<br><span class="hljs-comment">#删除一个pool</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># ceph osd pool rm pool-demo pool-demo --yes-i-really-really-mean-it</span><br><span class="hljs-title class_">Error</span> <span class="hljs-symbol">EPERM:</span> pool deletion is disabled; you must first set the mon_allow_pool_delete config option to <span class="hljs-literal">true</span> before you can destroy a pool<br><span class="hljs-comment">#查看配置</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node1.asok config show | grep mon_allow_pool_delete</span><br>    <span class="hljs-string">&quot;mon_allow_pool_delete&quot;</span>: <span class="hljs-string">&quot;false&quot;</span>,<br><span class="hljs-comment">#可以这样去调设置，调整了其中一个mon节点，其余节点也必须要调整，因为他是一个集群</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node1.asok config set mon_allow_pool_delete true</span><br>&#123;<br>    <span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-string">&quot;mon_allow_pool_delete = &#x27;true&#x27; &quot;</span><br>&#125;<br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment">#</span><br><span class="hljs-comment">#删除pool成功</span><br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># ceph osd pool rm  pool-demo pool-demo --yes-i-really-really-mean-it</span><br>pool <span class="hljs-string">&#x27;pool-demo&#x27;</span> removed<br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment">#</span><br><br><br><span class="hljs-comment">###长期生效</span><br>[ceph-admin<span class="hljs-variable">@ceph_admin</span> cluster]<span class="hljs-variable">$ </span>cat ceph.conf | grep mon_allow_pool_delete<br>mon_allow_pool_delete = <span class="hljs-literal">true</span><br>[ceph-admin<span class="hljs-variable">@ceph_admin</span> cluster]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><span class="hljs-comment">#要写进ceph.conf里头，并推到mon的节点上，才会永久生效。</span><br>[ceph-admin<span class="hljs-variable">@ceph_admin</span> cluster]<span class="hljs-variable">$ </span>cat ceph.conf | grep mon_allow_pool_delete<br>mon_allow_pool_delete = <span class="hljs-literal">true</span><br><span class="hljs-comment">#推到mon节点</span><br>[ceph-admin<span class="hljs-variable">@ceph_admin</span> cluster]<span class="hljs-variable">$ </span>ceph-deploy --overwrite-conf config push ceph_node1<br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment"># ceph --admin-daemon /var/run/ceph/ceph-mon.ceph_node1.asok config show | grep mon_allow_pool_delete</span><br>    <span class="hljs-string">&quot;mon_allow_pool_delete&quot;</span>: <span class="hljs-string">&quot;true&quot;</span>,<br>[root<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-comment">#</span><br><br></code></pre></td></tr></table></figure><h2 id="八、定义Crush-map规则"><a href="#八、定义Crush-map规则" class="headerlink" title="八、定义Crush map规则"></a>八、定义Crush map规则</h2><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs crystal">crush算法通过进行分配将不同的数据落到不同的osd中，定义crush规则一般都是以host位单位<br><span class="hljs-comment">#查看crush</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>ceph osd crush tree<br><span class="hljs-comment">#可以查看到完整的crush规则</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>ceph osd crush dump<br><br></code></pre></td></tr></table></figure><p><strong>8.1 定义Crush规则</strong></p><p><img src="/img/Linux/crush_info.png"></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><code class="hljs crystal">这里我有四个机器,将按照上面的图来定制我的crushmap的规则<br><span class="hljs-comment">#将crushmap下的二进制bin文件下载下来</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>ceph osd getcrushmap -o crushmap.bin<br><span class="hljs-comment">#将crushmap.bin文件更改为txt文件</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>crushtool -d crushmap.bin -o crushmap.txt<br><br><br><span class="hljs-comment">##将进行重新更改，更改为以下。</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>cat crushmap.txt<br><span class="hljs-comment"># begin crush map</span><br>tunable choose_local_tries <span class="hljs-number">0</span><br>tunable choose_local_fallback_tries <span class="hljs-number">0</span><br>tunable choose_total_tries <span class="hljs-number">50</span><br>tunable chooseleaf_descend_once <span class="hljs-number">1</span><br>tunable chooseleaf_vary_r <span class="hljs-number">1</span><br>tunable chooseleaf_stable <span class="hljs-number">1</span><br>tunable straw_calc_version <span class="hljs-number">1</span><br>tunable allowed_bucket_algs <span class="hljs-number">54</span><br><br><span class="hljs-comment"># devices</span><br>device <span class="hljs-number">0</span> osd.<span class="hljs-number">0</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hdd</span></span><br>device <span class="hljs-number">1</span> osd.<span class="hljs-number">1</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hdd</span></span><br>device <span class="hljs-number">2</span> osd.<span class="hljs-number">2</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hdd</span></span><br>device <span class="hljs-number">3</span> osd.<span class="hljs-number">3</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hdd</span></span><br><span class="hljs-comment">#device 4 osd.4 class hdd</span><br>device <span class="hljs-number">4</span> osd.<span class="hljs-number">4</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ssd</span></span><br><br><br><span class="hljs-comment"># types</span><br><span class="hljs-keyword">type</span> <span class="hljs-number">0</span> osd<br><span class="hljs-keyword">type</span> <span class="hljs-number">1</span> host<br><span class="hljs-keyword">type</span> <span class="hljs-number">2</span> chassis<br><span class="hljs-keyword">type</span> <span class="hljs-number">3</span> rack<br><span class="hljs-keyword">type</span> <span class="hljs-number">4</span> row<br><span class="hljs-keyword">type</span> <span class="hljs-number">5</span> pdu<br><span class="hljs-keyword">type</span> <span class="hljs-number">6</span> pod<br><span class="hljs-keyword">type</span> <span class="hljs-number">7</span> room<br><span class="hljs-keyword">type</span> <span class="hljs-number">8</span> datacenter<br><span class="hljs-keyword">type</span> <span class="hljs-number">9</span> zone<br><span class="hljs-keyword">type</span> <span class="hljs-number">10</span> region<br><span class="hljs-keyword">type</span> <span class="hljs-number">11</span> root<br><br><span class="hljs-comment"># buckets</span><br>host ceph_node1 &#123;<br>        id -<span class="hljs-number">3</span>           <span class="hljs-comment"># do not change unnecessarily</span><br>        id -<span class="hljs-number">4</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hdd</span>         <span class="hljs-comment"># do not change unnecessarily</span></span><br>        <span class="hljs-comment"># weight 0.010</span><br>        alg straw2<br>        hash <span class="hljs-number">0</span>  <span class="hljs-comment"># rjenkins1</span><br>        item osd.<span class="hljs-number">0</span> weight <span class="hljs-number">0.010</span><br>&#125;<br>host ceph_node2 &#123;<br>        id -<span class="hljs-number">5</span>           <span class="hljs-comment"># do not change unnecessarily</span><br>        id -<span class="hljs-number">6</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hdd</span>         <span class="hljs-comment"># do not change unnecessarily</span></span><br>        <span class="hljs-comment"># weight 0.010</span><br>        alg straw2<br>        hash <span class="hljs-number">0</span>  <span class="hljs-comment"># rjenkins1</span><br>        item osd.<span class="hljs-number">1</span> weight <span class="hljs-number">0.010</span><br>&#125;<br>host ceph_node3 &#123;<br>        id -<span class="hljs-number">7</span>           <span class="hljs-comment"># do not change unnecessarily</span><br>        id -<span class="hljs-number">8</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hdd</span>         <span class="hljs-comment"># do not change unnecessarily</span></span><br>        <span class="hljs-comment"># weight 0.010</span><br>        alg straw2<br>        hash <span class="hljs-number">0</span>  <span class="hljs-comment"># rjenkins1</span><br>        item osd.<span class="hljs-number">2</span> weight <span class="hljs-number">0.010</span><br>&#125;<br>host ceph_node4 &#123;<br>        id -<span class="hljs-number">9</span>           <span class="hljs-comment"># do not change unnecessarily</span><br>        id -<span class="hljs-number">10</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hdd</span>                <span class="hljs-comment"># do not change unnecessarily</span></span><br>        <span class="hljs-comment"># weight 0.020</span><br>        alg straw2<br>        hash <span class="hljs-number">0</span>  <span class="hljs-comment"># rjenkins1</span><br>        item osd.<span class="hljs-number">3</span> weight <span class="hljs-number">0.010</span><br>&#125;<br><br>host ceph_node4_ssd &#123;<br>        <span class="hljs-comment"># weight 0.020</span><br>        alg straw2<br>        hash <span class="hljs-number">0</span>  <span class="hljs-comment"># rjenkins1</span><br>        item osd.<span class="hljs-number">4</span> weight <span class="hljs-number">0.010</span><br>&#125;<br>root default &#123;<br>        id -<span class="hljs-number">1</span>           <span class="hljs-comment"># do not change unnecessarily</span><br>        id -<span class="hljs-number">2</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">hdd</span>         <span class="hljs-comment"># do not change unnecessarily</span></span><br>        <span class="hljs-comment"># weight 0.049</span><br>        alg straw2<br>        hash <span class="hljs-number">0</span>  <span class="hljs-comment"># rjenkins1</span><br>        item ceph_node1 weight <span class="hljs-number">0.010</span><br>        item ceph_node2 weight <span class="hljs-number">0.010</span><br>        item ceph_node3 weight <span class="hljs-number">0.010</span><br>        item ceph_node4 weight <span class="hljs-number">0.010</span><br>&#125;<br>root data &#123;<br>        <span class="hljs-comment"># weight 0.049</span><br>        alg straw2<br>        hash <span class="hljs-number">0</span>  <span class="hljs-comment"># rjenkins1</span><br>        item ceph_node4_ssd weight <span class="hljs-number">0.010</span><br>&#125;<br><br><br><span class="hljs-comment"># rules</span><br>rule replicated_rule &#123;<br>        id <span class="hljs-number">0</span><br>        <span class="hljs-keyword">type</span> replicated<br>        min_size <span class="hljs-number">1</span><br>        max_size <span class="hljs-number">10</span><br>        step take default<br>        step chooseleaf firstn <span class="hljs-number">0</span> <span class="hljs-keyword">type</span> host<br>        step emit<br>&#125;<br><br>rule demo_rule &#123;<br>        id <span class="hljs-number">11</span><br>        <span class="hljs-keyword">type</span> replicated<br>        min_size <span class="hljs-number">1</span><br>        max_size <span class="hljs-number">10</span><br>        step take data<br>        step chooseleaf firstn <span class="hljs-number">0</span> <span class="hljs-keyword">type</span> host<br>        step emit<br>&#125;<br><br><span class="hljs-comment"># end crush map</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><br><span class="hljs-comment">#进行重新编译成二进制文件</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>crushtool -c crushmap.txt -o crushmap-new.bin<br><span class="hljs-comment">##更改前</span><br>[ceph-admin<span class="hljs-variable">@ceph_node2</span> ~]<span class="hljs-variable">$ </span>sudo ceph osd tree<br>ID CLASS WEIGHT  TYPE NAME           STATUS REWEIGHT PRI-AFF<br>-<span class="hljs-number">1</span>       <span class="hljs-number">0.04898</span> root default<br>-<span class="hljs-number">3</span>       <span class="hljs-number">0.00980</span>     host ceph_node1<br> <span class="hljs-number">0</span>   hdd <span class="hljs-number">0.00980</span>         osd.<span class="hljs-number">0</span>           up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br>-<span class="hljs-number">5</span>       <span class="hljs-number">0.00980</span>     host ceph_node2<br> <span class="hljs-number">1</span>   hdd <span class="hljs-number">0.00980</span>         osd.<span class="hljs-number">1</span>           up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br>-<span class="hljs-number">7</span>       <span class="hljs-number">0.00980</span>     host ceph_node3<br> <span class="hljs-number">2</span>   hdd <span class="hljs-number">0.00980</span>         osd.<span class="hljs-number">2</span>           up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br>-<span class="hljs-number">9</span>       <span class="hljs-number">0.01959</span>     host ceph_node4<br> <span class="hljs-number">3</span>   hdd <span class="hljs-number">0.00980</span>         osd.<span class="hljs-number">3</span>           up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br> <span class="hljs-number">4</span>   hdd <span class="hljs-number">0.00980</span>         osd.<span class="hljs-number">4</span>           up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br>[ceph-admin<span class="hljs-variable">@ceph_node2</span> ~]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><span class="hljs-comment">#将新的二进制文件应用到osd中</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>ceph osd  setcrushmap -i crushmap-new.bin<br><span class="hljs-comment">###更改后</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>ceph osd tree<br>ID  CLASS WEIGHT  TYPE NAME               STATUS REWEIGHT PRI-AFF<br>-<span class="hljs-number">12</span>       <span class="hljs-number">0.00999</span> root data<br>-<span class="hljs-number">11</span>       <span class="hljs-number">0.00999</span>     host ceph_node4_ssd<br>  <span class="hljs-number">4</span>   ssd <span class="hljs-number">0.00999</span>         osd.<span class="hljs-number">4</span>               up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br> -<span class="hljs-number">1</span>       <span class="hljs-number">0.03998</span> root default<br> -<span class="hljs-number">3</span>       <span class="hljs-number">0.00999</span>     host ceph_node1<br>  <span class="hljs-number">0</span>   hdd <span class="hljs-number">0.00999</span>         osd.<span class="hljs-number">0</span>               up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br> -<span class="hljs-number">5</span>       <span class="hljs-number">0.00999</span>     host ceph_node2<br>  <span class="hljs-number">1</span>   hdd <span class="hljs-number">0.00999</span>         osd.<span class="hljs-number">1</span>               up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br> -<span class="hljs-number">7</span>       <span class="hljs-number">0.00999</span>     host ceph_node3<br>  <span class="hljs-number">2</span>   hdd <span class="hljs-number">0.00999</span>         osd.<span class="hljs-number">2</span>               up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br> -<span class="hljs-number">9</span>       <span class="hljs-number">0.00999</span>     host ceph_node4<br>  <span class="hljs-number">3</span>   hdd <span class="hljs-number">0.00999</span>         osd.<span class="hljs-number">3</span>               up  <span class="hljs-number">1.00000</span> <span class="hljs-number">1.00000</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><br><span class="hljs-comment">###测试，将cephfs_data更改为新的demo_rule规则</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>ceph osd pool ls<br>ceph-demo<br>.rgw.root<br>default.rgw.control<br>default.rgw.meta<br>default.rgw.log<br>default.rgw.buckets.index<br>default.rgw.buckets.data<br>cpehfs_metadata<br>cephfs_data<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>ceph osd pool get cephfs_data crush_rule<br><span class="hljs-symbol">crush_rule:</span> replicated_rule<br><span class="hljs-comment">#可以看到，现在多了一个我们定义的demo_rule规则</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>ceph osd crush rule ls<br>replicated_rule<br>demo_rule<br><span class="hljs-comment">####可以看到已经修改成功</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>ceph osd pool set cephfs_data crush_rule demo_rule<br>set pool <span class="hljs-number">9</span> crush_rule to demo_rule<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>ceph osd pool get cephfs_data crush_rule<br><span class="hljs-symbol">crush_rule:</span> demo_rule<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><br><br><span class="hljs-comment">###重新将其修改回原本的crushmap规则</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>ceph osd pool set cephfs_data crush_rule replicated_rule<br>set pool <span class="hljs-number">9</span> crush_rule to replicated_rule<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$ </span>ceph osd setcrushmap -i crushmap.bin<br><span class="hljs-number">13</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> crushmap]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><br><br><span class="hljs-comment">###注意事项三点:</span><br><span class="hljs-number">1</span>. 再添加硬盘的时候，就初始化crushmap规则<br><span class="hljs-number">2</span>. 要备份bin文件，出问题后迅速还原<br><span class="hljs-number">3</span>. 需要再ceph.conf 添加一条 osd crush update on start = <span class="hljs-literal">false</span> , 否则重启后，osd会还原(再管理节点进行)<br><span class="hljs-number">4</span>. 将修改后ceph.conf推送到其他node节点上 ceph-deploy config push ceph_node1 ceph_node2 ceph_node3<br><br></code></pre></td></tr></table></figure><h2 id="九、RBD高级功能"><a href="#九、RBD高级功能" class="headerlink" title="九、RBD高级功能"></a>九、RBD高级功能</h2><p><strong>9.1 RBD回收站机制</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs stylus">#在ceph-demo得pool下创建ceph-trash<span class="hljs-selector-class">.img</span> <span class="hljs-number">10</span>M<br><span class="hljs-selector-attr">[ceph-admin@ceph_node1 ~]</span>$ rbd create ceph-demo/ceph-trash<span class="hljs-selector-class">.img</span> <span class="hljs-attr">--size</span> <span class="hljs-number">10</span>M<br>#查看详细信息<br><span class="hljs-selector-attr">[ceph-admin@ceph_node1 ~]</span>$ rbd info ceph-demo/ceph-trash<span class="hljs-selector-class">.img</span><br>rbd image <span class="hljs-string">&#x27;ceph-trash.img&#x27;</span>:<br>        size <span class="hljs-number">10</span> MiB <span class="hljs-keyword">in</span> <span class="hljs-number">3</span> objects<br>        <span class="hljs-attribute">order</span> <span class="hljs-number">22</span> (<span class="hljs-number">4</span> MiB objects)<br>        snapshot_count: <span class="hljs-number">0</span><br>        id: d3bbc0b41b79<br>        block_name_prefix: rbd_data<span class="hljs-selector-class">.d3bbc0b41b79</span><br>        format: <span class="hljs-number">2</span><br>        features: layering, exclusive-lock, object-map, fast-diff, deep-flatten<br>        op_features:<br>        flags:<br>        create_timestamp: Tue Nov <span class="hljs-number">30</span> <span class="hljs-number">03</span>:<span class="hljs-number">52</span>:<span class="hljs-number">02</span> <span class="hljs-number">2021</span><br>        access_timestamp: Tue Nov <span class="hljs-number">30</span> <span class="hljs-number">03</span>:<span class="hljs-number">52</span>:<span class="hljs-number">02</span> <span class="hljs-number">2021</span><br>        modify_timestamp: Tue Nov <span class="hljs-number">30</span> <span class="hljs-number">03</span>:<span class="hljs-number">52</span>:<span class="hljs-number">02</span> <span class="hljs-number">2021</span><br><span class="hljs-selector-attr">[ceph-admin@ceph_node1 ~]</span>$<br>###删除该镜像后，回收站是没有得，所以不建议这么操作，可以将他移动到回收站并设置过期时间，需要的时候还可以恢复。<br><span class="hljs-selector-attr">[ceph-admin@ceph_node1 ~]</span>$ rbd rm ceph-demo/ceph-trash<span class="hljs-selector-class">.img</span><br>#查看pool池下有哪些<span class="hljs-selector-tag">img</span><br><span class="hljs-selector-attr">[ceph-admin@ceph_node1 ~]</span>$ rbd -<span class="hljs-selector-tag">p</span> ceph-demo ls<br>#移动到回收站<br><span class="hljs-selector-attr">[ceph-admin@ceph_node1 ~]</span>$ rbd trash move ceph-demo/ceph-trash<span class="hljs-selector-class">.img</span> <span class="hljs-attr">--expires-at</span> <span class="hljs-number">20211201</span><br>#回收站可以看到<br><span class="hljs-selector-attr">[ceph-admin@ceph_node1 ~]</span>$ rbd -<span class="hljs-selector-tag">p</span> ceph-demo trash ls<br>d3cc5b52e46f ceph-trash<span class="hljs-selector-class">.img</span><br>#从回收站恢复到原来的位置<br><span class="hljs-selector-attr">[ceph-admin@ceph_node1 ~]</span>$ rbd trash restore  -<span class="hljs-selector-tag">p</span> ceph-demo  d3cc5b52e46f<br><span class="hljs-selector-attr">[ceph-admin@ceph_node1 ~]</span>$ rbd -<span class="hljs-selector-tag">p</span> ceph-demo ls<br>ceph-trash<span class="hljs-selector-class">.img</span><br>rbd-demo<span class="hljs-selector-class">.img</span><br><span class="hljs-selector-attr">[ceph-admin@ceph_node1 ~]</span>$<br></code></pre></td></tr></table></figure><p><strong>9.2 RBD快照制作及快照数据恢复</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment">#制作一个块</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd create ceph-demo/rbd-snapshoot.img --image-feature layering --size 20M<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd info ceph-demo/rbd-snapshoot.img<br>rbd image <span class="hljs-string">&#x27;rbd-snapshoot.img&#x27;</span>:<br>        size <span class="hljs-number">20</span> MiB <span class="hljs-keyword">in</span> <span class="hljs-number">5</span> objects<br>        order <span class="hljs-number">22</span> (<span class="hljs-number">4</span> MiB objects)<br>        <span class="hljs-symbol">snapshot_count:</span> <span class="hljs-number">0</span><br>        <span class="hljs-symbol">id:</span> d3f2eb1db27a<br>        <span class="hljs-symbol">block_name_prefix:</span> rbd_data.d3f2eb1db27a<br>        <span class="hljs-symbol">format:</span> <span class="hljs-number">2</span><br>        <span class="hljs-symbol">features:</span> layering<br>        <span class="hljs-symbol">op_features:</span><br>        <span class="hljs-symbol">flags:</span><br>        <span class="hljs-symbol">create_timestamp:</span> Tue Nov <span class="hljs-number">30</span> <span class="hljs-number">04</span><span class="hljs-symbol">:</span><span class="hljs-number">34</span><span class="hljs-symbol">:</span><span class="hljs-number">57</span> <span class="hljs-number">2021</span><br>        <span class="hljs-symbol">access_timestamp:</span> Tue Nov <span class="hljs-number">30</span> <span class="hljs-number">04</span><span class="hljs-symbol">:</span><span class="hljs-number">34</span><span class="hljs-symbol">:</span><span class="hljs-number">57</span> <span class="hljs-number">2021</span><br>        <span class="hljs-symbol">modify_timestamp:</span> Tue Nov <span class="hljs-number">30</span> <span class="hljs-number">04</span><span class="hljs-symbol">:</span><span class="hljs-number">34</span><span class="hljs-symbol">:</span><span class="hljs-number">57</span> <span class="hljs-number">2021</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><span class="hljs-comment">#将这个块map起来</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo rbd device map ceph-demo/rbd-snapshoot.img<br>/dev/rbd1<br><span class="hljs-comment">#格式化做成一个文件系统</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo mkfs.ext4 /dev/rbd1<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo mkdir /mnt/rbd_snapshoot<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo mount /dev/rbd1 /mnt/rbd_snapshoot/<br><br><span class="hljs-comment">##拍摄快照成功, 格式为rbd snap create pool_name/img_name<span class="hljs-doctag">@time</span>.name</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap create ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@snap_20211130</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap ls ceph-demo/rbd-snapshoot.img<br><span class="hljs-variable constant_">SNAPID</span> <span class="hljs-variable constant_">NAME</span>          <span class="hljs-variable constant_">SIZE</span>   <span class="hljs-variable constant_">PROTECTED</span> <span class="hljs-variable constant_">TIMESTAMP</span><br>     <span class="hljs-number">4</span> snap_20211130 <span class="hljs-number">20</span> MiB           Tue Nov <span class="hljs-number">30</span> <span class="hljs-number">04</span><span class="hljs-symbol">:</span><span class="hljs-number">56</span><span class="hljs-symbol">:</span><span class="hljs-number">16</span> <span class="hljs-number">2021</span><br><br><br><span class="hljs-comment">##测试数据损坏了，进行快照恢复。</span><br><span class="hljs-comment">#1.查看要恢复快照的快照名称</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap ls ceph-demo/rbd-snapshoot.img<br><span class="hljs-variable constant_">SNAPID</span> <span class="hljs-variable constant_">NAME</span>          <span class="hljs-variable constant_">SIZE</span>   <span class="hljs-variable constant_">PROTECTED</span> <span class="hljs-variable constant_">TIMESTAMP</span><br>     <span class="hljs-number">4</span> snap_20211130 <span class="hljs-number">20</span> MiB           Tue Nov <span class="hljs-number">30</span> <span class="hljs-number">04</span><span class="hljs-symbol">:</span><span class="hljs-number">56</span><span class="hljs-symbol">:</span><span class="hljs-number">16</span> <span class="hljs-number">2021</span><br><span class="hljs-comment">#2. 开始回滚</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap rollback ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@snap_20211130</span><br>Rolling back to <span class="hljs-symbol">snapshot:</span> <span class="hljs-number">100</span>% complete...done.<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> rbd_snapshoot]<span class="hljs-variable">$ </span>ls<br>lost+found<br><span class="hljs-comment">#3.重新挂载才可以看到数据恢复成功</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo umount /mnt/rbd_snapshoot/<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo mount /dev/rbd1 /mnt/rbd_snapshoot/<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> rbd_snapshoot]<span class="hljs-variable">$ </span>ls<br>lost+found  test<br><span class="hljs-comment">#4.删除不用的快照</span><br>rbd snap rm &#123;pool-name&#125;/&#123;image-name&#125;@&#123;snap-name&#125;<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap rm  ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@snap_20211130</span><br>Removing <span class="hljs-symbol">snap:</span> <span class="hljs-number">100</span>% complete...done.<br><br></code></pre></td></tr></table></figure><p><strong>9.3 RBD镜像克隆</strong></p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-comment">#制作rbd-snapshoot的快照</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap create ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@template</span><br><span class="hljs-comment">#保护template快照后，无法进行删除</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap protect ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@template</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap rm ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@template</span><br>Removing <span class="hljs-symbol">snap:</span> <span class="hljs-number">0</span>% complete...failed.<span class="hljs-number">2021</span>-<span class="hljs-number">11</span>-<span class="hljs-number">30</span> <span class="hljs-number">23</span>:<span class="hljs-number">0</span>7:<span class="hljs-number">21.960</span> <span class="hljs-number">7</span>fd516efdc80 -<span class="hljs-number">1</span> <span class="hljs-symbol">librbd:</span>:<span class="hljs-symbol">Operations:</span> snapshot is <span class="hljs-keyword">protected</span><br><span class="hljs-symbol">rbd:</span> snapshot <span class="hljs-string">&#x27;template&#x27;</span> is <span class="hljs-keyword">protected</span> from removal.<br><br><span class="hljs-comment">#将快照克隆格式为: rbd clone &#123;pool-name&#125;/&#123;image-name&#125;@&#123;snap-name&#125;  path_name/clone_name.img</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd clone ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@template</span> ceph-demo/vm1-clone.img<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd clone ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@template</span> ceph-demo/vm2-clone.img<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd -p ceph-demo ls<br>ceph-trash.img<br>rbd-demo.img<br>rbd-snapshoot.img<br>vm1-clone.img<br>vm2-clone.img<br><br><span class="hljs-comment">#将克隆的镜像map上去，并挂载查看镜像里的文件是否一致</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo rbd device map ceph-demo/vm1-clone.img<br><span class="hljs-regexp">/dev/rbd</span>2<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo mkdir /mnt/vm1<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo mount /dev/rbd2 /mnt/vm1<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo ls /mnt/vm1<br>lost+found  test<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><br></code></pre></td></tr></table></figure><p><img src="/img/Linux/rbd1.png"><br><img src="/img/Linux/rbd2.png"><br><strong>9.3 RBD解除依赖关系</strong></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-comment">##rbd解除父子依赖关系，解除关系后，删除镜像就没有问题了，flags: 空</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd children ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@template</span><br>ceph-demo/vm1-clone.img<br>ceph-demo/vm2-clone.img<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd flatten ceph-demo/vm1-clone.img<br><span class="hljs-title class_">Image</span> <span class="hljs-symbol">flatten:</span> <span class="hljs-number">100</span>% complete...done.<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd info ceph-demo/vm1-clone.img<br>rbd image <span class="hljs-string">&#x27;vm1-clone.img&#x27;</span>:<br>        size <span class="hljs-number">20</span> <span class="hljs-title class_">MiB</span> <span class="hljs-keyword">in</span> <span class="hljs-number">5</span> objects<br>        order <span class="hljs-number">22</span> (<span class="hljs-number">4</span> <span class="hljs-title class_">MiB</span> objects)<br>        <span class="hljs-symbol">snapshot_count:</span> <span class="hljs-number">0</span><br>        <span class="hljs-symbol">id:</span> d43f4e8edeb0<br>        <span class="hljs-symbol">block_name_prefix:</span> rbd_data.d43f4e8edeb0<br>        <span class="hljs-symbol">format:</span> <span class="hljs-number">2</span><br>        <span class="hljs-symbol">features:</span> layering<br>        <span class="hljs-symbol">op_features:</span><br>        <span class="hljs-symbol">flags:</span><br>        <span class="hljs-symbol">create_timestamp:</span> <span class="hljs-title class_">Tue</span> <span class="hljs-title class_">Nov</span> <span class="hljs-number">30</span> <span class="hljs-number">23</span><span class="hljs-symbol">:</span><span class="hljs-number">15</span><span class="hljs-symbol">:</span><span class="hljs-number">57</span> <span class="hljs-number">2021</span><br>        <span class="hljs-symbol">access_timestamp:</span> <span class="hljs-title class_">Tue</span> <span class="hljs-title class_">Nov</span> <span class="hljs-number">30</span> <span class="hljs-number">23</span><span class="hljs-symbol">:</span><span class="hljs-number">15</span><span class="hljs-symbol">:</span><span class="hljs-number">57</span> <span class="hljs-number">2021</span><br>        <span class="hljs-symbol">modify_timestamp:</span> <span class="hljs-title class_">Tue</span> <span class="hljs-title class_">Nov</span> <span class="hljs-number">30</span> <span class="hljs-number">23</span><span class="hljs-symbol">:</span><span class="hljs-number">15</span><span class="hljs-symbol">:</span><span class="hljs-number">57</span> <span class="hljs-number">2021</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$</span><br><span class="hljs-variable"></span><span class="hljs-comment">#去除掉protect的保护</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap unprotect ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@template</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap rm ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@template</span><br><span class="hljs-title class_">Removing</span> <span class="hljs-symbol">snap:</span> <span class="hljs-number">100</span>% complete...done.<br></code></pre></td></tr></table></figure><p><strong>9.4 RBD备份与恢复</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment">#创建一个rbd-snapshoot.img的快照名叫snap-demo，</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap create ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@snap</span>-demo<br><span class="hljs-comment">#查看镜像的快照</span><br>rbd snap ls &#123;pool-name&#125;/&#123;image-name&#125;<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd snap ls ceph-demo/rbd-snapshoot.img<br><span class="hljs-variable constant_">SNAPID</span> <span class="hljs-variable constant_">NAME</span>      <span class="hljs-variable constant_">SIZE</span>   <span class="hljs-variable constant_">PROTECTED</span> <span class="hljs-variable constant_">TIMESTAMP</span><br>    <span class="hljs-number">10</span> snap-demo <span class="hljs-number">20</span> MiB           Wed Dec  <span class="hljs-number">1</span> <span class="hljs-number">01</span><span class="hljs-symbol">:</span><span class="hljs-number">58</span><span class="hljs-symbol">:</span><span class="hljs-number">34</span> <span class="hljs-number">2021</span><br><br><span class="hljs-comment">#将创建镜像的快照导出</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo rbd export ceph-demo/rbd-snapshoot.img<span class="hljs-variable">@snap</span>-demo /root/export_img/rbd-snapshoot.img<br>Exporting <span class="hljs-symbol">image:</span> <span class="hljs-number">100</span>% complete...done.<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>sudo ls /root/export_img/<br>rbd-snapshoot.img<br><br><span class="hljs-comment">#将原来的数据删除掉，然后卸载硬盘，重新用新的快照恢复。</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> rbd_snapshoot]<span class="hljs-variable">$ </span>sudo rm -f test<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> rbd_snapshoot]<span class="hljs-variable">$ </span>sudo umount /mnt/rbd_snapshoot<br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd import rbd-snapshoot.img ceph-demo/rbd-snapshoot-new.img</span><br>Importing <span class="hljs-symbol">image:</span> <span class="hljs-number">100</span>% complete...done.<br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd device map ceph-demo/rbd-snapshoot-new.img</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># mount /dev/rbd3 /mnt/rbd_snapshoot/</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># ls   /mnt/rbd_snapshoot/</span><br>lost+found  test<br><br><br><br><span class="hljs-comment">#在实际项目中使用就是，定期做快照，然后导出某个时间点快照的数据，然后导出增量的快照的数据。</span><br>例如：<br>备份：<br>对所有的rbd的image做一个基础快照，然后导出这个快照的数据，然后设置每天定时做快照，导出快照时间点之间的数据，这样每天导出来的就是一个增量的数据了。<br>设置循环周期，比如三天为一个周期。每三天循环一次，自动删除三天前的备份。<br>恢复：<br>从第一个快照导入，然后按照顺序导入增量的快照即可。<br><br><br><span class="hljs-comment">#定期增量备份</span><br><span class="hljs-comment">#0.创建一个pool</span><br>ceph osd pool create ceph-demo <span class="hljs-number">32</span> <span class="hljs-number">32</span><br><br><span class="hljs-comment">#1.#制作一个镜像块设备</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> ~]<span class="hljs-variable">$ </span>rbd create ceph-demo/rbd-snapshoot.img --image-feature layering --size 20M<br><br><span class="hljs-comment">#2. 将镜像做块设备的挂载</span><br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-variable">$ </span>sudo rbd device map ceph-demo/rbd-snapshoot.img<br>/dev/rbd0<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-variable">$ </span>sudo mkfs.ext4 /dev/rbd0<br>[ceph-admin<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-variable">$ </span>sudo mount /dev/rbd0 /mnt/rbd_snapshoot/<br><br><span class="hljs-comment">#3.第一次写入数据</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># sudo echo &quot;第一次写入数据&quot; &gt;&gt; /mnt/rbd_snapshoot/v1_write.txt</span><br><br><span class="hljs-comment">#4.第一次拍摄实例快照</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd snap create ceph-demo/rbd-snapshoot.img<span class="hljs-doctag">@rbd</span>_snapshoot_v1</span><br><br><span class="hljs-comment">#5.第一次将拍摄的快照全量备份</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd export-diff ceph-demo/rbd-snapshoot.img<span class="hljs-doctag">@rbd</span>_snapshoot_v1 rbd_snapshoot_v1_backup</span><br>Exporting <span class="hljs-symbol">image:</span> <span class="hljs-number">100</span>% complete...done.<br><br><span class="hljs-comment">#6.继续写入数据</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># echo &quot;第二次写入数据&quot; &gt;&gt; /mnt/rbd_snapshoot/v2_write.txt</span><br><br><span class="hljs-comment">#7.第二次拍摄实例快照</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd snap create ceph-demo/rbd-snapshoot.img<span class="hljs-doctag">@rbd</span>_snapshoot_v2</span><br><br><span class="hljs-comment">#8.第二次将拍摄的快照进行备份</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd export-diff ceph-demo/rbd-snapshoot.img<span class="hljs-doctag">@rbd</span>_snapshoot_v2 rbd_snapshoot_v2_backup</span><br>Exporting <span class="hljs-symbol">image:</span> <span class="hljs-number">100</span>% complete...done.<br><br><span class="hljs-comment">#9.第三次写入数据</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># echo &quot;第三次写入数据&quot; &gt;&gt; /mnt/rbd_snapshoot/v3_write.txt</span><br><br><span class="hljs-comment">#10.第三次拍摄实例快照</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd snap create ceph-demo/rbd-snapshoot.img<span class="hljs-doctag">@rbd</span>_snapshoot_v3</span><br><br><span class="hljs-comment">#11.第三次将拍摄的快照进行备份</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd export-diff ceph-demo/rbd-snapshoot.img<span class="hljs-doctag">@rbd</span>_snapshoot_v3 rbd_snapshoot_v3_backup</span><br>Exporting <span class="hljs-symbol">image:</span> <span class="hljs-number">100</span>% complete...done.<br><br><span class="hljs-comment">#12.查看当前共有3个快照，分别将快照的差异数据，取出来。</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd snap ls ceph-demo/rbd-snapshoot.img</span><br><span class="hljs-variable constant_">SNAPID</span> <span class="hljs-variable constant_">NAME</span>             <span class="hljs-variable constant_">SIZE</span>   <span class="hljs-variable constant_">PROTECTED</span> <span class="hljs-variable constant_">TIMESTAMP</span><br>     <span class="hljs-number">6</span> rbd_snapshoot_v1 <span class="hljs-number">20</span> MiB           Thu Dec  <span class="hljs-number">2</span> <span class="hljs-number">07</span><span class="hljs-symbol">:</span><span class="hljs-number">07</span><span class="hljs-symbol">:</span><span class="hljs-number">36</span> <span class="hljs-number">2021</span><br>     <span class="hljs-number">7</span> rbd_snapshoot_v2 <span class="hljs-number">20</span> MiB           Thu Dec  <span class="hljs-number">2</span> <span class="hljs-number">07</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span> <span class="hljs-number">2021</span><br>     <span class="hljs-number">8</span> rbd_snapshoot_v3 <span class="hljs-number">20</span> MiB           Thu Dec  <span class="hljs-number">2</span> <span class="hljs-number">07</span><span class="hljs-symbol">:</span><span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">54</span> <span class="hljs-number">2021</span><br><br><span class="hljs-comment">#13.将v2的快照和v1的快照的差异数据取出来</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd export-diff --from-snap rbd_snapshoot_v1 ceph-demo/rbd-snapshoot.img<span class="hljs-doctag">@rbd</span>_snapshoot_v2   rbd_snapshoot_v2_v1</span><br>Exporting <span class="hljs-symbol">image:</span> <span class="hljs-number">100</span>% complete...done.<br><br><br><span class="hljs-comment">#13.将v3的快照和v2的快照的差异数据取出来</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd export-diff --from-snap rbd_snapshoot_v2 ceph-demo/rbd-snapshoot.img<span class="hljs-doctag">@rbd</span>_snapshoot_v3  rbd_snapshoot_v3_v2</span><br>Exporting <span class="hljs-symbol">image:</span> <span class="hljs-number">100</span>% complete...done.<br><br><br><span class="hljs-comment">#数据备份恢复</span><br><span class="hljs-comment">#1.新建一个块设备镜像并格式化且挂载到文件夹下</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd create ceph-demo/rbd_backup.img --image-feature layering --size 30M</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd device map ceph-demo/rbd_backup_2.img</span><br>/dev/rbd2<br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># mkfs.ext4 /dev/rbd2</span><br>[root<span class="hljs-variable">@ceph_node1</span> mnt]<span class="hljs-comment"># mount /dev/rbd2 /mnt/rbd_backup/</span><br><br><span class="hljs-comment">#2.导入恢复数据需要依次导入，比如：第一次备份的文件先导入，再导入第一次第二次的差异数据文件，再导入第二次全量备份的文件，接着再导入第二次和第三次差异的数据，最后再导入第三次最后一次备份的数据文件。</span><br><span class="hljs-comment">#2.1 导入第一次全量备份的数据</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd import-diff rbd_snapshoot_v1_backup ceph-demo/rbd_backup.img</span><br>Importing image <span class="hljs-symbol">diff:</span> <span class="hljs-number">100</span>% complete...done.<br><span class="hljs-comment">#2.2 导入第二次和第一次的备份的差异数据</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd import-diff rbd_snapshoot_v2_v1 ceph-demo/rbd_backup.img</span><br>Importing image <span class="hljs-symbol">diff:</span> <span class="hljs-number">100</span>% complete...done.<br><span class="hljs-comment">#2.3 导入第二次和第三全量备份的数据</span><br>[root<span class="hljs-variable">@ceph_node1</span> export_img]<span class="hljs-comment"># rbd import-diff rbd_snapshoot_v3_v2 ceph-demo/rbd_backup.img</span><br>Importing image <span class="hljs-symbol">diff:</span> <span class="hljs-number">100</span>% complete...done.<br><br></code></pre></td></tr></table></figure><p>未完待续….</p>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>分布式存储</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>KMS服务器搭建激活win10/office</title>
    <link href="/2022/08/31/Linux/install_kms/"/>
    <url>/2022/08/31/Linux/install_kms/</url>
    
    <content type="html"><![CDATA[<p>KMS全称Key Management Service，即通过系统管理员（System Administrator）使用一个批量激活密钥（也就是大家经常看到的Volume Key）Vol密钥，设置一个激活服务器（Activation Server），并在每一个客户机上安装KMS的客户端，就可以进行批量激活和管理，极大的减少了工作量。</p><p>其实KMS服务器很早之前我就已经搭建过了，但是现在自己家的电脑和office都会提示过期，刚好自己也买了个阿里云的服务器，干脆就自建KMS服务器，虽然网上也有，但是怕有木马病毒，于是我开始了…其实搭建kms真的很简单，已经有大神写好的了，我的服务器是centos7</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">项目地址:https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/Wind4/</span>vlmcsd<br></code></pre></td></tr></table></figure><h2 id="一、部署KMS"><a href="#一、部署KMS" class="headerlink" title="一、部署KMS"></a>一、部署KMS</h2><ul><li><p><strong>下载安装包</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@aliyun</span>-server <span class="hljs-keyword">local</span>]<span class="hljs-meta"># wget https://github.com/Wind4/vlmcsd/releases/download/svn1113/binaries.tar.gz</span><br></code></pre></td></tr></table></figure></li><li><p><strong>解压</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@aliyun</span>-server <span class="hljs-keyword">local</span>]<span class="hljs-meta"># tar -zxvf binaries.tar.gz</span><br></code></pre></td></tr></table></figure></li><li><p><strong>进入该目录，下面是我存放的路径</strong></p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">[root@aliyun-server <span class="hljs-keyword">static</span>]# pwd<br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/binaries/</span>Linux<span class="hljs-regexp">/intel/</span><span class="hljs-keyword">static</span><br></code></pre></td></tr></table></figure></li><li><p><strong>运行</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@aliyun</span>-server <span class="hljs-keyword">static</span>]<span class="hljs-meta"># ./vlmcsd-x64-musl-static</span><br></code></pre></td></tr></table></figure></li><li><p><strong>查看是否运行成功</strong></p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir">[root<span class="hljs-variable">@aliyun</span>-server static]<span class="hljs-comment"># netstat -antp | grep vlmcsd</span><br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span><span class="hljs-symbol">:</span><span class="hljs-number">1688</span>            <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span><span class="hljs-symbol">:*</span>               <span class="hljs-title class_">LISTEN</span>      <span class="hljs-number">2662</span>/./vlmcsd-x64-m <br>tcp6       <span class="hljs-number">0</span>      <span class="hljs-number">0</span> ::<span class="hljs-symbol">:</span><span class="hljs-number">1688</span>                 ::<span class="hljs-symbol">:*</span>                    <span class="hljs-title class_">LISTEN</span>      <span class="hljs-number">2662</span>/./vlmcsd-x64-m <br></code></pre></td></tr></table></figure><p><strong>ps: 如果你安装了iptables，需要用一下命令开启1688端口, 然后我这个因为是阿里云服务器的嘛，所以还需要在控制在放开1688端口</strong></p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">iptables -I INPUT <span class="hljs-number">5</span> -p tcp -m <span class="hljs-keyword">state</span> -–<span class="hljs-keyword">state</span> NEW -m tcp -–dport <span class="hljs-number">1688</span> -j ACCEPT<br><br></code></pre></td></tr></table></figure><p><img src="/img/Linux/kms_01.png"></p></li></ul><h2 id="二、KMS激活系统"><a href="#二、KMS激活系统" class="headerlink" title="二、KMS激活系统"></a>二、KMS激活系统</h2><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta">#KMS服务激活适用对象: VOL版本的Windows和Office</span><br></code></pre></td></tr></table></figure><ul><li><strong>确认系统是否VOL版本,如果不知道自己是什么版本,可以用以下命令查看。</strong></li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-meta">#用cmd以管理员生打开运行</span><br><span class="hljs-symbol">C:</span>\Windows\system32&gt;slmgr /dlv<br></code></pre></td></tr></table></figure><p>在描述这行可以看到VOLUME则就是VOL版本的，如果有RETAIL则就是零售版本的。<br><img src="/img/Linux/kms_02.png"></p><ul><li><strong>零售版本如何转换为VOL版本呢，可以按照<a href="https://docs.microsoft.com/zh-cn/windows-server/get-started/kmsclientkeys">KMS客户端安装密钥</a>，用以下命令，然后找对应的操作版本和密钥安装转换即可，如果系统是VOL版本的就不用了做此步骤。</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">slmgr /ipk VOL-key<br>例如:C:\Windows\system32&gt;slmgr /ipk W269N-WFGWX-YVC9B-4J6C9-T83GX<br></code></pre></td></tr></table></figure><p><img src="/img/Linux/kms_03.png"></p><ul><li><strong>现在我们来尝试激活系统，这里我的系统是windows10 专业版本</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#查看版本</span><br>slmgr /dlv<br><span class="hljs-comment">#指定kms服务器，大家可以用我的服务器来激活，不要攻击我哈</span><br>slmgr /skms 121.40.193.242<br><span class="hljs-comment">#激活</span><br>slmgr /ato<br></code></pre></td></tr></table></figure></li></ul><p><img src="/img/Linux/kms_04.png"><br><img src="/img/Linux/kms_05.png"></p><h2 id="三、激活Office"><a href="#三、激活Office" class="headerlink" title="三、激活Office"></a>三、激活Office</h2><ul><li><strong>还是用cmd管理员模式进入到安装office的目录</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#进入安装目录</span><br>C:\Windows\system32&gt;<span class="hljs-built_in">cd</span> C:\Program Files\Microsoft Office\Office16<br><span class="hljs-comment">#指向服务器</span><br>cscript ospp.vbs /sethst:121.40.193.242<br><span class="hljs-comment">#手动激活</span><br>cscript ospp.vbs /act<br><span class="hljs-comment">#查询是否激活成功</span><br>cscript ospp.vbs /dstatus<br><span class="hljs-comment">#如果激活不成功，可以先查询然后把以前的key全部删除，在激活。</span><br>cscript ospp.vbs /unpkey:XXXXX<br></code></pre></td></tr></table></figure><img src="/img/Linux/kms_06.png"></li></ul>]]></content>
    
    
    <categories>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kms win10 office</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Exchange Server 2016 遇到的一些问题错误解决方法</title>
    <link href="/2022/08/31/Exchange2016/exchange2016_other_01/"/>
    <url>/2022/08/31/Exchange2016/exchange2016_other_01/</url>
    
    <content type="html"><![CDATA[<p><strong>邮件发送到外部邮箱账号失败</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-2bf9e4f161cdd26d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p><p>– 然后重新配置了<strong>邮件流-发送连接器-发送internet</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-3ceb37bf0c27cba3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c914c1276ab743af.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-343e620753a7d145.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-febd0e2c54b4458f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9365ed7ac78f3c5e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-5e08bd6aa12595ac.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9432e4ebfe7ded1e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-26bfffe2839aeafe.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>Exchange2016</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Exchange2016</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Exchange Server 2016 部署系列（六）高可用 DAG</title>
    <link href="/2022/08/31/Exchange2016/exchange2016_06/"/>
    <url>/2022/08/31/Exchange2016/exchange2016_06/</url>
    
    <content type="html"><![CDATA[<p><strong>见证目录权限配置</strong><br>本次实验中将使用DC作为见证服务器，需要将Exchange Trusted Subsytem组加入到见证服务器的本地Administrators组中，在DC中需要使用AD用户和计算机来添加</p><ul><li><p>添加Exchange Trusted Subsytem组到Administrators组中<br><img src="https://upload-images.jianshu.io/upload_images/9650472-7c02cd9000f9f816.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1.png"></p></li><li><p>在域控制器上，打开Active Directory用户和计算机，展开域节点“computer”，在右侧窗口中点击右键，选择“新建”-“计算机”，输入DAG群集计算机名称DAG01，点击“确定”。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-b56a2ad15950a0e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="2.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-d197957418312ec6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-d62f0746b2932ceb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.png"></p><ul><li><p>需要将权限分配给 CNO，在Active Directory用户和计算机中点击“查看”，勾选“高级功能”，选择创建的计算机DAG01右键属性，却换到隶属于选项卡，点击“添加”，将计算机DAG01添加到Exchange Trusted Subsytem组中。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-9f7222bc35abe5f3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.png"></p></li><li><p>新建DAG存放文件夹<br><img src="https://upload-images.jianshu.io/upload_images/9650472-8dac10a81b727046.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.png"></p></li><li><p>新建数据库可用性组，填入DAG名称、见证服务器名称、DAG IP地址等，点击“确定”,见证目录可不填，DAG会在见证服务器上自动创建见证目录，也可自己指定。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-2e45a595f5665e44.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-b922e17ec4341ea5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"></p><ul><li>点击“管理DAG成员资格”图标，单击“+”，从列表选择服务器Contso-EX01 Contso-EX02，单击“添加”，然后单击“确定”，单击“保存”，以保存更改。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-3781ee49dfffad2d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-1aea42975aef22b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p><ul><li><p>等“保存已成功完成“后，单击“关闭<br><img src="https://upload-images.jianshu.io/upload_images/9650472-cb5e6ccd7dda868b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p></li><li><p>将DAG网络修改成手动方式<br><img src="https://upload-images.jianshu.io/upload_images/9650472-11663e361d03249c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="12.png"></p></li><li><p>添加数据库副本到另一台服务器，点击新建的数据库名称，然后点击 “．．．”. 来添加副本数据库。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-29844f532d9eb564.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="13.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a5fd54c02e51dda0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="14.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-34a48f4c402a822b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="15.png"></p><ul><li>添加完成<br><img src="https://upload-images.jianshu.io/upload_images/9650472-bf1282e0321a49a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="16.png"></li></ul>]]></content>
    
    
    <categories>
      
      <category>Exchange2016</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Exchange2016</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Exchange Server 2016 部署系列（四）基础配置</title>
    <link href="/2022/08/31/Exchange2016/exchange2016_04/"/>
    <url>/2022/08/31/Exchange2016/exchange2016_04/</url>
    
    <content type="html"><![CDATA[<p>我们在上一篇中完成了Exchange Server 2016 CU15的安装,接下来我们将进入配置相关内容,首先我们将会进行DNS记录配置，证书配置，证书申请，证书导入。</p><p><strong>1.DNS记录配置</strong><br>部署过Exchange Server的朋友可能知道，部署完成Exchange后，只能使用IP或者LocalHost方式访问，除非您在您的DNS里添加A记录，才能以配置的域名去访问登陆，首先就要在域的DNS里创建一个的DNS域。</p><ul><li>打开DNS新建区域，使用Mail.iphonefintech.com访问邮件，所以作用域就是iphonefintech.com,所以我们这里输入iphonefintech.com即可<br><img src="https://upload-images.jianshu.io/upload_images/9650472-036997e559a17a81.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-72c31d6ac3c4d2ac.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-407f84847497d689.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-833ce307404388da.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-e8237075d3cef1cf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c55dc10f614c3e2d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></p><ul><li>DNS上启用了DNS轮训功能,然后在刚刚建的区域上创建A记录，输入第一台邮件服务器的命名及ip，再创建一个输入第二台。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-0bd09519fe9e8265.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-50e0dace70491631.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-ecf9b81dc233129e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-d74d0f759d6af5df.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-25d63cab96a6bc2b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p><p><strong>2.证书配置</strong><br>DNS轮训配置完成后，我们是可以使用sz-ad-02.iphonefintech.com访问邮件了，但网页会报证书错误，我们要解决这个问题只能使用公网证书或者使用内网证书在EX上绑定，为了掩饰证书安装，我这里就用内网证书了。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-5421ccbcf45f21d0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15847837627110.png"></p><p><strong>2.1AD证书安装</strong></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-d64876e6ce077b83.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-70ac1085db6e5ec8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-efcb346e2d080223.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-20adffd50fb85016.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-53cf185fbb72fb2c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c0491a2dc37ff0b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-edf8a2555003824f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="07.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-b7f8393d641d32e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="08.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-998f51e95ef6674e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="09.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c389ed4008b6ce01.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-6d896385be8facb7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p><p><strong>2.2AD CS证书配置</strong></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-e553a6c5d3bdfac6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-f0a98429a36aa0c0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-cdc731369ba94e03.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><ul><li>该步骤我们一定要选择“企业CA”<br><img src="https://upload-images.jianshu.io/upload_images/9650472-e420ca481cc12b07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></li><li>由于我们这台CA是第一台CA，所以我们选择跟CA即可<br><img src="https://upload-images.jianshu.io/upload_images/9650472-7d784fa45bd05867.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-eca173118a534f06.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9d3f0cf629b70027.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="07.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-402a6035cd0bb956.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="08.png"></p><ul><li>默认的CA是5年，实际环境建议设置大点，避免过期，过期了就不好玩了</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c97544f7b5deb731.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="09.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-0eee5ccc1a438936.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-afda678cf8521a16.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p><ul><li>至此我们CA就配置完成了</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-af3be378175ee617.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="12.png"></p><p><strong>3.证书申请</strong></p><ul><li>打开Exchange 服务器的ECP</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-34e0bf7ff5f979db.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-1cda7a63181e7d52.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><ul><li><p>证书友好名称根据自己的习惯填写就可以了<br><img src="https://upload-images.jianshu.io/upload_images/9650472-1c2225101e1700c4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p></li><li><p>如果想使用通配符证书，这里就可以配置，我这里就不使用通配符证书了<br><img src="https://upload-images.jianshu.io/upload_images/9650472-dde00e866ff7b697.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p></li><li><p>选择证书存储服务器<br><img src="https://upload-images.jianshu.io/upload_images/9650472-cc2138b9dae0a05d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-7e2ab520a5978194.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></p><ul><li>上面如果没有配置，这里直接添加即可，由于后期我们还需要使用OOS服务器，所以我把OOS的域名就一并申请下来了。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-e87d2cf7fe8f257e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="07.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-e92a14db3c891a84.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="08.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-23704c10c2bd3049.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="09.png"></p><ul><li>选择证书申请文件存储位置，这里的位置必须是共享路径<br><img src="https://upload-images.jianshu.io/upload_images/9650472-9f152f483c8480ec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></li></ul><p><strong>3.1CA证书申请</strong></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a4fc02c5af90bf9f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-3d90ac1f9772cea8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-1007e7153a04d199.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-5154511bb82cdad3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p><ul><li>打开刚才创建的申请文件，复制粘贴填入，选择web服务器<br><img src="https://upload-images.jianshu.io/upload_images/9650472-630235af4d934bdc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-03f6fde704c9c37c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="07.png"></p><ul><li>下载证书<br><img src="https://upload-images.jianshu.io/upload_images/9650472-eba47b3aebd932ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="08.png"></li></ul><p><strong>4证书导入到出</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-ececbed167eba3c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-a71dbb538b5bcfbf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c43223da4f18e008.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-3db3423fd1858af4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c44ce8e1f08cf9b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9c76c769f898d3b1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-1a60678e5dcb467c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="07.png"></p><ul><li>我们完成了第一台服务器的证书导入与服务的分配工作，接下来我们进行第二台服务器的证书导入与分配工作。</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-baf499ea9128f59a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="08.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9254c99204d48245.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="09.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-435f92308e1607ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="10.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-ba358ac83ac13f27.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="11.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-20260e356317e15a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="12.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-16ebb3a2e6652ced.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="13.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-b6d0ea56ccc20eb6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="14.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-1668ac280dc49b3b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="15.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-699527ff99694aa4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="16.png"></p><ul><li>这个时候我们在登录就不会报证书错误了<br><img src="https://upload-images.jianshu.io/upload_images/9650472-ff145a750f1df333.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="17.png"></li></ul>]]></content>
    
    
    <categories>
      
      <category>Exchange2016</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Exchange2016</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Exchange Server 2016 部署系列（五）基础配置</title>
    <link href="/2022/08/31/Exchange2016/exchange2016_05/"/>
    <url>/2022/08/31/Exchange2016/exchange2016_05/</url>
    
    <content type="html"><![CDATA[<p><strong>虚拟目录</strong><br><strong>自动发现配置</strong><br>有的朋友可能知道，虽然在虚拟目录里有自动发现这个选项，但自动发现记录在图形化界面无法配置自动发现地址，如图所示。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-4d8a5aafd92e5d42.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_1585105398994.png"></p><ul><li>其实自动发现路径需要使用命令修改，我们先查下现在的自动发现写的是什么</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">查看自动发现配置情况命令：<br><span class="hljs-keyword">Get</span>-ClientAccessService | <span class="hljs-keyword">select</span> <span class="hljs-type">Name</span>,AutoDiscoverServiceInternalUr<br></code></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9bbb84af2e6232ba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_1584955914303.png"></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs 1c">修改自动发现命令：<br>Get-ClientAccessService <span class="hljs-string">| Set-ClientAccessService -AutoDiscoverServiceInternalUri &quot;</span>[https:<span class="hljs-comment">//mail.iphonefintech.com/Autodiscover/Autodiscover.xml](https://mail.iphonefintech.com/Autodiscover/Autodiscover.xml)</span><br><br></code></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/9650472-763b487f6aed4fe1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849561101075.png"></p><ul><li>至此我们就修改完成了自动发现</li></ul><p><strong>ECP配置</strong></p><ul><li><p>参照截图，导航到服务器-虚拟目录-Ecp-修改<br><img src="https://upload-images.jianshu.io/upload_images/9650472-f2b9a0a1f2fabbfc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849582118425.png"></p></li><li><p>参照截图，修改ECP路径，内外网路径可以一样也可以不一样，如图所示<br><img src="https://upload-images.jianshu.io/upload_images/9650472-15cbfc1079bee82a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_1584958260703.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c9d59f9e544c20b4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849583734021.png"></p><ul><li>参照截图，导航到服务器-虚拟目录-Owa-修改</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-546ba7d918579b1a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_1584958406980.png"></p><ul><li>参照截图，修改Owa路径，内外网路径可以一样也可以不一样，如图所示<br><img src="https://upload-images.jianshu.io/upload_images/9650472-69d5ac02ffab1c4e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849584492008.png"></li></ul><p><strong>EWS配置</strong></p><ul><li><p>同样，导航到服务器-虚拟目录-EWS-修改<br><img src="https://upload-images.jianshu.io/upload_images/9650472-80957301d9385c24.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849585109067.png"></p></li><li><p>修改内外网访问路径<br><img src="https://upload-images.jianshu.io/upload_images/9650472-35b898ba0a5d2c33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_1584958550525.png"></p></li></ul><p><strong>MAPI配置</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-21ecc96b97a53a12.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15851097732013.png"></p><ul><li>修改内外网访问路径<br><img src="https://upload-images.jianshu.io/upload_images/9650472-af5e5715fa0b42a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849586437630.png"></li></ul><p><strong>ActiveSync修改配置</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-75df2986103d7af9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849587097603.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9abca3e343de999f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_1584958741188.png"></p><p><strong>OAB修改配置</strong></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-95a6ddbef631020c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849587919189.png"></p><ul><li>修改内外网访问URL<br><img src="https://upload-images.jianshu.io/upload_images/9650472-5d1f7e4d4a36b607.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15851102118147.png"></li></ul><p><strong>PowerShell修改配置</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-84b00042047dc705.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849588477614.png"></p><ul><li>修改内外网访问URL<br><img src="https://upload-images.jianshu.io/upload_images/9650472-db17949dc42dd763.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849588832832.png"></li></ul><p><strong>接收域配置</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-df88b87cb42c69e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15851107143742.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-f5c78c14809b8290.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_1585110756146.png"></p><p><strong>地址策略配置</strong></p><ul><li>打开ECP导航到邮件流-电子邮件地址策略-+</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-39cb94012668264a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-e943a277e12c2db5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-5f1896de748549ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-c737f26def1a61c6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-e5b4580771e70e02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-501d6fd6bfd6925c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-069b80b03ac4dd8f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="07.png"></p><p><strong>数据库创建</strong></p><ul><li>打开ECP，导航到服务器-数据库-“+”</li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-86af06ba138b4123.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-d61ad789ec7405b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><ul><li><p>输入数据库名称、路径、与Log路径，大家可能看到了我的数据库EDB文件路径与Log不在同一路径下，这个是最佳实践的建议。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-e07a8fa4688675f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p></li><li><p>重启相关服务器即可<br><img src="https://upload-images.jianshu.io/upload_images/9650472-2400698f5b58ca6c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-08b88576957ac9ad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p><ul><li><p>数据库创建完成。第一篇架构设计时候我们说了，大领导的邮箱配额是5G，我们直接修改数据库的配额即可。或者单个用户去修改<br><img src="https://upload-images.jianshu.io/upload_images/9650472-d40838ca3c341c27.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></p></li><li><p>参照截图修改数据库配额，这里修改完成后在该数据库里的所有用户邮箱配额都是5G<br><img src="https://upload-images.jianshu.io/upload_images/9650472-1ae903bd479b3750.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="07.png"></p></li></ul><p><strong>新建用户</strong><br><img src="https://upload-images.jianshu.io/upload_images/9650472-2acb82b3c3985069.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_1584976211327.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9e2db19ca9f40da1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="企业微信截图_15849762634252.png"></p><p><strong>发送连接器配置</strong></p><ul><li>如果要将邮件发送到 Internet，需要在邮箱服务器上创建发送连接器。<br>打开EAC管理控制台，转到“邮件流”，并切换到“发送连接器”。在“发送连接器”页上，单击“+”  ，新建发送连接器.<br><img src="https://upload-images.jianshu.io/upload_images/9650472-755bcf04454cf86f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-823e0cfa6a93a84c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><ul><li>通过DNS路由，解析收件人关联的MX记录；或添加邮件网关。<br><img src="https://upload-images.jianshu.io/upload_images/9650472-e62a6816d6a7b00e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-0bdfd0dbc864c3ac.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-db28b13802f8f2d4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="05.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-9fd6967bdad292ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="06.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-8e69e32ce7b03f88.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="07.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-1fbc00c5c499704e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="08.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-88d600d96c3b4444.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="09.png"></p><p><strong>接收连接器配置</strong></p><ul><li><p>接收连接器默认有5条策略，分属2种角色，</p></li><li><p>前端传输（FrontendTransport）：Client Frontend EX01、Default Frontend EX01、Outbound Proxy Frontend EX01；</p></li><li><p>集线器传输（HubTransport）：Client Proxy EX01、Default EX01；</p></li></ul><p><img src="https://upload-images.jianshu.io/upload_images/9650472-ce0d879bcaf04e85.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="01.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-aea680e21a395022.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="02.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-2249bb2e785b5296.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="03.png"></p><p><img src="https://upload-images.jianshu.io/upload_images/9650472-da785b5bbc8be8d9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="04.png"></p><p>其他基本也是一样的，这里就不做操作了。</p>]]></content>
    
    
    <categories>
      
      <category>Exchange2016</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Exchange2016</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Exchange Server 2016 部署系列（一）环境准备</title>
    <link href="/2022/08/31/Exchange2016/exchange2016_01/"/>
    <url>/2022/08/31/Exchange2016/exchange2016_01/</url>
    
    <content type="html"><![CDATA[<p><strong>近和同事一起在学习搭建Exchange server 2016，想着给自己做一下笔记，同时也方便其他想学习的小伙伴。</strong></p><h2 id="一、环境介绍"><a href="#一、环境介绍" class="headerlink" title="一、环境介绍"></a>一、环境介绍</h2><p>服务器角色情况<br><img src="/img/Exchange2016/exchange_01.jpg"><br><strong>搭建DNS和域控制器</strong><br>DNS 服务器对域来说是不可或缺的，一方面，域中的计算机使用 DNS 域名，DNS 需要为域中的计算机提供域名解析服务；另外一个重要的原因是域中的计算 机需要利用 DNS 提供的 SRV 记录来定位域控制器，因此我们在创建域之前需 要先做好 DNS 的准备工作，要么使用域控制器来做 DNS 服务器，要么使用一台单独的 DNS 服务器。这里使用一台独立的计算机来充当 DNS 服务器。<br><strong>1、添加“Active Directory 域服务”，“DNS服务器”角色，如下图所示：</strong><br><img src="/img/Exchange2016/exchange_02.jpg"><br><img src="/img/Exchange2016/exchange_03.jpg"><br><img src="/img/Exchange2016/exchange_04.jpg"><br><img src="/img/Exchange2016/exchange_05.jpg"><br><img src="/img/Exchange2016/exchange_06.jpg"><br><img src="/img/Exchange2016/exchange_07.jpg"><br><img src="/img/Exchange2016/exchange_08.jpg"><br><img src="/img/Exchange2016/exchange_09.jpg"><br><img src="/img/Exchange2016/exchange_10.jpg"><br>搭建完成以后，域控和dns角色也就添加成功，可以在开始菜单找到刚刚已经安装好的。<br><img src="/img/Exchange2016/exchange_11.jpg"><br><strong>2、创建区域并允许动态更新，如下图所示：</strong><br>首先我们要在 DNS 服务器上创建出一个区域，区域的名称和域名相同,域内计 算机的 DNS记录都创建在这个区域中。<br><img src="/img/Exchange2016/exchange_12.jpg"><br><img src="/img/Exchange2016/exchange_13.jpg"><br><img src="/img/Exchange2016/exchange_14.jpg"><br><img src="/img/Exchange2016/exchange_15.jpg"><br><img src="/img/Exchange2016/exchange_16.jpg"><br><img src="/img/Exchange2016/exchange_17.jpg"><br><img src="/img/Exchange2016/exchange_18.jpg"><br><strong>3、检查NS和SOA记录，如下图所示：</strong><br>区域创建完成后，一定要检查一下区域的 NS 记录和 SOA 记录。NS 记录描述了有多少个 DNS 服务器可以解析这个区域，SOA 记录描述了哪个 DNS 服务器是区域 的主服务器。如果 NS 记录和 SOA 记录出错，域的创建过程中就无法向 DNS 区域中写入应有的记录。<br><img src="/img/Exchange2016/exchange_19.jpg"><br><img src="/img/Exchange2016/exchange_20.jpg"><br><img src="/img/Exchange2016/exchange_21.jpg"><br><img src="/img/Exchange2016/exchange_22.jpg"><br><img src="/img/Exchange2016/exchange_23.jpg"><br><img src="/img/Exchange2016/exchange_24.jpg"><br><img src="/img/Exchange2016/exchange_25.jpg"><br><img src="/img/Exchange2016/exchange_26.jpg"><br><strong>4、添加新域（提升域控制器），如下图所示：</strong><br><img src="/img/Exchange2016/exchange_27.jpg"><br>我们选择“添加新林”，这个选项是什么意思呢？我们虽然只是简单地创建了一个域，但其实从逻辑上讲是创建了一个域林。因为域一定要隶属于域树，域树一定要隶属于域林。 L<br><img src="/img/Exchange2016/exchange_28.jpg"><br><img src="/img/Exchange2016/exchange_29.jpg"><br><img src="/img/Exchange2016/exchange_30.jpg"><br><img src="/img/Exchange2016/exchange_31.jpg"><br><img src="/img/Exchange2016/exchange_32.jpg"><br><img src="/img/Exchange2016/exchange_33.jpg"><br><img src="/img/Exchange2016/exchange_34.jpg"><br><img src="/img/Exchange2016/exchange_35.jpg"><br><img src="/img/Exchange2016/exchange_36.jpg"><br>安装完重启电脑，发现已经可以用域管理员身份登陆了，Test域控搭建成功。</p>]]></content>
    
    
    <categories>
      
      <category>Exchange2016</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Exchange2016</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Exchange Server 2016 部署系列（二）环境准备</title>
    <link href="/2022/08/31/Exchange2016/exchange2016_02/"/>
    <url>/2022/08/31/Exchange2016/exchange2016_02/</url>
    
    <content type="html"><![CDATA[<p>上一章Exchange Server 2016 部署系列（一)环境准备部署篇我们对部署AD已经有了基本的认识，接下来我们进入对Exchange Server 2016的先决条件做准备工作。</p><h2 id="先决条件准备"><a href="#先决条件准备" class="headerlink" title="先决条件准备"></a>先决条件准备</h2><p>Exchange Server 2016先决条件准备：<a href="https://docs.microsoft.com/zh-cn/Exchange/plan-and-deploy/prepare-ad-and-domains?redirectedfrom=MSDN&amp;view=exchserver-2019">https://docs.microsoft.com/zh-cn/Exchange/plan-and-deploy/prepare-ad-and-domains?redirectedfrom=MSDN&amp;view=exchserver-2019</a><br>我们接下来开始先准备:</p><p><strong>1.扩展ActiveDirectory架构</strong><br><strong>2.准备ActiveDirectory组织</strong><br><strong>3.准备ActiveDirectory域</strong></p><p><img src="/img/Exchange2016/exchange_37.jpg"><br><img src="/img/Exchange2016/exchange_38.jpg"><br><strong>1.扩展ActiveDirectory架构</strong><br>将Exchange Server 2016 安装介质解压或挂载到Exchange服务器上，并使用管理员身份打开powershell，并切换到Exchange安装目录下。<br><img src="/img/Exchange2016/exchange_39.jpg"><br><img src="/img/Exchange2016/exchange_40.jpg"><br>1.1接下来进行命令进行扩展AD架构<br><img src="/img/Exchange2016/exchange_41.jpg"><br><img src="/img/Exchange2016/exchange_42.jpg"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">.\Setup.exe <span class="hljs-regexp">/IAcceptExchangeServerLicenseTerms /</span>PrepareSchema<br></code></pre></td></tr></table></figure><p><strong>2.接下来进行命令进行准备ActiveDirectory组织</strong><br>这里以iphonefintech.com为例子<br><img src="/img/Exchange2016/exchange_43.jpg"></p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">.\Setup.exe <span class="hljs-string">/IAcceptExchangeServerLicenseTerms</span> <span class="hljs-string">/PrepareAD</span> <span class="hljs-string">/OrganizationName</span>:<span class="hljs-string">&quot;Contoso Corporation&quot;</span><br>.\Setup.exe <span class="hljs-string">/IAcceptExchangeServerLicenseTerms</span> <span class="hljs-string">/PrepareAD</span> <span class="hljs-string">/OrganizationName</span>:<span class="hljs-string">&quot;iphonefintech&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/Exchange2016/exchange_44.jpg"><br><strong>3.准备ActiveDirectory域</strong><br><img src="/img/Exchange2016/exchange_45.jpg"></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">.\Setup.exe <span class="hljs-regexp">/IAcceptExchangeServerLicenseTerms /</span>PrepareDomain:<span class="hljs-string">&quot;Contoso Corporation&quot;</span><br>.\Setup.exe <span class="hljs-regexp">/IAcceptExchangeServerLicenseTerms /</span>PrepareDomain:<span class="hljs-string">&quot;iphonefintech.com&quot;</span><br></code></pre></td></tr></table></figure><p><img src="/img/Exchange2016/exchange_46.jpg"><br>检查是否安装好了，打开ADSI编辑，然后单击“连接到…”,在“连接设置”中，选择“选择已知的命名上下文”，然后选择“配置”。<br><img src="/img/Exchange2016/exchange_47.jpg"><br><img src="/img/Exchange2016/exchange_48.jpg"><br>连接到“架构”命名上下文中<br>验证 ms-Exch-Schema-Verision-Pt 上的 rangeUpper 属性设置为 Exchange 2016 Active Directory 版本表中为您的 Exchange 2016 版本显示的值。<br><img src="/img/Exchange2016/exchange_49.jpg"><br>连接到“配置”命名上下文中 ，验证 CN&#x3D;iphonefintech,CN&#x3D;Microsoft Exchange,CN&#x3D;Services,CN&#x3D;Configuration,DC&#x3D;iphonefintech 容器中的 objectVersion 属性是否设置为 Exchange 2016 Active Directory 版本表中为您的 Exchange 2016 版本显示的值。<br><img src="/img/Exchange2016/exchange_50.jpg"><br>连接到“配置”命名上下文中 ，验证 DC&#x3D;Iphonefintech “Microsoft Exchange 系统对象”容器中的 objectVersion 属性是否设置为 Exchange 2016 Active Directory 版本表中 Exchange 2016 版本所显示的值<br><img src="/img/Exchange2016/exchange_51.jpg"><br>到这一步基本AD上的操作基本就搭建就完成了，接下来要到成员服务器的邮件服务器了。</p>]]></content>
    
    
    <categories>
      
      <category>Exchange2016</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Exchange2016</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Exchange Server 2016 部署系列（三）环境准备</title>
    <link href="/2022/08/31/Exchange2016/exchange2016_03/"/>
    <url>/2022/08/31/Exchange2016/exchange2016_03/</url>
    
    <content type="html"><![CDATA[<p>上一章Exchange Server 2016 部署系列（二)环境准备部署篇我们对部署AD已经准备完成了，接下来我们进入对Exchange Server 2016的搭建。<br><strong>ExSrv01（第一台邮件服务器）:入域到AD上，这一步我就不再操作了直接开始安装组件，远程管理包，exchange 2016。</strong></p><p><img src="/img/Exchange2016/exchange_52.jpg"><br><img src="/img/Exchange2016/exchange_52_01.jpg"><br>首先我们先安装组件这些组件都可以在微软官网上下，或者百度一下都是有很多的，这里就不提供了。<br><strong>1..NET Framework 4.8</strong><br><img src="/img/Exchange2016/exchange_53.jpg"><br><img src="/img/Exchange2016/exchange_54.jpg"><br><img src="/img/Exchange2016/exchange_55.jpg"></p><p><strong>2.Visual C++ Redistributable package</strong><br><img src="/img/Exchange2016/exchange_56.jpg"><br><img src="/img/Exchange2016/exchange_57.jpg"></p><p><strong>3.UcmaRuntimeSetup</strong><br><img src="/img/Exchange2016/exchange_58.jpg"><br><img src="/img/Exchange2016/exchange_59.jpg"><br><img src="/img/Exchange2016/exchange_60.jpg"></p><p><strong>4.安装远程管理包-安装ADDS工具</strong><br><img src="/img/Exchange2016/exchange_61.jpg"></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-keyword">Install</span>-WindowsFeature RSAT-ADDS<br></code></pre></td></tr></table></figure><p>使用命令为邮箱和客户端访问服务器角色安装功能。<br><img src="/img/Exchange2016/exchange_62.jpg"></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">Install-WindowsFeature <span class="hljs-built_in">Server</span>-Media-Foundation, NET-Framework<span class="hljs-number">-45</span>-Features, RPC-over-HTTP-proxy, RSAT-Clustering, RSAT-Clustering-CmdInterface, RSAT-Clustering-Mgmt, RSAT-Clustering-PowerShell, Web-Mgmt-<span class="hljs-built_in">Console</span>, WAS-<span class="hljs-built_in">Process</span>-Model, Web-Asp-Net45, Web-Basic-Auth, Web-<span class="hljs-built_in">Client</span>-Auth, Web-Digest-Auth, Web-Dir-Browsing, Web-Dyn-Compression, Web-Http-Errors, Web-Http-Logging, Web-Http-Redirect, Web-Http-Tracing, Web-ISAPI-Ext, Web-ISAPI-Filter, Web-Lgcy-Mgmt-<span class="hljs-built_in">Console</span>, Web-Metabase, Web-Mgmt-<span class="hljs-built_in">Console</span>, Web-Mgmt-Service, Web-Net-Ext45, Web-Request-Monitor, Web-<span class="hljs-built_in">Server</span>, Web-Stat-Compression, Web-Static-Content, Web-Windows-Auth, Web-WMI, Windows-Identity-Foundation, RSAT-ADDS<br></code></pre></td></tr></table></figure><p>查询AD DS工具安装情况。<br><img src="/img/Exchange2016/exchange_63.jpg"></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">Get-WindowsFeature <span class="hljs-strong">*ADDS*</span><br></code></pre></td></tr></table></figure><p><strong>5.Exchange 2016安装部署</strong><br>右键单击下载的 Exchange ISO 图像文件，然后选择“装载”****。在显示的生成的虚拟 DVD 驱动器中，双击 Setup.exe 启动 Exchange 安装程序。</p><p><img src="/img/Exchange2016/exchange_64.jpg"><br><img src="/img/Exchange2016/exchange_65.jpg"><br>5.1 此时，Exchange Server 安装向导打开。在“检查是否有更新?”**** 页上，选择下列选项之一，再单击“下一步”**** 即可继续操作：<br>连接到 Internet 并检查是否有更新：建议选中此选项，以便搜索当前正在安装的 Exchange 版本的更新（不会检测新版累积更新）。选中此选项后会转到“正在下载更新”**** 页，以便搜索更新。单击“下一步”**** 即可继续操作。<br>暂不检查是否有更新<br><img src="/img/Exchange2016/exchange_66.jpg"><br>5.2 正在复制文件”**** 页会显示将文件复制到本地硬盘的进度。通常情况下，文件会复制到 %WinDir%\Temp\ExchangeSetup，但可以在 C:\ExchangeSetupLogs\ExchangeSetup.log 处的 Exchange 安装日志中确认位置<br><img src="/img/Exchange2016/exchange_67.jpg"><br>5.3建议在“简介”**** 页上先访问 Exchange Server 部署计划链接（如果尚未查看的话）。单击“下一步”**** 即可继续操作。<br><img src="/img/Exchange2016/exchange_68.jpg"><br>5.4在“许可协议”**** 页上，查看软件许可条款，选中“我接受许可协议中的条款”<strong><strong>，然后单击“下一步”</strong></strong> 继续操作。<br><img src="/img/Exchange2016/exchange_69.jpg"><br>5.5使用推荐设置：Exchange 会自动将错误报告和有关计算机硬件以及如何使用 Exchange 的信息发送给 Microsoft。有关发送给 Microsoft 的信息及其使用方式，请单击页面上的“?”**** 或帮助链接。<br>不使用推荐设置：将禁用推荐设置，但可以在安装程序完成后随时启用这些设置。<br>单击“下一步”**** 即可继续操作。<br><img src="/img/Exchange2016/exchange_70.jpg"><br>5.6<br>1.邮箱角色：选中此选项还会自动安装管理工具.<br>2.自动安装 Exchange 安装所需的 Windows Server 角色和功能：选中此选项可以让安装向导安装所需的 Windows 必备组件。可能需要重启计算机，才能完成一些 Windows 功能的安装。如果不选中此选项，需要手动安装 Windows 功能<br><img src="/img/Exchange2016/exchange_71.jpg"><br>5.7在“安装空间和位置”**** 页上，接受默认安装位置 (C:\Program Files\Microsoft\Exchange Server\V15)，或单击“浏览”**** 选择新位置。请确保所需的 Exchange 安装位置有足够的磁盘空间。单击“下一步”**** 继续操作。<br><img src="/img/Exchange2016/exchange_72.jpg"><br>5.8在“恶意软件防护设置”**** 页上，选择是否要禁用恶意软件扫描。恶意软件扫描默认启用（已选中值“否”<strong><strong>）。如果禁用了恶意软件扫描，稍后可以随时启用。单击“下一步”</strong></strong> 继续操作。<br><img src="/img/Exchange2016/exchange_73.jpg"><br>5.9在“准备情况检查”**** 页上，确认已成功完成组织和服务器角色先决条件检查。如果没有执行此操作，页面上只会显示“重试”**** 选项。必须先修复这些错误，然后才能继续操作,安装完成重启。<br><img src="/img/Exchange2016/exchange_74.jpg"><br><img src="/img/Exchange2016/exchange_75.jpg"><br><img src="/img/Exchange2016/exchange_76.jpg"></p><p><strong>6.0开始菜单此时已经有了Exchange，点击打开是否正常。</strong><br><img src="/img/Exchange2016/exchange_77.jpg"><br><img src="/img/Exchange2016/exchange_78.jpg"><br>至此，第一台Exchange服务器已经安装完毕，用同样的方法来安装第二台邮件服务器，安装过程与上述完全相同，这里不再做演示</p>]]></content>
    
    
    <categories>
      
      <category>Exchange2016</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Exchange2016</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
